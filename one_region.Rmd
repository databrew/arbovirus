---
title: "Arboviral Surveillance and Response Capacity Survey 2021"
output:
  html_document:
    toc: no
    toc_float: no
    toc_depth: 2
  word_document:
    toc: no
    toc_depth: '2'
params:
  region: EMRO
---

```{r setup, include=FALSE, echo = FALSE}
# Basic knitr options
library(knitr)
opts_chunk$set(comment = NA, 
               echo = FALSE,
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE )
               # fig.width = 9.64,
               # fig.height = 5.9)
               # fig.path = 'figures/')
# options(scipen = '999')
```

```{r}

library(tidyverse)
library(stringr)
library(pander)
panderOptions( 'p.wrap', "")
library(knitr)
library(flextable)
library(ggpubr)
library(lubridate)
library(english)

if( file.exists("data/data.RData")){
  load("data/data.RData")
  # load("data/combined_data.RData")
} else{
  message("You need the data!")
}

data <- data %>% 
  filter( Region == params$region ) %>%
  droplevels() %>%
  mutate(SI01 = as.character(SI01)) %>%
  arrange( SI01 )

n_countries <- length( data$SI01) 
n_unique_countries <- length( unique( data$SI01 ))

if(file.exists("data/Regions_Countries.csv")) {
  region_countries <- read_csv("data/Regions_Countries.csv")
} else{
  message("You need the regions/countries data!")
}

region_expansion <- list(
  WPRO = "Western Pacific Region",
  EURO = "European Region",
  SEARO = "South-East Asia Region",
  EMRO = "Eastern Mediterranean Region",
  PAHO = "Pan American Health Organization"
)

region_countries <- region_countries %>%
  filter(Region == params$region)
n_region_countries <- length( region_countries$Country)

# rename duplicated countries to prevent barfing:
idx <- which( duplicated( data$SI01 ))
if( length(idx) > 0 ){
  for(i in 1:length(idx)){
    country <- data$SI01[ idx[i] ]
    dup_idx <- which( data$SI01 == country )
    data$SI01[ dup_idx ] <- paste0( country, 1:length(dup_idx)) 
  }
}

if( file.exists("data/Data_dictionary_Survey375147.csv")){
  dict <- read_csv("data/Data_dictionary_Survey375147.csv")
} else{
  message("You need the data dictionary!")
}

# exclude countries with no responses after question 4 :
q5_start <- min( which( dict$`Question number` == "5") )
incomplete_surveys <- c()
for( i in 1:nrow(data)){
  if( all( is.na( data[i, q5_start:nrow( dict )]))){
    incomplete_surveys <- c( incomplete_surveys, i)
  }
}

# utility function 
get_responses <- function( question_number ){
  idx <- which( dict$`Question number` == question_number )
  var_names <- dict$`Variable name`[idx]
  responses <- data %>% select( all_of(var_names) )
  if( !is.na(dict$Subquestion[ idx[1] ]) ){
    # remove square brackets at beginning and end, then rename columns:
    colnames( responses ) <- str_extract( dict$Subquestion[idx], '(?<=\\[)[^{}]+(?=\\])')
  } else{
    colnames( responses ) <- "Response"
  }
  return( responses )
}

table_num <- 1

```

```{css, echo=FALSE}
body {
  font-family: sans-serif;
  font-size: 11pt;
}

h1 {
  text-align: left;
  font-family: sans-serif;
  font-size: 14pt;
  font-weight: bold;
}

h4 {
  text-align: left;
  font-family: sans-serif;
  font-size: 12pt;
  font-style: italic;
}
```

# `r region_expansion[ params$region ]` Summary

## Section I: Respondent details

```{r}
map_path <- paste0("img/", params$region, ".png")
knitr::include_graphics( map_path )
```

`r str_to_title(as.english(n_unique_countries))` (`r round(100*( n_unique_countries / n_region_countries))`%) of `r n_region_countries` countries responded, namely `r pander( as.character(data$SI01) )`. 

```{r}
incompletes <- FALSE
if( length( incomplete_surveys) > 0){
  incompletes <- TRUE
  excluded_countries <- paste( data$SI01[ incomplete_surveys ], "only provided initial demographic information; their responses are henceforth excluded.")
  data <- data[-incomplete_surveys,]
} 
```

```{r eval=incompletes, results="asis"}
pander(excluded_countries)
```

Names and contact details of persons completing the survey on behalf of the countries are shown in Appendix I.

Non-responding countries are of concern in terms of arbovirus emergence and endemic transmission.

## Section II: Arboviral disease surveillance system

#### Documented arbovirus circulation

All responding countries reported transmission of at least one of chikungunya (CHIKV), dengue (DENV), 
and Zika (ZIKV) viruses (Table `r table_num`).

```{r}

caption <- paste0("Table ", table_num, ". Arboviruses that have circulated autochthonously in the country at any time since 2000 (ref Q5)")

responses <- get_responses("5") 
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

responses <- cbind(Country = data$SI01, responses) %>% 
  pivot_longer(!Country, names_to="Arbovirus", values_to="Response") %>% 
  mutate( Arbovirus = recode_factor(.x = Arbovirus,
                                    "Chikungunya"="CHIKV",
                                    "Dengue"="DENV",
                                    "Yellow fever"="YFV",
                                    "Zika"="ZIKV")) %>% 
  mutate( Response = na_if(Response, "Not selected")) %>%
  mutate( Response = recode_factor(.x = Response, 
                                   "Yes"="X")) %>%
  pivot_wider( names_from=Arbovirus, values_from=Response) %>%
  mutate( Other = other$Other ) %>%
  filter( if_any(CHIKV:Other, ~ !is.na(.x)))

responses %>%
  regulartable() %>% 
  # hline( i = 1:length(data$SI01)) %>%
  align( j = 2:5, align="center") %>% autofit() %>%
  set_caption( caption )

table_num <- table_num + 1
```


#### Written arbovirus surveillance plans

```{r}

caption <- paste0("Table ", table_num, ". Surveillance plans and the viruses covered (ref Q6, 6b)")
responses <- get_responses("6")

q6 <- cbind(Country = data$SI01, responses) %>% 
  pivot_longer(!Country, names_to="Arbovirus", values_to="Response") %>% 
  pivot_wider( names_from=Arbovirus, values_from=Response) %>%
  mutate( Response = recode_factor(.x = Response,
                                   "Yes, we have arbovirus-specific plans(s) or guidelines(s)"="Arbovirus-specific",
                                   "Yes. We do not have arbovirus-specific guidelines, but arboviruses are included within general surveillance guidelines."="Within general surveillance guidelines",
                                   "No"="None",
                                   "I don't know"="Don't know")) %>%
  rename( "Nature of surveillance plans"=Response)

other <- get_responses("6b") %>%
  select(Other)
other <- cbind(Country = data$SI01, other) %>% 
  drop_na(Other) %>%
  rename("Other arbovirus(es) covered" = Other) 

q6b <- get_responses("6b")%>%
  select(-Other)
q6b <- cbind(Country = data$SI01, q6b) %>% 
  pivot_longer(!Country, names_to="Arbovirus", values_to="Response") %>% 
  mutate( Arbovirus = recode_factor(.x = Arbovirus,
                                    "Chikungunya"="CHIKV",
                                    "Dengue"="DENV",
                                    "Yellow fever"="YFV",
                                    "Zika"="ZIKV")) %>% 
  mutate( Response = na_if( Response, "Not selected")) %>% 
  mutate( Response = recode_factor(.x = Response, 
                                   "Yes"="X")) %>% 
  pivot_wider( names_from=Arbovirus, values_from=Response) 

left_join( q6, q6b, by="Country") %>%
  left_join( other) %>%
  regulartable() %>% 
  add_header( CHIKV = "Aedes-borne viruses covered in plans",
              DENV = "Aedes-borne viruses covered in plans",
              YFV = "Aedes-borne viruses covered in plans",
              ZIKV = "Aedes-borne viruses covered in plans" ) %>%
  merge_h( part = "header" ) %>%
  set_caption( caption ) %>% autofit()

table_num <- table_num + 1

```

#### National programme for arboviral diseases surveillance

```{r}
responses <- get_responses("7")

responses <- cbind(Country = data$SI01, responses) 
specific_programme <- paste( responses$Country[ which( responses$Response == "Specific programme" )], collapse=", ")
another_programme <- paste( responses$Country[ which( responses$Response == "Integrated in another programme" )], collapse=", ")
no_programme <- paste( responses$Country[ which( responses$Response == "No programme" )], collapse=", ")

```

`r specific_programme` reported having a specific arbovirus programme, whereas `r another_programme` 
had arboviral disease surveillance integrated into another programme. No programme 
reported by `r no_programme`.

#### Training provided to arboviral surveillance staff

```{r}

caption <- paste0("Table ", table_num, ". Training provided to arboviral surveillance staff (ref Q10)" )
responses <- get_responses("10") %>%
  select(-Other)
# training <- colnames( responses )
colnames(responses) <- c("Basic","Repeat_basic","Advanced","Repeat_advanced","None")
df <- cbind(Country = data$SI01, responses) %>%
  mutate(
    Basic = if_else(Basic == "Yes", "X", " "),
    Repeat_basic = if_else(Repeat_basic == "Yes", "X", " "),
    Advanced = if_else(Advanced == "Yes", "X", " "),
    Repeat_advanced = if_else(Repeat_advanced == "Yes", "X", " "),
    None = if_else(None == "Yes", "X", " ")
  ) %>%
  rename(
    "One-time basic training" = Basic,
    "Repeated/continuing basic training" = Repeat_basic,
    "One-time advanced training" = Advanced,
    "Repeated/continuing advanced training" = Repeat_advanced
  )
# colnames(df) <- c("Country", training)

regulartable(df) %>%
  align(j = 2:6, align = "center") %>% 
  set_caption( caption ) %>% autofit()

table_num = table_num + 1
```

* _Basic training_:  data capture and analysis (MS Excel, MS Access, EpiInfo) and/or geographic information systems (GIS)
* _Advanced training_: statistical software for data analysis (e.g.  STATA, R, SAS, Tableau, etc)) and GIS

#### Mandatory reporting status of arboviral diseases

```{r}
responses <- get_responses("11") 
cbind(Country = data$SI01, responses) %>% 
  drop_na(Response) %>%
  regulartable() %>% autofit()
```


```{r}

caption <- paste0("Table ", table_num, ". Reportable diseases by case classification status (ref Q11b, 11c)")
q11b <- get_responses("11b")
q11b <- cbind(Country = data$SI01, q11b) %>%
  select(-"Other ") %>% 
  pivot_longer(!Country, names_to = "Arbovirus", values_to = "Response")
q11b$Response <- str_to_sentence(gsub("Mandatory reporting of ", "", q11b$Response))
q11b <- q11b %>%
  mutate( Arbovirus = recode_factor(.x = Arbovirus,
                                    "Chikungunya" = "CHIKV",
                                    "Dengue" = "DENV",
                                    "Yellow fever" = "YFV",
                                    "Zika (congenital)" = "ZIKV (C)",
                                    "Zika (non-congenital)" = "ZIKV (NC)")) %>%
  mutate( Response = recode_factor( .x = Response,
                                    "All suspect cases" = "S",
                                    "Confirmed cases only" = "C",
                                    "Not reportable" = "N")) %>%
  pivot_wider(names_from = Arbovirus, values_from = Response) 

q11c <- get_responses("11c")
idx <- which( grepl("Arbovirus",colnames(q11c)))
arboviruses <- cbind( Country=data$SI01, q11c[,idx]) %>%
  pivot_longer(!Country) %>%
  select( Country, Arbovirus=value)
reporting <- cbind( Country=data$SI01, q11c[,-idx]) %>%
  pivot_longer(!Country) %>%
  select( Country, Reporting=value)
idx <- grep("suspect", str_to_lower(reporting$Reporting))
reporting$Reporting[idx] <- " (S)"
idx <- grep("confirm", str_to_lower(reporting$Reporting))
reporting$Reporting[idx] <- " (C)"
idx <- grep("not", str_to_lower(reporting$Reporting))
reporting$Reporting[idx] <- " (N)"
reporting$Reporting[ is.na( reporting$Reporting) ] <- ""
q11c <- cbind(arboviruses, Reporting = reporting$Reporting) %>%
  unite( "Other", Arbovirus:Reporting, sep = "")
idx <- which( q11c$Other == "NA" )
q11c <- q11c[-idx,]
q11c <- q11c %>% 
  group_by( Country ) %>% 
  summarize( Other = paste(Other, collapse=", "))

left_join( q11b, q11c) %>%
  regulartable() %>%
  merge_v(j = ~Country ) %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1

```

* S=All suspect cases, C=Confirmed cases only, N=Not reportable

#### Surveillance for human cases of arboviral disease

```{r}

caption <- paste0("Table ", table_num, ". Performance of national epidemiological surveillance for arboviral diseases in humans (ref Q12, 12b, 12c)")
responses_12 <- get_responses("12") 
responses_12b <- get_responses("12b")
colnames( responses_12b ) <- c("Response", "Other")
responses_12b <- responses_12b %>%
  mutate( Response = factor( replace_na( as.character(Response), ""))) %>%
  mutate( Other = factor( replace_na( as.character(Other), ""))) %>%
  unite( Frequency, Response:Other, sep="") 

responses_12c <- get_responses("12c")
colnames(responses_12c) <- "Type"

cbind(Country = data$SI01, responses_12, responses_12b, responses_12c) %>% 
  rename( "Surveillance conducted" = Response ) %>% 
  regulartable() %>% 
  set_caption( caption ) %>% autofit()

table_num <- table_num + 1
```

#### Training sessions for healthcare workers on notification of _Aedes_-borne arboviral diseases

```{r}
caption <- paste0("Table ", table_num, ". Training of healthcare workers on reporting Aedes-borne arboviral diseases (ref Q13)")
responses <- get_responses("13") 
colnames(responses) <- c("Response","Description")
responses <- responses %>%
  mutate(Response = recode_factor(.x=Response,
                                  "Yes. If so, please describe in the comments field:"="Yes",
                                  "No"="No",
                                  "I don't know" ="I don't know")) 
cbind(Country = data$SI01, responses) %>% 
  filter( Response == "Yes") %>% 
  select(-Response) %>%
  replace_na( list(Description = "Conducted (no further description provided)")) %>% 
  rename( "Description of training" = Description) %>%
  regulartable() %>% 
  set_caption( caption ) %>% autofit()

table_num <- table_num + 1
```

#### Arboviral disease surveillance staff perceptions 

```{r}
caption <- paste0("Table ", table_num, ". Surveillance staff perceptions of factors contributing to success or barriers/challenges in human arboviral disease surveillance (ref Q14)")
responses <- get_responses("14") 
cbind(Country = data$SI01, responses) %>% 
  regulartable() %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

# Section III: Arbovirus laboratory capacity

#### Cases for which arbovirus laboratory testing is performed

```{r}
caption <- paste0("Table ", table_num, ". Cases for which laboratory testing is performed by transmission period (ref Q15)")
responses <- get_responses("15")
periods <- colnames(responses)
colnames(responses)=c("Outbreak","Non")
responses <- cbind(Country = data$SI01, responses) %>% 
  mutate( Outbreak = recode_factor(Outbreak,
                                   "All suspect cases tested"="A",
                                   "Subset of suspect cases tested"="S",
                                   "No suspect cases tested"="N")) %>%
  mutate( Non = recode_factor(Non,
                                   "All suspect cases tested"="A",
                                   "Subset of suspect cases tested"="S",
                                   "No suspect cases tested"="N")) 
  
colnames(responses) <- c("Country",periods)
responses %>%
  regulartable() %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1

```

* A=all suspect cases; S=subset of suspect cases; N=none

#### Viruses for which the national laboratory confirmed cases

```{r}
caption <- paste0("Table ", table_num, ". Virus diagnostic confirmatory testing performed by the national laboratory (ref Q16)")
responses <- get_responses("16")
colnames(responses) <- c("Response","Arbovirus(es)")
responses <- responses %>%
  mutate(Response = recode_factor(Response,
                                  "Yes, for all arboviral infections. Please specify them:"="Yes",
                                  "Yes, but only for some arboviral infections. Please specify them:"="Yes",
                                  "No"="No"))
cbind(Country = data$SI01, responses) %>% 
  filter( Response == "Yes") %>%
  select(-Response) %>%
  replace_na( list("Arbovirus(es)"="Not specified")) %>%
  regulartable() %>% 
  set_caption( caption ) %>% autofit()

table_num <- table_num + 1

```

#### Arboviral testing capacity by country

```{r fig.width=5, fig.height=3, eval=TRUE}
caption <- paste0("Table ", table_num, ". Testing capacity by virus and assay type")
responses <- get_responses("17")
responses <- cbind(Country = data$SI01, responses) %>%
  pivot_longer(!Country)
new_cols <- matrix(unlist(strsplit(responses$name, "\\]\\[")), ncol = 2, byrow = T)
responses <- responses %>%
  mutate(Level = new_cols[, 1], Test = new_cols[, 2]) %>%
  select(-name) %>%
  filter( Level != "Other") %>% 
  mutate( value = as.character(value)) %>%
  replace_na(list(value = 0)) %>%
  mutate( Country = as.factor(Country)) %>% 
  mutate( Level = as.factor(Level)) %>% 
  mutate( Test = as.factor(Test)) %>% 
  mutate( value = as.numeric( value )) 

# need_legend = TRUE
base_path <- paste0("./images/q17/", params$region, "/")
for(country in levels(responses$Country)) {
  df <- responses %>% filter(Country == country)
  for (virus in levels(df$Level)) {
    fn <- paste0(base_path, country, "_", virus, ".png")
    # the following code saves the legend only; should only need to be run once,
    # but leaving it here in case it's needed again...
    # if( need_legend ){
    #   g <- ggplot(df %>% filter(Level == virus),
    #             aes(x = Test, y = value, fill = Test)) +
    #   geom_col() +
    #   coord_equal() +
    #   labs(x = "", y = "") +
    #   scale_fill_discrete(name="Testing methods") +
    #   theme(
    #     axis.text = element_blank(),
    #     axis.ticks = element_blank(),
    #     panel.background = element_rect(fill="transparent"),
    #     plot.background = element_rect(fill="transparent", color = NA),
    #     panel.grid.major = element_blank(),
    #     panel.grid.minor = element_blank(),
    #     legend.position = "bottom"
    #   )
    #   the_legend <- get_legend( g )
    #   ggsave("./images/q17/legend.png", the_legend)
    #   need_legend <- FALSE
    # }
    if (!file.exists(fn)) {
      g <- ggplot(df %>% filter(Level == virus),
                  aes(x = Test, y = value, fill = Test)) +
        geom_col() +
        coord_equal() +
        labs(x = "", y = "") +
        theme(
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          panel.background = element_rect(fill = "transparent"),
          plot.background = element_rect(fill = "transparent", color = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.position = "none"
        )
      ggsave(fn, plot = g)
    }
  }
}

# find all PNGs for each virus and append base_path to get their full file paths;
# flextable's colformat_image expects a path to an image file
chik <- paste0(base_path, dir(base_path)[ grep("Chikungunya", dir(base_path))])
dengue <- paste0(base_path, dir(base_path)[ grep("Dengue", dir(base_path))])
yellow <- paste0(base_path, dir(base_path)[ grep("Yellow fever", dir(base_path))])
zika <- paste0(base_path, dir(base_path)[ grep("Zika", dir(base_path))])
# other <- paste0(base_path, dir(base_path)[ grep("Other", dir(base_path))])

df <- tibble( Country = levels( responses$Country),
                  Chikungunya = chik,
                  Dengue = dengue,
                  "Yellow fever" = yellow,
                  Zika = zika )
                  # Other = other )

flextable( df ) %>% 
  colformat_image(j="Chikungunya", width=1.25, height=.75) %>% 
  colformat_image(j="Dengue", width=1.25, height=0.75) %>% 
  colformat_image(j="Yellow fever", width=1.25, height=0.75) %>% 
  colformat_image(j="Zika", width=1.25, height=0.75) %>% 
  # colformat_image(j="Other", width=1, height=0.5) %>% 
  vline( part="body")  %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1

knitr::include_graphics("./images/q17/legend.png")
# as_ggplot( the_legend )

#   mutate( value = case_when( value == 1 ~ "X", value == 0 ~ " ", is.na(value) ~ " ")) %>%
# 	pivot_wider(names_from=Level, values_from=value) %>%
#   regulartable() %>%
#   merge_v(j = ~Country) %>%
#   theme_zebra() %>%
#   # hline( part="all") %>% 
#   autofit()

```

#### Additional resources most needed for your country to perform adequate testing for arboviral diseases

```{r}
caption <- paste0("Table ", table_num, ". Additional resources required for adequate arboviral disease testing (ref Q18)")
responses <- get_responses("18")
colnames(responses) <- c(
  "Personnel needed",
  "Additional personnel needed",
  "Training needed",
  "Additional training needed",
  "Laboratory equipment needed",
  "Additional laboratory equipment needed",
  "Capacity needs",
  "Other capacity needs"
)
cbind(Country = data$SI01, responses) %>%
  select(
    Country,
    "Additional personnel needed",
    "Additional training needed",
    "Additional laboratory equipment needed",
    "Other capacity needs"
  ) %>%
  regulartable() %>%
  set_caption(caption) %>% autofit()

table_num <- table_num + 1

```

#### Virological surveillance on humans, i.e., tracking of prevailing genotypes/serotypes

```{r}
caption <- paste0("Table ", table_num, ". Capacity for virological surveillance on human specimens (ref Q19)")
responses <- get_responses("19")
idx <- grep("Comment", colnames(responses))
responses <- responses[,-idx]
responses <- responses %>%
  mutate_at( .vars=vars(colnames(responses)),
             .funs = forcats::fct_recode,
             "X"="Yes",
             " "="Not selected") 

colnames(responses) <- c("Virus isolation",
                         "RT-PCR",
                         "Other nucleic acid tests",
                         "Serological testing",
                         "None",
                         "I don't know") 
empty_cols = c()
for(i in 1:ncol(responses)){
  responses[,i] <- as.character( responses[,i] )
  responses[ which( is.na( responses[,i])) ,i] <- " "
  if( all(responses[,i] != "X" )){
    empty_cols = c(empty_cols, colnames(responses)[i])
  }
}

cbind(Country=data$SI01, responses) %>%
  select( -empty_cols ) %>%
  regulartable() %>%
  set_caption( caption ) %>% autofit()

table_num <- table_num + 1
```

#### Laboratory staff perceptions

```{r}
caption <- paste0("Table ", table_num, ". Laboratory staff perception of factors contributing to the a) success and b) barriers/challenges with respect to laboratory testing for arboviral infections (ref Q20)")
responses <- get_responses("20")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

# Section IV: Management of arboviral disease cases

#### Countries with clinical guidelines for healthcare workers on diagnosis and clinical management of cases and severe cases of _Aedes_-borne arboviral diseases (ref Q21)

```{r}
responses <- get_responses("21")
responses <- cbind(Country=data$SI01, responses) 

available <- responses$Country[which(responses$Response == "Yes")]
no_answer <- responses$Country[which(is.na(responses$Response))]
no_guidelines <- responses$Country[which(responses$Response == "No")]

```

The following countries indicated availability of clinical guidelines: `r available`.

`r no_answer` did not answer the question and `r no_guidelines` indicated no guidelines. 

#### Training healthcare workers on clinical diagnosis and management of Aedes-borne arboviral diseases

```{r}
caption <- paste0("Table ", table_num, ". Training for healthcare workers on clinical diagnosis and management of Aedes-borne arboviral diseases (ref Q24)")
responses <- get_responses("24")
colnames(responses) <- c("Response","Training")
cbind(Country=data$SI01, responses) %>%
  mutate( Response = recode_factor(.x = Response,
                                   "Yes, specific training is provided. If so, please specify:"="X",
                                   "No"=" ")) %>%
  filter(Response=="X") %>% 
  select(-Response) %>%
  replace_na( list(Training="Not specified")) %>%
  regulartable() %>%
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

#### Arboviral disease surveillance/clinical staff perceptions

```{r}
caption <- paste0("Table ", table_num, ". Arboviral disease surveillance/clinical staff perception of factors contributing to the a) success and b) barriers/challenges with respect to case management (ref Q25)")
responses <- get_responses("25")
cbind(Country=data$SI01, responses) %>%
  drop_na(Response) %>%
  regulartable() %>%
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

# Section V: Routine vector surveillance and control

#### Disease programme, agency, or service in charge of arbovirus vector surveillance

```{r}
caption <- paste0("Table ", table_num, ". Agency in charge of arbovirus vector surveillance (ref Q26)")
responses <- get_responses("26")
colnames(responses) <- c("Response","Programme")
responses <- responses %>% select( "Programme")
cbind(Country=data$SI01, responses) %>%
  mutate( Programme = factor( replace_na( as.character(Programme), "None"))) %>%
  rename( "Programme/Agency" = Programme) %>% 
  regulartable() %>% 
  set_caption( caption ) %>% autofit()

table_num <- table_num + 1
```

#### Reporting of entomologic surveillance data

```{r}
caption <- paste0("Table ", table_num, ". Institution/department in charge of reporting entomologic surveillance data to the national ministry of health/health department (ref Q27)")
responses <- get_responses("27")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

responses <- responses %>%
  mutate_at( .vars=vars(colnames(responses)),
             .funs = forcats::fct_recode,
             "X" = "Yes",
             " " = "Not selected")

cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

Other reporting of entomologic surveillance data:

```{r}
cbind(Country=data$SI01, other) %>%
  regulartable() %>% autofit()
```

#### Entomologic surveillance conducted for arboviral infections in mosquito vectors in the past two years (ref Q28)

```{r}
responses <- get_responses("28")
responses <- cbind(Country = data$SI01, responses)
conducted <- responses$Country[which(responses$Response == "Yes")]
not_conducted <- responses$Country[which(responses$Response == "No")]
no_response <- responses$Country[which(is.na(responses$Response))]

```

Countries that conducted entomologic surveillance included `r conducted`. Countries that did not included
`r not_conducted`. `r no_response` did not respond. 

```{r}
caption <- paste0("Table ", table_num, ". Frequency and scope of entomologic surveillance (ref Q28c, 28d, 28e)")
q28e <- get_responses("28e")
colnames( q28e ) <- c("How_often", "Other")
q28e <- q28e %>%
  mutate( How_often = factor( replace_na( as.character(How_often), ""))) %>%
  mutate( Other = factor( replace_na( as.character(Other), ""))) %>%
  unite( Response, How_often:Other, sep="") 
q28e <- cbind( Country = data$SI01, q28e)

q28c <- get_responses("28c")
colnames( q28c ) <- c("Scope", "Comments")
q28c <- q28c %>%
  mutate( Scope = recode_factor(.x = Scope,
                                   "Country wide"="Country wide",
                                   "Restricted to specific locations . Please specify where:"="Restricted to specific locations",
                                   "Don’t know"="I don’t know"))
responses <- cbind( q28e, q28c)

q28d <- get_responses("28d")
q28d <- cbind( Country = data$SI01, q28d) %>% 
  drop_na(Response) %>%
  mutate( Response = paste0("(", Response, " sentinel sites)")) %>%
  rename( "Sites" = Response )

left_join( responses, q28d, by="Country") %>%
  mutate( Scope = as.character( Scope ) ) %>%
  replace_na( list( Scope = "", Sites = "")) %>%
  unite( "Geographic scope", c("Scope", "Sites"), sep = "\n") %>%
  regulartable( ) %>% 
  set_caption(caption) %>% autofit()

```

#### Performance of adult and larval/pupal mosquito surveillance

```{r}
caption <- paste0("Table ", table_num, ". Mosquito surveillance and identification (ref Q29, 30, 31)")
q29 <- get_responses("29")
q29 <- q29 %>% 
  mutate( Response = recode_factor(.x=Response,
                                   "Yes"="X",
                                   "No"=" ")) %>%
  rename("Adult surveillance"="Response") 
q30 <- get_responses("30")
q30 <- q30 %>% 
  mutate( Response = recode_factor(.x=Response,
                                   "Yes"="X",
                                   "No"=" ")) %>%
  rename("Larval/pupal surveillance"="Response")
q31 <- get_responses("31")
q31 <- q31 %>% 
  mutate( Response = recode_factor(.x=Response,
                                   "Yes"="X",
                                   "No"=" ")) %>%
  rename("Trapped mosquitoes identified to species"="Response")
cbind(Country=data$SI01, q29, q30, q31) %>%
  regulartable() %>%
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

Minimum infection rate (MIR) calculations for any _Aedes_-borne arboviruses:

```{r}
responses <- get_responses("32")
colnames( responses ) <- c("Response", "Comments")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>% autofit()
```

#### Laboratories testing for arboviruses on mosquito pools in the last two years

```{r}
caption <- paste0("Table ", table_num, ". Laboratories testing mosquito pools for arboviruses (ref Q33)")
responses <- get_responses("33") 
# other <- responses %>% select(Other)
# responses <- responses %>% select(-Other)

responses <- responses %>%
  mutate_at( .vars=vars(colnames(responses)),
             .funs = forcats::fct_recode,
             "X" = "Yes",
             " " = "Not selected") 

empty_cols = c()
for(i in 1:ncol(responses)){
  responses[,i] <- as.character( responses[,i] )
  responses[ which( is.na( responses[,i])) ,i] <- " "
  if( all(responses[,i] != "X" )){
    empty_cols = c(empty_cols, colnames(responses)[i])
  }
}

cbind(Country=data$SI01, responses) %>%
  select(-empty_cols) %>% 
  regulartable() %>%
  # rotate( j=2:7, rotation = "btlr", part="header" ) %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

#### Presence _Aedes aegypti_ or _Aedes albopictus_ in the past 5 years (ref Q34)

```{r}
responses <- get_responses("34") 
responses <- cbind(Country=data$SI01, responses)
both <- responses$Country[ which(responses$Response == "Yes, both Aedes aegypti and Aedes albopictus" )]
aegypti <- responses$Country[ which(responses$Response == "Yes, only Aedes aegypti" )]
```

`r both` all indicated that both _Aedes aegypti_ and _Aedes albopictus_ were present, whereas `r aegypti` 
had only identified _Aedes aegypti_.

#### Potential public health threat from _Aedes_ species by country

```{r}
caption <- paste0("Table ", table_num, ". Potential public health threat from Aedes species by country (ref Q34b, 34c)")
q34b <- get_responses("34b")
colnames( q34b ) <- c("Response", "Other")
q34b <- q34b %>%
  mutate( Response = factor( replace_na( as.character(Response), ""))) %>%
  mutate( Other = factor( replace_na( as.character(Other), ""))) %>%
  unite( Response, Response:Other, sep="") %>%
  rename("Aedes aegypti threat"=Response)
q34c <- get_responses("34c")
colnames( q34c ) <- c("Response", "Other")
q34c <- q34c %>%
  mutate( Response = factor( replace_na( as.character(Response), ""))) %>%
  mutate( Other = factor( replace_na( as.character(Other), ""))) %>%
  unite( Response, Response:Other, sep="") %>%
  rename("Aedes albopictus threat"=Response)

cbind( Country = data$SI01, q34b, q34c) %>% 
  regulartable( ) %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

#### Vector control methods

```{r}
caption <- paste0("Table ", table_num, ". Vector control methods used in local jurisdictions in the past two years (either using government staff and resources, or subcontracting to a different entity to do so) (ref Q35)")
responses <- get_responses("35")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

responses <- responses %>%
  mutate_at( .vars=vars(colnames(responses)),
             .funs = forcats::fct_recode,
             "X" = "Yes",
             " " = "Not selected") %>%
  rename("Adulticiding"="Adulticiding (insecticide application against adult mosquitoes)")

empty_cols = c()
for(i in 1:ncol(responses)){
  responses[,i] <- as.character( responses[,i] )
  responses[ which( is.na( responses[,i])) ,i] <- " "
  if( all(responses[,i] != "X" )){
    empty_cols = c(empty_cols, colnames(responses)[i])
  }
}

if( any(!is.na(other$Other))){
  responses <- cbind( responses, other)
}

cbind(Country=data$SI01, responses) %>%
  select(-empty_cols) %>%
  regulartable() %>%
  set_caption(caption) %>% autofit()

empty_cols <- empty_cols[ which(empty_cols != "None")]

table_num <- table_num + 1
```

No countries reported the use of `r (empty_cols)`.

```{r}
caption <- paste0("Table ", table_num, ". Adulticides and/or larvicides (brand and product name) used (ref Q35c)")
responses <- get_responses("35c")
cbind(Country=data$SI01, responses) %>%
  drop_na( Response ) %>%
  rename("Product used"=Response) %>%
  regulartable() %>%
  # hline( part="body") %>%
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

#### Surveillance system in place for monitoring _Aedes_ resistance to the insecticide(s) used (ref Q39)

```{r}
responses <- get_responses("39")
responses <- cbind(Country=data$SI01, responses) 
monitoring <- responses$Country[ which(responses$Response == "Yes")]
```

`r monitoring` indicated that there is _Aedes_ resistance monitoring in place. 

#### Staff training in vector control and surveillance (ref Q36)

```{r}
responses <- get_responses("36")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>% autofit()
```

#### Plan for mosquito-borne disease control including threshold that would result in a recommendation for mosquito adulticiding/other mosquito reduction measures

```{r}
caption <- paste0("Table ", table_num, ". Mosquito control plan and threshold (ref Q37)")
responses <- get_responses("37")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

#### Entomological indices measured

```{r}
caption <- paste0("Table ", table_num, ". Outbreak risk factors data collected routinely and analysed (ref Q37b)")
responses <- get_responses("37b")
other <- responses %>% select(Other) 
responses <- responses %>% select(-Other)

responses <- responses %>%
  mutate( across(everything(), na_if, "Not selected") ) %>%
  mutate( across(everything(), as.character)) %>%
  mutate( across(everything(), str_replace, pattern="Yes", replacement="X"))

keep_cols = c()
for(i in 1:ncol(responses)){
  if( any( !is.na(responses[,i]) )){
    keep_cols = c(keep_cols, colnames(responses)[i])
  }
}

if( any(!is.na(other$Other))){
  responses <- cbind( responses, other)
  keep_cols <- c( keep_cols, "Other")
}

cbind(Country=data$SI01, responses) %>%
  select( c("Country", keep_cols )) %>%
  filter( if_any(keep_cols, ~ !is.na(.) ) ) %>%
  regulartable() %>%
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

#### Vector surveillance staff perceptions

```{r}
caption <- paste0("Table ", table_num, ". Vector surveillance staff perceptions of factors contributing to the a) success and b) barriers/challenges with respect to vector surveillance and control (ref Q40)")
responses <- get_responses("40")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

# Section VI: Animal surveillance

#### National epidemiological surveillance for arboviral disease in animals 

```{r}
caption <- paste0("Table ", table_num, ". National epidemiological surveillance for arboviral disease in animals in the past two years (e.g., epizootic surveillance for yellow fever in endemic areas) (ref Q41, 41b, 41c)")
q41 <- get_responses("41") %>%
  rename( "Conducted" = Response )

q41b <- get_responses("41b")
colnames( q41b ) <- c("Frequency", "Other")
q41b <- q41b %>%
  mutate( Frequency = factor( replace_na( as.character(Frequency), ""))) %>%
  mutate( Other = factor( replace_na( as.character(Other), ""))) %>%
  unite( Frequency, Frequency:Other, sep="") 

q41c <- get_responses("41c") %>%
  rename("Type of surveillance" = Response)

cbind(Country=data$SI01, q41, q41b, q41c) %>%
  regulartable() %>%
  # hline( part="all") %>% 
  set_caption( caption ) %>% autofit()

table_num <- table_num + 1
```

#### Sentinel animal surveillance or epizootic surveillance

```{r}
caption <- paste0("Table ", table_num, ". Countries conducting sentinel surveillance in animals -- the viruses tested for and species under surveillance (ref Q42, 42b)")
q42 <- get_responses("42")

responses <- get_responses("42b")
idx <- which( grepl("Virus name",colnames(responses)))

arboviruses <- responses[,idx] %>%
  mutate( across(everything(), replace_na, "")) %>%
  unite( Virus, everything(), sep = "\t") 

species <- responses[,-idx] %>%
  mutate( across(everything(), replace_na, "")) %>%
  unite( Species, everything(), sep="\t")

cbind( Country = data$SI01, q42, arboviruses, species ) %>%
  filter( Response == "Yes" ) %>% 
  select( Country, Virus, Species ) %>%
  regulartable() %>%
  merge_v(j = ~Country ) %>% 
  # hline( part="all") %>% 
  set_caption( caption ) %>% autofit()

table_num <- table_num + 1
```

# Section VII: Community sensitization and participation

#### Presence of a community outreach program that also covers arboviral diseases

```{r}
caption <- paste0("Table ", table_num, ". Community outreach program presence, leadership, and geographic scope (ref Q43, 43b, 43c)")
q43 <- get_responses("43") %>%
  rename( "In place" = Response)

q43b <- get_responses("43b") %>%
  rename( "Entity in charge" = Response)

q43c <- get_responses("43c") 
colnames( q43c ) <- c("Response","Areas") 
q43c <- q43c %>% 
  mutate( across( everything(), as.character)) %>%
  mutate( across( everything(), replace_na, "") )
q43c$Response[ grep("Only selected areas", q43c$Response ) ] <- "Only selected areas"
q43c <- q43c %>%
  unite( Scope, Response:Areas, sep="\n")

cbind(Country=data$SI01, q43, q43b, q43c) %>%
  regulartable() %>%
  # hline( part="all") %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1
```

#### Is the community outreach/social mobilization program sufficiently funded to cover staff time, prevention and outreach activities as needed? (ref Q43d)

```{r}
responses <- get_responses("43d")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  hline( part="all") # %>% autofit()
```

#### Resources that would help ensure adequate capacity of the community outreach programme

```{r}
caption <- paste0("Table ", table_num, ". Resources needed to ensure adequate community outreach capacity (ref Q43e)")
responses <- get_responses("43e")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

responses <- responses %>%
  mutate( across(everything(), na_if, "Not selected") ) %>%
  mutate( across(everything(), as.character)) %>%
  mutate( across(everything(), str_replace, pattern="Yes", replacement="X"))

keep_cols = c()
for(i in 1:ncol(responses)){
  if( any( !is.na(responses[,i]) )){
    keep_cols = c(keep_cols, colnames(responses)[i])
  }
}

if( any(!is.na(other$Other))){
  responses <- cbind( responses, other)
  keep_cols <- c( keep_cols, "Other")
}

cbind(Country=data$SI01, responses) %>%
  select( c("Country", keep_cols )) %>%
  filter( if_any(keep_cols, ~ !is.na(.) ) ) %>%
  regulartable() %>%
  # hline( part="all") %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1

```

#### National arboviral disease program notifications to the public about local transmission risk and/or possible vector-control activities 

```{r}
caption <- paste0("Table ", table_num, ". National arboviral disease program notifications to the public about local transmission risk and/or possible vector-control activities as a prevention message for arboviral diseases within the last 2 years during outbreak (O) and non-outbreak (N) periods (ref Q44)")
responses <- get_responses("44")
idx <- which( grepl("non-outbreak",colnames(responses)))

outbreaks <- cbind( Country=data$SI01, responses[,-idx]) %>%
  pivot_longer(!Country) 
new_cols <- matrix( unlist( strsplit(outbreaks$name, "\\]\\[") ), ncol=2, byrow=T)
outbreaks <- outbreaks %>% 
	mutate(Level = new_cols[,1], Response = new_cols[,2]) %>% 
	select(-name) %>%
	mutate( value = case_when( value == 1 ~ "O", value == 0 ~ "", is.na(value) ~ "")) %>%
	pivot_wider(names_from=Response, values_from=value) %>%
  select(-Level) 

non_outbreaks <- cbind( Country=data$SI01, responses[,idx]) %>%
  pivot_longer(!Country) 
new_cols <- matrix( unlist( strsplit(non_outbreaks$name, "\\]\\[") ), ncol=2, byrow=T)
non_outbreaks <- non_outbreaks %>% 
	mutate(Level = new_cols[,1], Response = new_cols[,2]) %>% 
	select(-name) %>%
	mutate( value = case_when( value == 1 ~ "N", value == 0 ~ "", is.na(value) ~ "")) %>%
	pivot_wider(names_from=Response, values_from=value) %>%
  select(-Level) 

responses <- left_join( outbreaks, non_outbreaks, by="Country") %>%
  unite( "Issued by national public health agency", c("Issued by national public health agency.x", "Issued by national public health agency.y"), sep="") %>%
  unite( "Issued by state/local health agencies", c("Issued by state/local health agencies.x", "Issued by state/local health agencies.y"), sep="") %>%
  unite( "No risk in the past two years", c("No risk in the past two years.x", "No risk in the past two years.y"), sep="" ) %>%
  unite("No notifications even though risk was present", c("No notifications even though risk was present.x", "No notifications even though risk was present.y"), sep="") %>% 
  mutate( across(everything(), str_replace, pattern="ON", replacement="O, N")) %>%
  mutate( across( everything(), na_if, "" ))

keep_cols = c()
for(i in 2:ncol(responses)){
  if( any( !is.na(responses[,i]) )){
    keep_cols = c(keep_cols, colnames(responses)[i])
  }
}

responses %>%
  select( c("Country",keep_cols) ) %>%
  # filter( if_any(keep_cols, ~ !is.na(.) ) ) %>%  ## uncomment to remove empty rows!
  regulartable() %>%
  # hline( part="all") %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1

```

#### Media/channels used for community sensitization, mobilisation and acceptance of interventions 

```{r}
caption <- paste0("Table ", table_num, ". Media and other communication channels used for community sensitization, mobilisation and acceptance of interventions (ref Q44b)")
responses <- get_responses("44b")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

responses <- responses %>%
  mutate_at( .vars=vars(colnames(responses)),
             .funs = forcats::fct_recode,
             "X" = "Yes",
             " " = "Not selected")

cbind(Country=data$SI01, responses, other) %>%
  regulartable() %>%
  # hline( part="all") %>% 
  set_caption( caption ) %>% autofit()

table_num <- table_num + 1

```

#### Regular training sessions for staff in charge of community sensitization, mobilisation and acceptance of interventions dedicated to control arboviral diseases (ref Q45)

```{r}
responses <- get_responses("45")
colnames( responses ) <- c("Response", "Comments")
cbind(Country=data$SI01, responses) %>%
  # mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = recode_factor(.x = Response,
                                   "Yes. If yes, please describe in comments field:"="Yes",
                                   "No"="No",
                                   "I don’t know"="I don’t know")) %>%
  regulartable() %>%
  # hline( part="all") %>% 
  autofit()
```

#### Community outreach staff perceptions

```{r}
caption <- paste0("Table ", table_num, ". Community outreach staff perceptions of factors contributing to the a) success and b) barriers/challenges with respect to community participation (ref Q46)")
responses <- get_responses("46")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  hline( part="all") %>% 
  set_caption( caption ) %>% autofit()

table_num <- table_num + 1

```

# Section VIII: Preparedness for arboviral outbreaks/epidemics

#### Surveillance and outbreak response committee and emergency preparedness and funding

```{r}
caption <- paste0("Table ", table_num, ". Outbreak committee presence, staff training, contingency plan and emergency funding (ref Q47, 48, 52, 53)")
q47 <- get_responses("47") %>%
  rename( "Outbreak committee in place" = Response)
q48 <- get_responses("48") %>%
  rename( "Staff/committee training for outbreaks" = Response)

q52 <- get_responses("52")

emergency_fund <- c()
for(i in 1:nrow(q52)){
  col = which( q52[i,] == "Yes")
  if( length(col) > 0 ){
    emergency_fund <- c( emergency_fund, paste0(names(q52)[col], collapse="\n"))
  } else{
    emergency_fund <- c(emergency_fund, NA)
  }
}

q53 <- get_responses("53") %>%
  rename( "Contingency plan for healthcare services in emergencies" = Response)

cbind(Country=data$SI01, q47, q48, q53, "Emergency fund" = emergency_fund) %>%
  regulartable() %>%
  # hline( part="all") %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1

```

#### Outbreak declaration and emergency response measures 

```{r}
caption <- paste0("Table ", table_num, ". Criteria for declaring an outbreak and vector control measures that are deployed in emergencies (ref Q49, 51)")

q49 <- get_responses("49")
colnames( q49 ) <- c("Response", "Comments")
q49 <- cbind(Country=data$SI01, q49) %>%
  mutate( Response = recode_factor(.x = Response,
                                   "Yes. If so, in the comments field, please briefly describe the criteria or reference the document in which those are sta"="Yes",
                                   "No"="No",
                                   "I don’t know"="I don’t know")) %>%
  mutate( across( everything(), as.character) ) %>%
  mutate( across( everything(), replace_na, "") ) %>%
  unite( "Criteria for outbreak declaration", Response:Comments, sep="\n") 

q51 <- get_responses("51") %>%
  rename( "Emergency vector control measures" = Response)

cbind( q49, q51 ) %>%
  regulartable( ) %>%
  # hline( part="all") %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1 

```

#### Established collaborations with national/regional research institutions / international agencies to be activated in case of arboviral outbreak

```{r}
caption <- paste0("Table ", table_num, ". Established collaborations with institutions or agencies for arboviral outbreaks (ref Q50)")
responses <- get_responses("50")
colnames( responses ) <- c("Response", "Institutions")
cbind(Country=data$SI01, responses) %>%
  mutate( Response = recode_factor(.x = Response,
                                   "Yes. If so, please specify institutions/agencies in the comments field:"="X",
                                   "No"=" ")) %>%
  filter( Response == "X" ) %>%
  select(-Response) %>% 
  regulartable() %>%
  # hline( part="all") %>% 
  set_caption(caption) %>% autofit()

table_num <- table_num + 1 

```

#### Arboviral disease surveillance staff perception of factors contributing to the a) success and b) barriers/challenges with respect to preparedness of arboviral diseases epidemics (ref Q54)

```{r}
caption <- paste0("Table ", table_num, ". Arboviral disease surveillance staff perception of factors contributing to the a) success and b) barriers/challenges with respect to preparedness of arboviral diseases epidemics (ref Q54)")
responses <- get_responses("54")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  # hline( part="all") # %>% autofit()
  set_caption(caption) %>% autofit()

table_num <- table_num + 1 
```

# Section IX: Arboviral disease surveillance data

#### 55. Please provide total number of cases and deaths for the following arboviral diseases from 2015 to 2020 (if available)

```{r}
responses <- get_responses("55")
col_names <- colnames(responses)
col_names <- matrix( unlist( strsplit(col_names, "\\]\\[") ), ncol=2, byrow=T)
col_names <- cbind( col_names[,1], matrix( unlist( strsplit(col_names[,2], " ") ), ncol=2, byrow=T))
ncountries <- length(data$SI01)
ncr <- ncol(responses)
df <- data.frame( Country=character(), Virus=character(), Year=character(), Type=character(), Number=numeric() )
for( i in 1:ncountries ){
  country <- rep( data$SI01[i], ncr)
  df <- rbind( df, 
               data.frame(Country=country, 
                          Virus=col_names[,1], 
                          Year=col_names[,2],
                          Type=col_names[,3],
                          Number=as.numeric( t( responses[i,] ))))
}

df %>% 
  drop_na(Number) %>%
  unite("Category", Year:Type, sep=" ") %>% 
  group_by(Country, Virus, Category) %>%
  summarize( Number = sum(Number)) %>%
  pivot_wider(names_from=Virus, values_from=Number) %>%
  regulartable() %>%
  merge_v(j = ~Country) %>%
  # hline( part="all") %>%
  fix_border_issues() %>% autofit()

```

#### 55b. Were cases of other mosquito-borne arboviruses, not listed in the previous question, reported in your country from 2015-2020?

```{r}
responses <- get_responses("55b")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```


#### 55c. Please select any of the following other mosquito-borne viruses that have been reported in your country from 2015-2020

```{r}
responses <- get_responses("55c")

cbind( Country=data$SI01, responses) %>%
  pivot_longer(!Country) %>% 
  filter(value=="Yes") %>% 
  select(-value) %>%
  rename("Arbovirus(es)" = name) %>%
  regulartable() %>% 
  merge_v( j = ~Country) %>%
  # hline( part="all") # %>% 
  autofit()
```

#### 55d. Please provide total number of cases and deaths due to each of the following other arboviruses that you selected from 2015-2020

```{r}
responses <- get_responses("55d")

col_names <- colnames(responses)
col_names <- matrix( unlist( strsplit(col_names, "\\]\\[") ), ncol=2, byrow=T)
col_names <- cbind( col_names[,1], matrix( unlist( strsplit(col_names[,2], " ") ), ncol=2, byrow=T))
ncountries <- length(data$SI01)
ncr <- ncol(responses)
df <- data.frame( Country=character(), Virus=character(), Year=character(), Type=character(), Number=numeric() )
for( i in 1:ncountries ){
  country <- rep( data$SI01[i], ncr)
  df <- rbind( df, 
               data.frame(Country=country, 
                          Virus=col_names[,1], 
                          Year=col_names[,2],
                          Type=col_names[,3],
                          Number=as.numeric( t( responses[i,] ))))
}

df %>% 
  drop_na(Number) %>%
  unite("Category", Year:Type, sep=" ") %>% 
  group_by(Country, Virus, Category) %>%
  pivot_wider(names_from=Virus, values_from=Number) %>%
  regulartable() %>%
  merge_v(j = ~Country) %>%
  # hline( part="all") %>%
  fix_border_issues() %>% autofit()

```

#### 56. Please provide the number of cases of locally acquired, mosquito-borne Aedes-borne arbovirus infections by case classification for 2020 and, if not available, for 2019

```{r}
responses <- get_responses("56")

col_names <- colnames(responses)
col_names <- matrix( unlist( strsplit(col_names, "\\]\\[") ), ncol=2, byrow=T)
# col_names <- cbind( col_names[,1], matrix( unlist( strsplit(col_names[,2], " ") ), ncol=2, byrow=T))
ncountries <- length(data$SI01)
ncr <- ncol(responses)
df <- data.frame( Country=character(), Virus=character(), Type=character(), Number=numeric() )
for( i in 1:ncountries ){
  country <- rep( data$SI01[i], ncr)
  df <- rbind( df, 
               data.frame(Country=country, 
                          Virus=col_names[,1], 
                          Type=col_names[,2],
                          Number=as.numeric( t( responses[i,] ))))
}

df %>% 
  drop_na(Number) %>%
  group_by(Country, Virus, Type) %>%
  pivot_wider(names_from=Virus, values_from=Number) %>%
  regulartable() %>%
  merge_v(j = ~Country) %>%
  # hline( part="all") %>%
  fix_border_issues() %>% autofit
```

#### 57. Do arbovirus surveillance staff have any perceived reasons for increasing trends in arboviral disease incidence? Check all answers that apply.

```{r}
responses <- get_responses("57")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

responses <- responses %>%
  mutate_at( .vars=vars(colnames(responses)),
             .funs = forcats::fct_recode,
             "X" = "Yes",
             " " = "Not selected")

cbind(Country=data$SI01, responses, other) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

# Section X: Surveillance staffing

#### 58. During 2019 (prior to the Covid-19 pandemic), indicate below the number of arbovirus surveillance staff at the national level.

```{r}
responses <- get_responses("58")
colnames(responses) <- c("Clinicians",
                         "Epidemiologists",
                         "Laboratorians",
                         "Entomologists/vector control specialists",
                         "Support staff")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

#### 59. Indicate below how many total staff persons are needed at the national level in your country to achieve full epidemiology and laboratory capacity* to conduct arbovirus surveillance

```{r}
responses <- get_responses("59")
colnames(responses) <- c("Clinicians",
                         "Epidemiologists",
                         "Laboratorians",
                         "Entomologists/vector control specialists",
                         "Support staff")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

#### 60. Optional comments to explain responses to questions 58 and 59 above

```{r}
responses <- get_responses("60")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

#### 61. The national health authority/ministry of health has access to expertise in clinical management of arboviruses (Check all that apply) 

```{r}
responses <- get_responses("61")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

responses <- responses %>%
  mutate_at( .vars=vars(colnames(responses)),
             .funs = forcats::fct_recode,
             "X" = "Yes",
             " " = "Not selected")

cbind(Country=data$SI01, responses, other) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

#### 62. The national health authority/ministry of health has access to expertise in arbovirus epidemiology (Check all that apply

```{r}
responses <- get_responses("62")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

responses <- responses %>%
  mutate_at( .vars=vars(colnames(responses)),
             .funs = forcats::fct_recode,
             "X" = "Yes",
             " " = "Not selected")

cbind(Country=data$SI01, responses, other) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

#### 63. The national health authority/ministry of health has access to expertise in arbovirus laboratory diagnosis (Check all that apply)

```{r}
responses <- get_responses("63")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

responses <- responses %>%
  mutate_at( .vars=vars(colnames(responses)),
             .funs = forcats::fct_recode,
             "X" = "Yes",
             " " = "Not selected")

cbind(Country=data$SI01, responses, other) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

#### 64. The national health authority/ministry of health has access to expertise in entomology (Check all that apply)

```{r}
responses <- get_responses("64")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

responses <- responses %>%
  mutate_at( .vars=vars(colnames(responses)),
             .funs = forcats::fct_recode,
             "X" = "Yes",
             " " = "Not selected")

cbind(Country=data$SI01, responses, other) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

#### 65. Optional comments to explain responses to any of Questions 61-64

```{r}
responses <- get_responses("65")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

# Section XI: Survey conclusion

#### 66. If you have any further comments to add regarding arbovirus surveillance and control in your country, including whether arboviruses other than Aedes-borne arboviruses are of higher priority, please do so in the text field below

```{r}
responses <- get_responses("66")
colnames(responses) <- "Response"
cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

# Appendix

#### Respondent/person to be contacted for clarification, if needed, with professional title and affiliation

```{r}
regulartable( data.frame( Country=data$SI01, Contact=data$SI02, Title=data$SI03) ) %>%
  # hline( i = 1:length(data$SI01)) # %>% 
  autofit()
```

#### 7b. Please specify the programme into which arboviral diseases is integrated:

```{r}
responses <- get_responses("7b")
colnames( responses) <- "Response"

cbind(Country = data$SI01, responses) %>% 
  drop_na(Response) %>%
  regulartable() %>% 
  # hline( part="all" ) # %>% 
  autofit()
```

#### 8. For which level of the health structure are individual and aggregated data available ? (Select all relevant levels)

```{r}
responses <- get_responses("8") 
responses <- cbind( Country=data$SI01, responses) %>%
	pivot_longer(!Country)
new_cols <- matrix( unlist( strsplit(responses$name, "\\]\\[") ), ncol=2, byrow=T)
responses <- responses %>% 
	mutate(Level = new_cols[,1], Response = new_cols[,2]) %>% 
	select(-name) %>%
	mutate( value = case_when( value == 1 ~ "Yes", is.na(value) ~ "No")) 

responses %>% 
  filter(Response == "Individual level") %>%
  select(Country, Level, Response=value) %>%
  regulartable() %>%
  set_caption("Individual data") %>%
  # hline( i =4*(1:n_countries)) %>%
  merge_v(j = ~Country) %>% 
  fix_border_issues() # %>% autofit()

responses %>%
  filter(Response == "Aggregated ") %>% 
  select(Country, Level, Response=value) %>%
  regulartable() %>%
  set_caption("Aggregated data") %>%
  # hline( i =4*(1:n_countries)) %>%
  merge_v(j = ~Country) %>%
  fix_border_issues() # %>% autofit()

```

#### Reporting tool format used (electronic, paper-based, or mixed methods)

```{r}
responses <- get_responses("9")
# colnames( responses ) <- c("National", "State", "District")

cbind( Country = data$SI01, responses ) %>% 
  # mutate( National = factor( replace_na( as.character(National), "Unanswered"))) %>%
  # mutate( State = factor( replace_na( as.character(State), "Unanswered"))) %>%
  # rename("State/provincial" = State) %>% 
  # mutate( District = factor( replace_na( as.character(District), "Unanswered"))) %>%
  regulartable() %>% 
  # hline( i = 1:length(data$SI01)) # %>% 
  autofit()

```

#### 16b. If your country does not have capacity to type and serotype arboviruses, do you send samples for typing to other countries?

```{r}
responses <- get_responses("16b")
colnames(responses) <- c("Response","Where")
responses <- responses %>%
  mutate(Response = recode_factor(.x=Response,
                                  "Yes. Please specify where:"="Yes",
                                  "No"="No"))
cbind(Country = data$SI01, responses) %>% 
  # mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  regulartable() %>% 
  # hline( part="all" ) # %>% 
  autofit()
```

#### 19. Do you perform virological surveillance on humans, ie, tracking of prevailing genotypes/serotypes? Please select all that apply.

```{r}
responses <- get_responses("19")
colnames(responses) <- c("Yes, using virus isolation",
                         "Virus isolation comments",
                         "Yes, using RT-PCR",
                         "RT-PCR comments",
                         "Yes, using other nucleic acid tests",
                         "Nucleic acid tests comments",
                         "Yes, using serological testing",
                         "Serological testing comments",
                         "No",
                         "Comments",
                         "I don't know",
                         "IDKC")
responses <- responses %>%
  select(-IDKC)

cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

#### 19b. Which samples do you use for virological surveillance? 

```{r}
responses <- get_responses("19b")
cbind(Country=data$SI01, responses) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

#### 19c. For which viruses do you perform virological surveillance? (check all that apply)  

```{r}
responses <- get_responses("19c")

cbind(Country = data$SI01, responses) %>% 
  pivot_longer(!Country, names_to="Arbovirus", values_to="Response") %>% 
  # mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = recode_factor(.x = Response,
                                   "Yes"="X",
                                   "Not selected"=" ")) %>% 
                                   # "Unanswered"="Unanswered")) %>%
  pivot_wider( names_from=Arbovirus, values_from=Response) %>%
  regulartable() %>% 
  hline( i = 1:length(data$SI01)) # %>% autofit()
```

#### 22. Are severe cases of arboviral diseases managed in a special area (part of the hospital, isolation beds)?

```{r}
responses <- get_responses("22")
colnames(responses) <- c("Response","Where")
cbind(Country=data$SI01, responses) %>%
  # mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```

#### 23. How many hospital beds are available per 100,000 population?

```{r}
responses <- get_responses("23")
cbind(Country=data$SI01, responses) %>%
  # mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  regulartable() %>%
  # hline( part="all") # %>% 
  autofit()
```
