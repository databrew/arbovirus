---
title: "Arboviral Surveillance and Response Capacity Survey 2021"
author: "World Health Organization"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_depth: 2
  pdf_document:
    toc: yes
  word_document:
    toc: yes
    toc_depth: '2'
---

```{r setup, include=FALSE, echo = FALSE}
# Basic knitr options
library(knitr)
opts_chunk$set(comment = NA, 
               echo = FALSE,
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
               fig.width = 9.64,
               fig.height = 5.9)
               # fig.path = 'figures/')
options(scipen = '999')
```


```{r}

library(tidyverse)
library(readxl)
library(flextable)
library(stringr)
library(pander)
library(RColorBrewer)
library(janitor)
library(knitr)
library(kableExtra)

make_colors <- function(n, seed = 123){
  pal <- RColorBrewer::brewer.pal(n = 9, name = 'Set1')
  set.seed(seed)
  pal <- sample(pal, length(pal))
  out <- colorRampPalette(pal)(n)
  return(out)
}
ggplot2::theme_set(theme_bw())

# get the survey results: processed by WHO script (lightly edited),
# then WHO regions added

if( file.exists("data/data.RData") ){
  load("data/data.RData")
} else{
  source("data/survey_375147_R_syntax_file.R")
  n_countries <- length( data$SI01 )
  who_regions <- read_csv("data/Regions_Countries.csv")
  region <- character( length=n_countries )
  for(i in 1:n_countries){
    idx <- which( who_regions$Country == data$SI01[i] )
    if( length(idx) > 0 ){
      region[i] <- who_regions$Region[idx]
    } else{
      region[i] <- NA
    }
  }
  # Region needs to be the last column to maintain consistency between data and dictionary!
  data <- data %>% mutate( Region = factor(region) )
  save(data, file="data/data.RData")
}

# Iceland is for testing purposes only; remove for analysis:
data <- data %>%
  filter( SI01 != "Iceland")

# load data dictionary to facilitate processing survey results:
dict <- read_csv("data/Data_dictionary_Survey375147.csv")

# utility function 
get_responses <- function( question_number ){
  idx <- which( dict$`Question number` == question_number )
  # question <- dict$Description[ idx[1] ]
  # cat( paste("Question", question_number, ":", question) )
  var_names <- dict$`Variable name`[idx]
  responses <- data %>% select( all_of(var_names) )
  if( !is.na(dict$Subquestion[ idx[1] ]) ){
    # remove square brackets at beginning and end, then rename columns:
    colnames( responses ) <- str_extract( dict$Subquestion[idx], '(?<=\\[)[^{}]+(?=\\])')
  } else{
    colnames( responses ) <- "Response"
  }
  return( responses )
}

```

<!-- # Data structure and quantity -->

<!-- ## Number of submissions -->

<!-- After excluding the entry for Iceland, there are `r nrow(data)` rows and  -->
<!-- `r length(unique(na.omit(data$SI01)))` unique countries in the dataset. -->
<!-- Repeated countries: -->

```{r echo=FALSE, message=FALSE, eval=FALSE}
idx <- which( duplicated( data$SI01 ) )
pander( as.vector(unique( data$SI01[idx] ) ) )
```

```{r eval=FALSE}
pd <- data %>%
  group_by(Country = SI01) %>%
  tally %>%
  arrange(desc(n)) %>%
  filter(n >= 2) %>%
  bind_rows(
    tibble(Country = 'Others',
           n = 1)
  )
pd$Country <- factor(pd$Country,
                     levels = pd$Country)

ggplot(data = pd,
       aes(x = Country,
           y = n)) +
  geom_bar(stat = 'identity') +
  geom_text(aes(label = n),
            nudge_y = -0.2,
            color = 'white',
            size = 7) +
  labs(y = 'Entries',
       title = 'Survey entries per country')
```

# **Surveillance capacity indicators**

## Reportable arboviral diseases

> Is reporting mandatory for any arboviral disease cases in your country? (Question 11) 

```{r}

responses <- get_responses("11")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "No", "Unanswered")) %>% 
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
  pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
  mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
  adorn_totals() %>%
  regulartable() %>%
  hline(i=4) # %>% autofit 

tab
  
if( !file.exists("tables/q11.png")){
  path <- save_as_image(tab, zoom=1, "tables/q11.png")
}

# ggplot( df, 
#         aes( x = Response,
#              y = n,
#              fill = Response)) +
#   geom_col() +
#   facet_wrap( ~Region ) +
#   theme(legend.position = "bottom",
#         legend.direction="horizontal",
#         axis.title.x=element_blank(),
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank()) +
#   guides(fill=guide_legend(ncol=3)) +
#   scale_fill_manual(name = '',
#                     values = make_colors(length(unique(qdf$Response)))) +
#   labs(title = "Mandatory reporting of cases", 
#        y = 'Responses')
  
```

<!-- <center> -->
<!-- <img src="tables/q11.png" alt="question 11"> -->
<!-- </center><br> -->

> For which of the following arboviral disease cases is reporting mandatory in your country? (Question 11b) 

```{r}

responses <- get_responses("11b")

df <- cbind(Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Arbovirus", values_to="Response") %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  group_by(Region, Arbovirus, Response) %>% 
  tally
df$Response <- str_to_sentence(gsub("Mandatory reporting of ", "", df$Response))

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n) %>% 
    drop_na(Region) %>% 
    relocate("Confirmed cases only", .after="All suspect cases") %>%
    regulartable() %>% 
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=6*(1:4)) %>% 
    colformat_num(na_str = "0") %>%
    fix_border_issues() %>%
    width( j=2, width=2 ) # %>% autofit() 

tab

if( !file.exists("tables/q11b.png") ){
    path <- save_as_image(tab, zoom=1, "tables/q11b.png")
}

# ggplot(df, aes(x=Response, y=n, fill=Response)) + 
#   geom_col() + 
#   facet_grid( Region ~ Arbovirus ) +
#   theme(legend.position = "bottom",
#         legend.direction="horizontal",
#         axis.title.x=element_blank(),
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank()) +
#   guides(fill=guide_legend(ncol=4)) +
#   scale_fill_manual(name = '',
#                     values = make_colors(length(unique(qdf$Response)))) +
#   labs(title = "Regional reporting of cases", 
#        y = 'Responses')

```

<!-- <center> -->
<!-- <img src="tables/q11b.png" alt="question 11b"> -->
<!-- </center><br> -->

##  History of any arbovirus circulation since 2000 

> Which arboviruses have circulated in your country at any time since the year 2000?  This refers only to arboviruses with autochthonous i.e., local mosquito-borne, transmission. (Question 5) 

```{r}

responses <- get_responses("5")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

df <- cbind( Region = data$Region, responses) %>% 
  drop_na(Region) %>% 
  pivot_longer(!Region, names_to="Arbovirus", values_to="Response") %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "Not selected", "Unanswered")) %>%
  group_by(Region, Arbovirus, Response) %>% 
  tally


tab <- df %>% 
    pivot_wider( names_from=Response, values_from=n, names_sort = TRUE) %>% 
    regulartable %>% 
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=4*(1:4)) %>% 
    colformat_num( na_str = "0" ) %>%
    fix_border_issues # %>% autofit 

tab
  
if( !file.exists("tables/q5.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q5.png")
}

# ggplot(data = df %>% filter(Response == 'Yes'),
#        aes(x = Arbovirus,
#            y = n,
#            fill = Arbovirus)) +
#   geom_col() +
#   facet_grid( ~Region ) +
#   theme(legend.position = "bottom",
#         legend.direction="horizontal",
#         axis.title.x=element_blank(),
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank()) +
#   guides(fill=guide_legend(ncol=4)) +
#   scale_fill_manual(name = '',
#                     values = make_colors(length(unique(qdf$Arbovirus)))) +
#   labs(title = "Arbovirus circulation since 2000", 
#        y = 'Responses')

```

<!-- <center> -->
<!-- <img src="tables/q5.png" alt="question 5"> -->
<!-- </center><br> -->

##  Conducting surveillance on humans,  vectors, and animals

> In the last 2 years, did your country conduct national epidemiological surveillance for human cases of arboviral disease? (Question 12) 

```{r}

responses <- get_responses("12") 

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>% 
  mutate( Response = fct_relevel(Response, "Yes", "No", "I don't know", "Unanswered")) %>% 
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
  adorn_totals()

tab <- regulartable(df) %>%
    colformat_num( na_str="0" ) %>%
    hline(i=4) # %>% autofit 

tab
  
if( !file.exists("tables/q12.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q12.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q12.png" alt="question 12"> -->
<!-- </center><br> -->

> For the last 2 years, did your country conduct entomologic surveillance for arboviral infections in mosquito vectors? (Question 28)

```{r}

responses <- get_responses("28")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>% 
  mutate( Response = fct_relevel(Response, "Yes", "No", "Don't know", "Unanswered")) %>% 
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
  adorn_totals()

tab <- regulartable( df ) %>%
    colformat_num( na_str="0" ) %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q28.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q28.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q28.png" alt="question 28"> -->
<!-- </center><br> -->

> During the last 2 years, did your country conduct national epidemiological surveillance for arboviral disease in animals (e.g., epizootic surveillance for yellow fever in endemic areas)? (Question 41) 

```{r}

responses <- get_responses("41")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>% 
  mutate( Response = fct_relevel(Response, "Yes", "No", "I don't know", "Unanswered")) %>%
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
  adorn_totals()

tab <- regulartable( df ) %>%
    colformat_num( na_str="0" ) %>%
    hline(i=4) # %>% autofit 

tab 

if( !file.exists("tables/q41.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q41.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q41.png" alt="question 41"> -->
<!-- </center><br> -->

## Training of surveillance personnel and clinicians

> Which training has been provided to the staff working on arboviral disease surveillance data? (Question 10) 

```{r}

responses <- get_responses("10")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

df <- cbind( Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Training", values_to="Response") %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "Not selected", "Unanswered")) %>% 
  group_by(Region, Training, Response) %>% 
  tally

tab <- df %>% 
    pivot_wider( names_from=Response, values_from=n, names_sort = TRUE) %>% 
    drop_na(Region) %>% 
    regulartable %>% 
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=5*(1:4)) %>% 
    colformat_num( na_str = "0" ) %>%
    fix_border_issues %>%
    width( j=2, width=3 ) # %>% autofit 

tab

if( !file.exists("tables/q10.png") ){ 
  path <- save_as_image(tab, zoom=1, "tables/q10.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q10.png" alt="question 10"> -->
<!-- </center><br> -->

> Does your country provide regular training sessions for healthcare workers on clinical diagnosis and management of Aedes-borne arboviral diseases? (Question 24) 

```{r}

responses <- get_responses("24")
colnames(responses) <- c("Response", "Comments")
comments <- responses %>% select(Comments)
responses <- responses %>% select(Response)

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor(replace_na(as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, 
                                 "Yes, specific training is provided. If so, please specify:", 
                                 "No", 
                                 "I don't know", 
                                 "Unanswered")) %>%
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
  adorn_totals() %>%
  rename( "Yes" = "Yes, specific training is provided. If so, please specify:")

tab <- regulartable( df ) %>%
    colformat_num( na_str="0" ) %>% 
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q24.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q24.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q24.png" alt="question 24"> -->
<!-- </center><br> -->

## Presence of written arbovirus surveillance and control plans

> Do you have any written arbovirus surveillance and control plan(s) and/or guideline(s) for your country? (Question 6) 

```{r}

responses <- get_responses("6")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor(replace_na(as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, 
                                 "Yes, we have arbovirus-specific plans(s) or guidelines(s)", 
                                 "Yes. We do not have arbovirus-specific guidelines, but arboviruses are included within general surveillance guidelines.",
                                 "No", 
                                 "I don't know", 
                                 "Unanswered")) %>%
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
  mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
  adorn_totals()

tab <- regulartable( df ) %>%
    hline(i=4) # %>% autofit
    # width( j=2:3, width=2 ) 

tab

if( !file.exists("tables/q6.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q6.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q6.png" alt="question 6"> -->
<!-- </center><br> -->

## Arbovirus program: independent or integrated?

> Is there a specific national programme for arboviral diseases surveillance or is it integrated in another programme?  Please select the appropriate answer. (Question 7) 

```{r}

responses <- get_responses("7")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, 
                                 "Specific programme" , 
                                 "Integrated in another programme", 
                                 "No programme", 
                                 "I don't know", 
                                 "Unanswered")) %>% 
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>%
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q7.png") ){ 
  path <- save_as_image(tab, zoom=1, "tables/q7.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q7.png" alt="question 7"> -->
<!-- </center><br> -->

## Tools for case reporting

> What are the tools used for recording case data for surveillance purposes? Select all that apply. (Question 9) 

```{r}

responses <- get_responses("9")

df <- cbind(Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Level", values_to="Response") %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Électronic", "Mixed methods", "Paper-based", "Unanswered")) %>%
  group_by(Region, Level, Response) %>% 
  tally

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>% 
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    drop_na(Region) %>% 
    regulartable() %>% 
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=3*(1:4)) %>% 
    fix_border_issues() %>%
    width( j=2, width=2 ) # %>% autofit() 

tab

if( !file.exists("tables/q9.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/q9.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q9.png" alt="question 9"> -->
<!-- </center><br> -->

# **Laboratory diagnostic capacity indicators**

## Testing in outbreak vs non-outbreak settings

> Is arbovirus diagnostic laboratory testing performed for confirmation of suspected cases in your country? (Please select the applicable option during outbreak periods and  during non-outbreak periods, respectively) (Question 15) 

```{r}

responses <- get_responses("15")

df <- cbind( Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Training", values_to="Response") %>% 
  group_by(Region, Training, Response) %>% 
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n) %>% 
    drop_na(Region) %>% 
    regulartable %>% 
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=2*(1:4)) %>% 
    colformat_num( na_str = "0" ) %>%
    fix_border_issues %>%
    width( j=2, width=1) # %>% autofit 

tab

if( !file.exists("tables/q15.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q15.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q15.png" alt="question 15"> -->
<!-- </center><br> -->

## Laboratory tests available

> Overall, what arboviral testing capacity(ies) is(are) available in your country? Please check all applicable boxes. (Question 17) 

```{r} 
# fig.height=8}

responses <- get_responses("17")
df <- cbind( Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Testing", values_to="Response")
new_cols <- matrix( unlist( strsplit(df$Testing, "\\]\\[") ), ncol=2, byrow=T)
df <- df %>% 
  mutate(Arbovirus = new_cols[,1], Testing = new_cols[,2])
df$Response <- as.numeric( df$Response)
df <- df %>% 
  group_by(Region, Arbovirus, Testing) %>% 
  drop_na( Region ) %>% 
  summarize(Total = sum(Response, na.rm=T))
df$Arbovirus <- factor( df$Arbovirus )
df$Testing <- factor( df$Testing )

tab <- df %>% 
    pivot_wider(names_from=Testing, values_from=Total) %>% 
    regulartable %>% 
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=5*(1:4)) %>% 
    colformat_num( na_str = "0" ) %>%
    fix_border_issues # %>% autofit 

tab 

if( !file.exists("tables/q17.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q17.png")
}

# ggplot(df, aes(x=Testing, y=Total, fill=Testing)) + 
#   geom_col() + 
#   facet_grid( Region ~ Arbovirus ) + 
#   theme(legend.position = "bottom",
#         legend.direction="horizontal",
#         axis.title.x=element_blank(),
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank()) +
#   guides(fill = guide_legend(ncol = 2)) + 
#   scale_fill_manual(name = '',
#                     values = make_colors(length(unique(df$Testing))))

```

<!-- <center> -->
<!-- <img src="tables/q17.png" alt="question 17"> -->
<!-- </center><br> -->

## Serotyping and sequencing capacity 

> Do you perform virological surveillance on humans, i.e., tracking of prevailing genotypes/serotypes? Please select all that apply. (Question 19) 

```{r}

responses <- get_responses("19")
idx <- which( !grepl("Comment", names(responses)))
responses <- responses[idx]

df <- cbind( Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Testing", values_to="Response") %>%
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel( Response, "Yes", "Not selected", "Unanswered")) %>%
  mutate( Testing = recode_factor(Testing, 
                                  "Yes, using serological testing Please specify:" = "Yes, using serological testing",
                                  "Yes, using RT-PCR" = "Yes, using RT-PCR",
                                  "Yes, using virus isolation" = "Yes, using virus isolation",
                                  "Yes, using other acid nucleic tests Please specify:" = "Yes, using other acid nucleic tests",
                                  "No" = "No",
                                  "I don't know" = "I don't know")) %>%
  group_by(Region, Testing, Response) %>% 
  tally

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>% 
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    drop_na(Region) %>% 
    regulartable() %>% 
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=6*(1:4)) %>% 
    fix_border_issues() # %>% autofit
    # width( j=2, width=2 ) %>%

tab 

if( !file.exists("tables/q19.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q19.png")
}

# How should comments be reported? Comments specify testing methods.

```

<!-- <center> -->
<!-- <img src="tables/q19.png" alt="question 19"> -->
<!-- </center><br> -->

# **Response capacity indicators**

## Surveillance and control plans available

> Do you have any written arbovirus surveillance and control plan(s) and/or guideline(s) for your country? (Question 6) 

```{r}

responses <- get_responses("6")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor(replace_na(as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, 
                                 "Yes, we have arbovirus-specific plans(s) or guidelines(s)", 
                                 "Yes. We do not have arbovirus-specific guidelines, but arboviruses are included within general surveillance guidelines.",
                                 "No", 
                                 "I don't know", 
                                 "Unanswered")) %>%
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
  adorn_totals()

tab <- regulartable( df ) %>%
    colformat_num( na_str="0" ) %>%
    hline(i=4) # %>% autofit
    # width( j=2:3, width=1.5 ) %>%

tab

if( !file.exists("tables/q6.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q6.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q6.png" alt="question 6"> -->
<!-- </center><br> -->

## Clinical guidelines for healthcare workers 

> Does your country have clinical guidelines for healthcare workers on diagnosis and clinical management of cases and severe cases of _Aedes_-borne arboviral diseases? (Question 21) 

```{r}

responses <- get_responses("21")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "No", "I don't know", "Unanswered")) %>% 
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q21.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q21.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q21.png" alt="question 21"> -->
<!-- </center><br> -->

## Vector control method employed

> Over the past two years, did your country use any of the following vector control methods in local jurisdictions (either using government staff and resources, or subcontracting to a different entity to do so)? Please select all that apply. (Question 35) 

```{r}

responses <- get_responses("35")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other) 

df <- cbind( Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Method", values_to="Response") %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "Not selected", "Unanswered")) %>% 
  group_by(Region, Method, Response) %>% 
  tally

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>% 
    drop_na(Region) %>% 
    regulartable %>% 
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=6*(1:4)) %>% 
    colformat_num( na_str = "0" ) %>%
    fix_border_issues() # %>% autofit()

tab

if( !file.exists("tables/q35.png") ){ 
  path <- save_as_image(tab, zoom=1, "tables/q35.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q35.png" alt="question 35"> -->
<!-- </center><br> -->

## Surveillance and response committee exists

> Is there either a surveillance and outbreak response committee in your country, or a steering committee for that purpose? (Question 47) 

```{r}

responses <- get_responses("47")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "No", "I don't know", "Unanswered")) %>% 
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q47.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q47.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q47.png" alt="question 47"> -->
<!-- </center><br> -->

## Contingency plan exists

> Does your country have a contingency plan to organize healthcare services during an outbreak (including outbreaks of arboviral diseases)? (Question 48) 

```{r}

responses <- get_responses("48")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "No", "I don't know", "Unanswered")) %>% 
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q48.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q48.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q48.png" alt="question 48"> -->
<!-- </center><br> -->

## Most common vector control methods used

> Over the past two years, did your country use any of the following vector control methods in local jurisdictions (either using government staff and resources, or subcontracting to a different entity to do so)? Please select all that apply. (Question 35) 

```{r}

responses <- get_responses("35")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other) 

tab <- cbind( Region = data$Region, responses) %>% 
    pivot_longer(!Region, names_to="Method", values_to="Response") %>% 
    mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
    mutate( Response = fct_relevel(Response, "Yes", "Not selected", "Unanswered")) %>% 
    group_by(Region, Method, Response) %>% 
    tally %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>% 
    drop_na(Region) %>% 
    regulartable %>% 
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=6*(1:4)) %>% 
    colformat_num( na_str = "0" ) %>%
    fix_border_issues() # %>% autofit()

tab 

if( !file.exists("tables/q35.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q35.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q35.png" alt="question 35"> -->
<!-- </center><br> -->

## Indicators used for thresholds 

> For the last two years, did your country have a plan for mosquito-borne disease control that includes a threshold (e.g., level of vector mosquito abundance or minimum infection rate) that would result in a recommendation for mosquito adulticiding/other mosquito reduction measures? (Question 37) 

```{r}

responses <- get_responses("37")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = recode_factor(Response, 
                                 "Yes, have a threshold that requires concurrent human cases" = "Yes, have a threshold that requires concurrent human cases",
                                 "Yes, have a threshold that does not require concurrent human cases" = "Yes, have a threshold that does not require concurrent human cases",
                                  "No – have a plan but there is no specific threshold" = "No, have a plan but there is no specific threshold",
                                  "No – do not have a formal plan that includes adulticiding to control mosquito-borne diseases" = "No, do not have a formal plan that includes adulticiding to control mosquito-borne diseases",
                                 "Unanswered" = "Unanswered")) %>% 
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q37.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q37.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q37.png" alt="question 37"> -->
<!-- </center><br> -->

> Which indicator(s) is(are) used as threshold(s)? (Question 37b) 

```{r}

responses <- get_responses("37b") %>%
  select(-Other)

df <- cbind(Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Indicator", values_to="Response") %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "Not selected", "Unanswered")) %>%
  group_by(Region, Indicator, Response) %>% 
  tally

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>% 
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    drop_na(Region) %>% 
    regulartable() %>% 
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=6*(1:4)) %>% 
    fix_border_issues() # %>% autofit() 

tab

if( !file.exists("tables/q37b.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q37b.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q37b.png" alt="question 37b"> -->
<!-- </center><br> -->

> Overall, are data on any of the following arboviral outbreak risk factors routinely collected and analysed? (Select all that apply)  (Question 38) 

```{r}

responses <- get_responses("38") %>%
  select(-Other)

df <- cbind(Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Factor", values_to="Response") %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "Not selected", "Unanswered")) %>%
  mutate( Factor = fct_relevel(Factor,
                               "Breteau Index",
                               "Container Index",
                               "House Index",
                               "Migration of a non-immune population",
                               "Rainfall",
                               "Temperatures",
                               "None")) %>%
  group_by(Region, Factor, Response) %>% 
  tally


tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>% 
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    drop_na(Region) %>% 
    regulartable() %>% 
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=7*(1:4)) %>% 
    fix_border_issues() # %>% autofit
    # width( j=2, width=2 ) # %>% autofit() 

tab

if( !file.exists("tables/q38.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q38.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q38.png" alt="question 38"> -->
<!-- </center><br> -->

## Insecticide resistance 

> Is there a surveillance system in place for monitoring _Aedes_ resistance to the insecticide(s) used? (Question 39) 

```{r}

responses <- get_responses("39")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "No", "Don’t know", "Unanswered")) %>% 
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q39.png") ){ 
  path <- save_as_image(tab, zoom=1, "tables/q39.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q39.png" alt="question 39"> -->
<!-- </center><br> -->

## Criteria for declaring an outbreak

> Are there defined or established criteria for declaring an outbreak of arboviral disease outbreak in your country? (Question 49) 

```{r}

responses <- get_responses("49") %>%
  select(Response)

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = recode_factor(Response, 
                                   "Yes. If so, in the comments field, please briefly describe the criteria or reference the document in which those are sta" = "Yes", 
                                   "No" = "No", 
                                   "I don't know" = "I don't know", 
                                   "Unanswered" = "Unanswered" )) %>% 
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q49.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/q49.png")
}

# How should free text comments be reported??

```

<!-- <center> -->
<!-- <img src="tables/q49.png" alt="question 49"> -->
<!-- </center><br> -->

# **Epidemiologic risk data**

## Vectors present and level of risk 

> Is there a record of _Aedes aegypti_ or _Aedes albopictus_ being found in your country in the past 5 years? Please choose only one of the following (Question 34) 

```{r}

responses <- get_responses("34")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = recode_factor(Response, 
                                 "Yes, both Aedes aegypti and Aedes albopictus" = "Both Aedes aegypti and Aedes albopictus",
                                 "Yes, only Aedes aegypti" = "Only Aedes aegypti",
                                 "Yes, only Aedes albopictus" = "Only Aedes albopictus",
                                 "Unknown within the country at this time" = "Unknown at this time",
                                 "None found in the country at this time" = "None found at this time",
                                 "Unanswered" = "Unanswered")) %>% 
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort=TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q34.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q34.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q34.png" alt="question 34"> -->
<!-- </center><br> -->

> Please describe the potential public health threat from _Aedes aegypti_ in your country. (Question 34b) 

```{r}

responses <- get_responses("34b") %>%
  select(-Other) 

df <- data.frame(Region = data$Region, Response = responses$`Please choose only one of the following:`) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort=TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q34b.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/q34b.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q34b.png" alt="question 34b"> -->
<!-- </center><br> -->

> Please describe the potential public health threat from _Aedes albopictus_ in your country. (Question 34c) 

```{r}

responses <- get_responses("34c") %>%
  select(-Other) 

df <- data.frame(Region = data$Region, Response = responses$`Please choose only one of the following:`) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort=TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q34c.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/q34c.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q34c.png" alt="question 34c"> -->
<!-- </center><br> -->

## Entomological surveillance in the last 2 years

> For the last 2 years, did your country conduct entomologic surveillance for arboviral infections in mosquito vectors? (Question 28) 

```{r}

responses <- get_responses("28")

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "No", "Don't know", "Unanswered")) %>% 
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q28.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/q28.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q28.png" alt="question 28"> -->
<!-- </center><br> -->

## How often surveillance is conducted

> How often was the surveillance conducted? Please choose one of the following: (Question 28e) 

```{r}

responses <- get_responses("28e")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)

df <- data.frame(Region = data$Region, Response = responses$`How often`) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort = TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q28e.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/q28e.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q28e.png" alt="question 28e"> -->
<!-- </center><br> -->

> How often was the surveillance conducted? Free responses: (Question 28e)

```{r}

df <- data.frame(Region = data$Region, Other = other$Other) %>% 
  drop_na(Region) %>% 
  drop_na(Other) %>%
  group_by(Region, Other) %>%
  tally %>%
  select(Region, Other)

tab <- df %>% 
    # pivot_wider(names_from=Other, values_from=n, names_sort = TRUE) %>%
    # mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    # adorn_totals() %>%
    regulartable() %>%
    merge_v(j = ~Region) %>% 
    valign(j = 1, valign = "top", part = "all") %>% 
    hline(i=c(8,10,14)) %>% 
    fix_border_issues() # %>% autofit 

tab

if( !file.exists("tables/q28e_other.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q28e_other.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q28e_other.png" alt="question 28e_other"> -->
<!-- </center><br> -->

## Vectors recorded in the last 5 years and the public health threat

> Is there a record of _Aedes aegypti_ or _Aedes albopictus_ being found in your country in the past 5 years? Please choose only one of the following: (Question 34) 

```{r}

responses <- get_responses("34")
df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = recode_factor(Response, 
                                 "Yes, both Aedes aegypti and Aedes albopictus" = "Both Aedes aegypti and Aedes albopictus",
                                 "Yes, only Aedes aegypti" = "Only Aedes aegypti",
                                 "Yes, only Aedes albopictus" = "Only Aedes albopictus",
                                 "Unknown within the country at this time" = "Unknown at this time",
                                 "None found in the country at this time" = "None found at this time",
                                 "Unanswered" = "Unanswered")) %>% 
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort=TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q34.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/q34.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q34.png" alt="question 34"> -->
<!-- </center><br> -->

> Please describe the potential public health threat from _Aedes aegypti_ in your country. (Question 34b) 

```{r}

responses <- get_responses("34b") %>%
  select(-Other) 

df <- data.frame(Region = data$Region, Response = responses$`Please choose only one of the following:`) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort=TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q34b.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/q34b.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q34b.png" alt="question 34b"> -->
<!-- </center><br> -->

> Please describe the potential public health threat from _Aedes albopictus_ in your country. (Question 34c) 

```{r}

responses <- get_responses("34c") %>%
  select(-Other) 

df <- data.frame(Region = data$Region, Response = responses$`Please choose only one of the following:`) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  group_by(Region, Response) %>%
  tally 

tab <- df %>% 
    pivot_wider(names_from=Response, values_from=n, names_sort=TRUE) %>%
    mutate( across( everything(), ~ replace_na(.x, 0))) %>% 
    adorn_totals() %>%
    regulartable() %>%
    hline(i=4) # %>% autofit 

tab

if( !file.exists("tables/q34c.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/q34c.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q34c.png" alt="question 34c"> -->
<!-- </center><br> -->

## All arboviruses 2015-2020 (cases and deaths) 
  
> Please provide total number of cases and deaths for the following arboviral diseases from 2015 to 2020 (if available) (Question 55) 

```{r}
# fig.height = 12} 
# fig.width = 9.5}

responses <- get_responses("55")
col_names <- colnames(responses)
col_names <- matrix( unlist( strsplit(col_names, "\\]\\[") ), ncol=2, byrow=T)
col_names <- cbind( col_names[,1], matrix( unlist( strsplit(col_names[,2], " ") ), ncol=2, byrow=T))
ncountries <- length(data$SI01)
ncr <- ncol(responses)
df <- data.frame( Country=character(), Region=character(), Virus=character(), Year=character(), Type=character(), Number=numeric() )
for( i in 1:ncountries ){
  country <- rep( data$SI01[i], ncr)
  region <- rep( data$Region[i], ncr)
  df <- rbind( df, 
               data.frame(Country=country, 
                          Region=region,
                          Virus=col_names[,1], 
                          Year=col_names[,2],
                          Type=col_names[,3],
                          Number=as.numeric( t( responses[i,] ))))
}

df <- df %>% 
  drop_na(Number) %>%
  unite("Category", Year:Type, sep=" ") %>% 
  group_by(Region, Virus, Category) %>%
  summarize( Number = sum(Number)) %>%
  pivot_wider( names_from=Virus, values_from=Number)

tab <- df  %>% 
    filter( Region == "EMRO") %>%
    select(Category:Zika) %>% 
    regulartable() %>%
    merge_v(j = ~Region) %>%
    fix_border_issues() %>%
    autofit

tab

if( !file.exists("tables/emro55.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/emro55.png")
}

tab <- df  %>% 
    filter( Region == "EURO") %>%
    select(Category:Zika) %>% 
    regulartable() %>%
    merge_v(j = ~Region) %>%
    fix_border_issues() %>%
    autofit

tab

if( !file.exists("tables/euro55.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/euro55.png")
}

tab <- df  %>% 
    filter( Region == "SEARO") %>%
    select(Category:Zika) %>% 
    regulartable() %>%
    merge_v(j = ~Region) %>%
    fix_border_issues() %>%
    autofit

tab

if( !file.exists("tables/searo55.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/searo55.png")
}

tab <- df  %>% 
    filter( Region == "WPRO") %>%
    select(Category:Zika) %>% 
    regulartable() %>%
    merge_v(j = ~Region) %>%
    fix_border_issues() %>%
    autofit

tab

if( !file.exists("tables/wpro55.png") ){  
  path <- save_as_image(tab, zoom=1, "tables/wpro55.png")
}

# ggplot( df %>% 
#           filter(Country!="India") %>% 
#           filter(Type=="Cases") %>%
#           mutate(Country = gsub(" People's Democratic Republic", 's', Country)) %>%
#           mutate(Country = gsub('Herzegovina', 'Herz.', Country)) %>%
#           mutate(grp = paste0(Country, Virus)),
#         aes(x = Year,
#             y = Number,
#             color = Virus,
#             group = grp)) +
#           geom_line() +
#   geom_point() +
#   facet_wrap(~Country,
#              scales = 'free') +
#   theme(legend.position = 'bottom',
#         strip.background = element_blank()) +
#   scale_color_manual(name = '',
#                      values = make_colors(length(unique(df$Virus)))) +
#   theme(axis.text.x = element_text(angle = 90,
#                                    hjust = 0,
#                                    vjust = 0.5)) +
#   labs(title = 'Cases by year',
#        y = 'Cases')

```

<!-- <center> -->
<!-- <img src="tables/emro55.png" alt="question 55: EMRO"> -->
<!-- <img src="tables/euro55.png" alt="question 55: EURO"> -->
<!-- <img src="tables/searo55.png" alt="question 55: SEARO"> -->
<!-- <img src="tables/wpro55.png" alt="question 55: WPRO"> -->
<!-- </center><br> -->

```{r eval=FALSE}
#fig.height = 12}
#fig.width = 9.5}

ggplot( df %>% 
          filter(Country!="India") %>% 
          filter(Type=="Deaths") %>%
          mutate(Country = gsub(" People's Democratic Republic", 's', Country)) %>%
          mutate(Country = gsub('Herzegovina', 'Herz.', Country)) %>%
          mutate(grp = paste0(Country, Virus)),
        aes(x = Year,
            y = Number,
            color = Virus,
            group = grp)) +
          geom_line() +
  geom_point() +
  facet_wrap(~Country,
             scales = 'free') +
  theme(legend.position = 'bottom',
        strip.background = element_blank()) +
  scale_color_manual(name = '',
                     values = make_colors(length(unique(df$Virus)))) +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 0,
                                   vjust = 0.5)) +
  labs(title = 'Deaths by year',
       y = 'Deaths')

```

> Were cases of other mosquito-borne arboviruses, not listed in the previous question, reported in your country from 2015-2020? (Question 55b) 

```{r}

responses <- get_responses("55b")
# df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
# pander( table( df %>% group_by(Region), useNA="ifany" ) )
# pander( table(responses, useNA="ifany"))

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "No", "I don't know", "Unanswered")) %>% 
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n, names_sort=TRUE) %>%
  adorn_totals()

tab <- regulartable( df ) %>%
    colformat_num( na_str="0" ) %>%
    hline(i=4) # %>% autofit

tab

if( !file.exists("tables/q55b.png") ){
  path <- save_as_image(tab, zoom=1, "tables/q55b.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q55b.png" alt="question 55b"> -->
<!-- </center><br> -->

> Please select any of the following other mosquito-borne viruses that have been reported in your country from 2015-2020. (Question 55c)

```{r}

responses <- get_responses("55c")
df <- cbind( Region = data$Region, responses )
df <- df %>%
  pivot_longer(!Region, names_to="Arbovirus", values_to="Response") %>%
  filter(Response=="Yes") %>%
  droplevels() %>% 
  group_by( Region, Arbovirus ) %>% 
  tally

tab <- regulartable( df ) %>% 
    merge_v(j = ~Region) %>% 
    hline( i = c(1,7)) %>%
    autofit() 

tab

if( !file.exists("tables/q55c.png")){ 
  path <- save_as_image(tab, zoom=1, "tables/q55c.png")
}

```

<!-- <center> -->
<!-- <img src="tables/q55c.png" alt="question 55c"> -->
<!-- </center><br> -->

## Most recent year data 

> Please provide the number of cases of locally acquired, mosquito-borne Aedes-borne arbovirus infections by case classification for 2020 and, if not available, for 2019. (Question 56) 

```{r}
# fig.height = 12} 
# fig.width = 9.5}

responses <- get_responses("56")
col_names <- colnames(responses)
col_names <- matrix( unlist( strsplit(col_names, "\\]\\[") ), ncol=2, byrow=T)
ncountries <- length(data$SI01)
ncr <- ncol(responses)
df <- data.frame( Country=character(), 
                  Region=character(),
                  Virus=character(), 
                  Type=character(), 
                  Number=numeric() )
for( i in 1:ncountries ){
  country <- rep( data$SI01[i], ncr)
  region <- rep( data$Region[i], ncr)
  df <- rbind( df, 
               data.frame(Country=country, 
                          Region=region,
                          Virus=col_names[,1], 
                          Type=col_names[,2],
                          Number=as.numeric( t( responses[i,] ))))
}

df <- df %>% 
  drop_na(Number) %>%
  group_by(Region, Virus, Type) %>%
  summarize( Number = sum(Number)) %>%
  pivot_wider( names_from=Virus, values_from=Number)

tab <- regulartable( df ) %>% 
    merge_v(j = ~Region) %>% 
    hline( i = 4*(1:4)) %>%
    fix_border_issues() %>%
    autofit() 

tab

if( !file.exists("tables/q56.png")){ 
  path <- save_as_image(tab, zoom=1, "tables/q56.png")
}

# ggplot( df,
#         aes( x=reorder(Country, desc(Country)), y=Number, fill=Type)) +
#   geom_col( position="dodge" ) + 
#   coord_flip() + 
#   labs( title = "Cases by Virus") + 
#   facet_wrap(~Virus) +
#   labs(x = 'Country') +
#   scale_fill_manual(name = '',
#                     values = make_colors(length(unique(df$Type))))

# To do:
# - Clean up free text responses to questions 5 and 10
# - The comments from those who responded "Yes" to question 24 need to be added

```

<!-- <center> -->
<!-- <img src="tables/q56.png" alt="question 56"> -->
<!-- </center><br> -->

<!-- Comments:  -->

<!-- - India is not shown, as India's case/death counts are an order of magnitude larger than other countries'. -->

<!-- # Missingness analysis  -->

<!-- ## Missing questions  -->

```{r eval=FALSE}

# Handling special questions tediously seems unavoidable, hence some of the ghastly code below! 

idx <- c( which( is.na( dict$`Question number` )),
          which( grepl('upload', dict$`Type of variable`)),
          which ( grepl('filecount', dict$`Question number`) ))
all_questions <- dict$`Question number`[-idx]
idx <- which( all_questions == "1" )
all_questions <- unique( all_questions[ idx:length( all_questions )] )
n_questions <- length( all_questions )

# questions that only appear when triggered:
special_questions <- c("6b","7b","11b","11c","12b","12c","28c","28d","28e","34b","34c","35b","37b","41b","41c","42b","43b","43c","43d","43e","55c","55d")
idx <- which( all_questions %in% special_questions )
standard_questions <- all_questions[-idx]

type <- rep("standard", n_questions )
type[ which( all_questions %in% special_questions ) ] <- "special"
status <- ifelse( type == "standard", "answered", "not shown")

n_countries <- length( data$SI01 )
summary <- data.frame( Country = rep( data$SI01, rep(n_questions, n_countries )), # country name
                      Question = rep( all_questions, n_countries ), # question name
                      Type = rep( type, n_countries ), # standard or special
                      Status = rep( status, n_countries) # answered, skipped, or not shown
                      ) 

update_special <- function( country_idx, question ){
  idx <- which( dict$`Question number` == question )
  summary_idx <-  offset + which( all_questions == question )
  if( all( is.na( data[country_idx, idx] ))){
    summary$Status[ summary_idx ] <- "skipped"
  } else{
    summary$Status[ summary_idx ] <- "answered"
  }
}

for(i in 1:nrow(data)){

  country <- data$SI01[i]
  offset <- n_questions>(i-1)
  missing <- character()

  if( !is.na(country) ){
    
    for(j in 1:length(standard_questions)){
      question <- standard_questions[j] 
      idx <- which( dict$`Question number` == question )
      if( all( is.na( data[i, idx] ) ) ){
        summary_idx <-  offset + which( all_questions == question )
        summary$Status[ summary_idx ] <- "skipped"
        missing <- c( missing, question )
      } else { 
        
        if( question == 6 ){
          # either Yes option triggers 6b
          if( data[i,idx] %in% levels( data[,idx] )[1:2] ){
            update_special(i, "6b")
          }
        }
        
        if( question == 7 ){
          # choosing "Integrated in another programme" triggers 7b, other choices do not
          if( data[i,idx] == levels( data[,idx] )[2] ){
            update_special(i, "7b")
          }
        }
        
        if( question == 11 ){
          # answering Yes triggers 11b, No does not
          if( data[i,idx] == levels( data[,idx] )[1] ){
            subidx <- which( dict$`Question number` == "11b" )
            summary_idx <-  offset + which( all_questions == "11b" )
            if( all( is.na( data[i, subidx] ))){
              summary$Status[ summary_idx ] <- "skipped"
              missing <- c( missing, "11b" )
            } else{
              summary$Status[ summary_idx ] <- "answered"
              if( !is.na( data[i, subidx[ length(subidx)]] ) ){
                summary_idx <-  offset + which( all_questions == "11c" )
                subidx <- which( dict$`Question number` == "11c" )
                if( all( is.na( data[i, subidx] ))){
                  summary$Status[ summary_idx ] <- "skipped"
                  missing <- c( missing, "11c" )
                } else{
                  summary$Status[ summary_idx ] <- "answered"
                }
              }
            }
          }
        } 
        
        if( question == 12 ){
          # Yes triggers 12b, 12c, and 12d (file upload)
          if( data[i,idx] == levels( data[,idx] )[1] ){
            update_special(i, "12b")
            update_special(i, "12c")
          }
        } 
        
        if( question == 28 ){
          # choosing Yes triggers 28b (file upload), 28c, 28d, 28e
          if( data[i,idx] == levels( data[,idx] )[1] ){
            update_special(i, "28c")
            update_special(i, "28d")
            update_special(i, "28e")
          }
        } 
        
        if( question == 34 ){
          # Yes, only Aedes aegypti triggers 34b
          if( data[i,idx] == levels( data[,idx] )[1] ){
            update_special(i, "34b")
          } 
          # Yes, only Aedes albopictus triggers 34c
          if( data[i,idx] == levels( data[,idx] )[2] ){
            update_special(i, "34c")
          }
          # Yes, both triggers both 34b and 34c
          if( data[i,idx] == levels( data[,idx] )[3] ){
            update_special(i, "34b")
            update_special(i, "34c")
          }
        } 
        
        if( question == 35 ){
          # choosing None triggers 35b
          if( !is.na(data[i, idx[6]]) & data[i, idx[6]] == "Yes"){
            update_special(i, "35b")
          }
        } 
        
        if( question == 37 ){
          # choosing "Yes, have a threshold that does not require concurrent human cases"
          # triggers 37b ; no other choice does
          if( data[i,idx] == levels( data[,idx] )[1] ){
            update_special(i, "37b")
          }
        } 
        
        if( question == 41 ){
          # choosing "Yes" triggers 41b, 41c, 41d (file upload)
          if( data[i,idx] == levels( data[,idx] )[1] ){
            update_special(i, "41b")
            update_special(i, "41c")
          }
        } 
        
        if( question == 42 ){
          # choosing "Yes" triggers 42b, 42c (file upload)
          if( data[i,idx] == levels( data[,idx] )[1] ){
            update_special(i, "42b")
          }
        } 
        
        if( question == 43 ){
          # choosing "Yes" triggers 43b, 43c, 43d, 43e
          if( data[i,idx] == levels( data[,idx] )[1] ){
            update_special(i, "43b")
            update_special(i, "43c")
            update_special(i, "43d")
            update_special(i, "43e")
          }
        } 
        
        if( question == "55b" ){
          # answering "Yes" to 55b triggers 55c and 55d
          if( data[i,idx] == levels( data[,idx] )[1] ){
            update_special(i, "55c")
            update_special(i, "55d")
          }
        }
      }
    }
  }
}

count_by_country <- summary %>% 
  group_by(Country,Status) %>% 
  tally( name="Number skipped") %>% 
  filter(Status=="skipped") %>% 
  select(-Status)

list_by_country <- summary %>% 
  group_by(Country,Question) %>% 
  filter(Status=="skipped") %>%
  select(Country,Question) %>% 
  pivot_wider(names_from=Country, 
              values_from=Question, 
              values_fn=list) 

countries <- names( list_by_country)
skipped <- character( length = length(countries))

for(i in 1:length(countries)){
  country <- countries[i]
  skipped[i] <- paste( list_by_country[[country]][[1]], collapse = ", ")
}

df <- data.frame( Country = countries, Skipped = skipped ) %>% 
  arrange( Country ) %>%
  rename("Skipped question(s)" = Skipped)
df <- inner_join( count_by_country, df, by="Country")
regulartable( df ) %>%
  align(align="center", part="header") %>%
  align(j=2, align="center") %>% 
  width( j=3, width=3 ) %>%
  hline # %>%
  # autofit

```
