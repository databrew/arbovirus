---
title: "WHO Global Arbovirus Survey"
author: "Data integrity report"
date: "`r format(Sys.time(), '%Y %B %d')`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE, echo = FALSE}
# Basic knitr options
library(knitr)
opts_chunk$set(comment = NA, 
               echo = FALSE,
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
               fig.width = 9.64,
               fig.height = 5.9,
               fig.path = 'figures/')
options(scipen = '999')
```

# Data structure and quantity

```{r}

library(tidyverse)
library(readxl)
library(flextable)
library(stringr)
library(pander)
library(RColorBrewer)
library( janitor )
make_colors <- function(n, seed = 123){
  pal <- RColorBrewer::brewer.pal(n = 9, name = 'Set1')
  set.seed(seed)
  pal <- sample(pal, length(pal))
  out <- colorRampPalette(pal)(n)
  return(out)
}
ggplot2::theme_set(theme_bw())

# get the survey results: processed by WHO script (lightly edited),
# then WHO regions added

if( file.exists("data/data.RData" )){
  load("data/data.RData")
} else{
  source("misc/survey_375147_R_syntax_file.R")
  n_countries <- length( data$SI01 )
  who_regions <- read_excel("data/Regions_Countries.xlsx")
  region <- character( length=n_countries )
  for(i in 1:n_countries){
    idx <- which( who_regions$Country == data$SI01[i] )
    if( length(idx) > 0 ){
      region[i] <- who_regions$Region[idx]
    } else{
      region[i] <- NA
    }
  }
  data <- data %>% mutate( Region = factor(region), .after=SI01 )
  save(data, file="data/data.RData")
}

# load data dictionary to facilitate processing survey results:
dict <- read_csv("misc/Data_dictionary_Survey375147.csv")

# utility function 
get_responses <- function( question_number ){
  idx <- which( dict$`Question number` == question_number )
  # question <- dict$Description[ idx[1] ]
  # cat( paste("Question", question_number, ":", question) )
  var_names <- dict$`Variable name`[idx]
  responses <- data %>% select( all_of(var_names) )
  if( !is.na(dict$Subquestion[ idx[1] ]) ){
    # remove square brackets at beginning and end, then rename:
    colnames( responses ) <- str_extract( dict$Subquestion[idx], '(?<=\\[)[^{}]+(?=\\])')
    # replace square brackets with spaces, then trim whitespace:
    # colnames( responses ) <- trimws( gsub("\\[|\\]", " ",dict$Subquestion[idx]), which="both")
  } else{
    colnames( responses ) <- "Response"
  }
  return( responses )
}

```

## Number of submissions

There are `r nrow(data)` rows ; there are `r length(unique(data$SI01))` unique countries. Repeated countries:
```{r echo=FALSE, message=FALSE}
idx <- which( duplicated( data$SI01 ) )
pander( as.vector(unique( data$SI01[idx] ) ) )
```

```{r}
pd <- data %>%
  group_by(Country = SI01) %>%
  tally %>%
  arrange(desc(n)) %>%
  filter(n >= 2) %>%
  bind_rows(
    tibble(Country = 'Others',
           n = 1)
  )
pd$Country <- factor(pd$Country,
                     levels = pd$Country)

ggplot(data = pd,
       aes(x = Country,
           y = n)) +
  geom_bar(stat = 'identity') +
  geom_text(aes(label = n),
            nudge_y = -0.2,
            color = 'white',
            size = 7) +
  labs(y = 'Entries',
       title = 'Survey entries per country')
```

# Data content

## Surveillance capacity indicators

### Reportable arboviral diseases

**Question 11** :  Is reporting mandatory for any arboviral disease cases in your country? 

```{r}

# relevant question: q11

responses <- get_responses("11")
df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n) %>%
  adorn_totals() 
regulartable(df) %>%
  colformat_num(na_str="-") %>%
  hline(i=4) %>%
  autofit()

# pander( table( df %>% group_by(Region), useNA="ifany" ) )

```

**Question 11b** : For which of the following arboviral disease cases is reporting mandatory in your country?

```{r}

# relevant question: q11b

responses <- get_responses("11b")
df <- cbind(Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Arbovirus", values_to="Response") %>% 
  group_by(Region, Arbovirus, Response) %>% 
  tally
tab <- df %>% 
  pivot_wider(names_from=Response, values_from=n) %>% 
  drop_na(Region)
colnames(tab) <- str_to_sentence(gsub("Mandatory reporting of ", "", colnames(tab)))
tab <- tab %>% 
  relocate("Confirmed cases only", .after="All suspect cases") %>%
  rename("No answer"=Na)
tab %>% 
  regulartable %>% 
  merge_v(j = ~Region) %>% 
  valign(j = 1, valign = "top", part = "all") %>% 
  hline(i=6*(1:4)) %>% 
  colformat_num(na_str = "-") %>%
  fix_border_issues() %>%
  autofit()

ggplot(df, aes(x=Response, y=n, fill=Response)) + 
  geom_col() + 
  facet_wrap(~Arbovirus) +
  theme(legend.position = "bottom",
        legend.direction="horizontal",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  guides(fill=guide_legend(ncol=2)) +
  scale_fill_manual(name = '',
                    values = make_colors(length(unique(df$Response)))) +
  labs(y = 'Responses')

```


###  History of any arbovirus circulation since 2000 

**Question 5** :  Which arboviruses have circulated in your country at any time since the year 2000?  This refers only to arboviruses with autochthonous i.e., local mosquito-borne transmission

```{r}

# relevant question: q5

responses <- get_responses("5")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
df <- cbind( Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Arbovirus", values_to="Response") %>% 
  group_by(Region, Arbovirus, Response) %>% 
  tally
df %>% 
  pivot_wider( names_from=Response, values_from=n) %>% 
  drop_na(Region) %>% 
  regulartable %>% 
  merge_v(j = ~Region) %>% 
  valign(j = 1, valign = "top", part = "all") %>% 
  hline(i=4*(1:4)) %>% 
  colformat_num( na_str = "-" ) %>%
  fix_border_issues() %>%
  autofit()

# knitr::kable( table(other))

ggplot(data = df %>% filter(Response == 'Yes'),
       aes(x = Arbovirus)) +
  geom_bar() +
  labs(y = 'Entries')

```


###  Conducting surveillance on humans,  vectors, and animals

**Question 12** :  In the last 2 years, did your country conduct national epidemiological surveillance for human cases of arboviral disease? 

```{r}

# relevant question: q12 (surveillance on humans)

responses <- get_responses("12")
df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n) %>%
  adorn_totals()
regulartable( df ) %>%
  colformat_num( na_str="-" ) %>%
  hline(i=4) %>%
  autofit()

```

**Question 28** : For the last 2 years, did your country conduct entomologic surveillance for arboviral infections in mosquito vectors?

```{r}
# relevant question: q28 (surveillance on vectors)

responses <- get_responses("28")
df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n) %>%
  adorn_totals()
regulartable( df ) %>%
  colformat_num( na_str="-" ) %>%
  hline(i=4) %>% 
  autofit()

```

**Question 41** : During the last 2 years, did your country conduct national epidemiological surveillance for arboviral disease in animals (eg, epizootic surveillance for yellow fever in endemic areas)?

```{r}

# relevant question: q41 (surveillance on animals)

responses <- get_responses("41")
df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n) %>%
  adorn_totals()
regulartable( df ) %>%
  colformat_num( na_str="-" ) %>%
  hline(i=4) %>% 
  autofit()

```

### Training of surveillance personnel and clinicians?

**Question 10** : Which training has been provided to the staff working on arboviral disease surveillance data

```{r}

# relevant question: q10 

responses <- get_responses("10")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
df <- cbind( Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Training", values_to="Response") %>% 
  group_by(Region, Training, Response) %>% 
  tally
df %>% 
  pivot_wider( names_from=Response, values_from=n) %>% 
  drop_na(Region) %>% 
  regulartable %>% 
  merge_v(j = ~Region) %>% 
  valign(j = 1, valign = "top", part = "all") %>% 
  hline(i=5*(1:4)) %>% 
  colformat_num( na_str = "-" ) %>%
  fix_border_issues() %>%
  autofit()

```


**Question 24** : Does your country provide regular training sessions for healthcare workers on clinical diagnosis and management of Aedes-borne arboviral diseases?

**The comments from those who responded "Yes" need to be added!**

```{r}
# relevant question: q24

responses <- get_responses("24")
colnames(responses) <- c("Response", "Comments")
comments <- responses %>% select(Comments)
responses <- responses %>% select(Response)
df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n) %>%
  adorn_totals() 
colnames(df)[2] <- "Yes"
regulartable( df ) %>%
  colformat_num( na_str="-" ) %>% 
  hline(i=4) %>%
  autofit()

```


# Laboratory diagnostic capacity indicators

### Testing in outbreak vs non-outbreak settings

**Question 15** : Is arbovirus diagnostic laboratory testing performed for confirmation of suspected cases in your country? (Please select the applicable option during outbreak periods and  during non-outbreak periods, respectively)   

```{r}

# relevant question: q15

responses <- get_responses("15")

df <- cbind( Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Training", values_to="Response") %>% 
  group_by(Region, Training, Response) %>% 
  tally 
df %>% 
  pivot_wider(names_from=Response, values_from=n) %>% 
  drop_na(Region) %>% 
  regulartable %>% 
  merge_v(j = ~Region) %>% 
  valign(j = 1, valign = "top", part = "all") %>% 
  hline(i=8) %>% 
  colformat_num( na_str = "-" ) %>%
  fix_border_issues() %>%
  autofit()

```

### Laboratory tests available

**Question 17** :  Overall, what arboviral testing capacity(ies) is(are) available in your country? Please check all applicable boxes

```{r}

# relevant question: q17

responses <- get_responses("17")
df <- cbind( Region = data$Region, responses) %>% 
  pivot_longer(!Region, names_to="Testing", values_to="Response")
new_cols <- matrix( unlist( strsplit(df$Testing, "\\]\\[") ), ncol=2, byrow=T)
df <- df %>% 
  mutate(Arbovirus = new_cols[,1], Testing = new_cols[,2])
df$Response <- as.numeric( df$Response)
df <- df %>% 
  group_by(Region, Arbovirus, Testing) %>% 
  summarize(Total = sum(Response, na.rm=T))
df$Arbovirus <- factor( df$Arbovirus )
df$Testing <- factor( df$Testing )

df %>% 
  pivot_wider(names_from=Testing, values_from=Total) %>% 
  drop_na(Region) %>% 
  regulartable %>% 
  merge_v(j = ~Region) %>% 
  valign(j = 1, valign = "top", part = "all") %>% 
  #hline(i=8) %>% 
  colformat_num( na_str = "-" ) %>%
  fix_border_issues() %>%
  autofit()

# mat <- matrix( data=df$Total, ncol=length(levels(df$Arbovirus)), byrow=F)
# colnames( mat ) <- levels( df$Arbovirus )
# rownames( mat ) <- levels( df$Testing )
# knitr::kable( mat )

ggplot(df, aes(x=Testing, y=Total, fill=Testing)) + 
  geom_col() + 
  facet_wrap(~Arbovirus) + 
  theme(legend.position = "bottom",
        legend.direction="horizontal",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  scale_fill_manual(name = '',
                    values = make_colors(length(unique(df$Testing))))

```

# Response capacity indicators

### Surveillance and control plans available

**Question 6** : Do you have any written arbovirus surveillance and control plan(s) and/or guideline(s) for your country?

```{r}

# relevant question: q6

responses <- get_responses("6")
# df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
# knitr::kable( table( df %>% group_by(Region), useNA="ifany" ) )
# knitr::kable( table(responses, useNA="ifany"))

df <- data.frame(Region = data$Region, Response = responses) %>% 
  drop_na(Region) %>% 
  group_by(Region, Response) %>% 
  tally %>% 
  pivot_wider(names_from=Response, values_from=n) %>%
  adorn_totals()
regulartable( df ) %>%
  colformat_num( na_str="-" ) %>%
  hline(i=4) %>% 
  autofit()

```

### Vector control method employed

**Question 35** : Over the past two years, did your country use any of the following vector control methods in local jurisdictions (either using government staff and resources, or subcontracting to a different entity to do so)? Please select all that apply

```{r}

# relevant question: q35

responses <- get_responses("35")
other <- responses %>% select(Other)
df <- responses %>% 
  select(-Other) %>%
  pivot_longer(cols=colnames(responses)[1:5], names_to="Method", values_to="Response")

knitr::kable( table(df$Method, df$Response, useNA="ifany"))

```

###   Surveillance and response committee exists

**Question 47** : Is there either a surveillance and outbreak response committee in your country, or a steering committee for that purpose?

```{r}

# relevant question: q47

responses <- get_responses("47")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
pander( table( df %>% group_by(Region), useNA="ifany" ) )
# pander( table(responses, useNA="ifany"))

```

###  Contingency plan exists

**Question 48** : Does your country have a contingency plan to organize healthcare services during an outbreak (including outbreaks of arboviral diseases)?

```{r}

# relevant question: q48

responses <- get_responses("48")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
pander( table( df %>% group_by(Region), useNA="ifany" ) )
# pander( table(responses, useNA="ifany"))

```

# Epidemiologic risk data

### Vectors present and level of risk (q34, q34b, q34c)

**Question 34** :  Is there a record of Aedes aegypti or Aedes albopictus being found in your country in the past 5 years? Please choose only one of the following

```{r}

# relevant question: q34

responses <- get_responses("34")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
knitr::kable( table( df %>% group_by(Region), useNA="ifany" ) )
# knitr::kable( table(responses, useNA="ifany"))

```

**Question 34b** :  Please describe the potential public health threat from Aedes aegypti in your country

```{r}

# relevant question: q34b

responses <- get_responses("34b")
colnames(responses) <- c("Selection", "Other")

knitr::kable( table(responses$Selection, useNA="ifany"))
knitr::kable( table(responses$Other, useNA="ifany"))

```

**Question 34c** :  Please describe the potential public health threat from Aedes albopictus in your country

```{r}

# relevant question: q34c

responses <- get_responses("34c")
colnames(responses) <- c("Selection", "Other")
knitr::kable( table(responses$Selection, useNA="ifany"))
knitr::kable( table(responses$Other, useNA="ifany"))

```


### All arboviruses 2015-2020 (cases and deaths) 

**Question 55** :  Please provide total number of cases and deaths for the following arboviral diseases from 2015 to 2020 (if available)

```{r, fig.height = 12}

# relevant question: q55

responses <- get_responses("55")
col_names <- colnames(responses)
col_names <- matrix( unlist( strsplit(col_names, "\\]\\[") ), ncol=2, byrow=T)
col_names <- cbind( col_names[,1], matrix( unlist( strsplit(col_names[,2], " ") ), ncol=2, byrow=T))
ncountries <- length(data$SI01)
ncr <- ncol(responses)
df <- data.frame( Country=character(), Virus=character(), Year=character(), Type=character(), Number=numeric() )
for( i in 1:ncountries ){
  country <- rep( data$SI01[i], ncr)
  df <- rbind( df, 
               data.frame(Country=country, 
                          Virus=col_names[,1], 
                          Year=col_names[,2],
                          Type=col_names[,3],
                          Number=as.numeric( t( responses[i,] ))))
}

df <- df %>% drop_na(Number)



ggplot( df %>% 
          filter(Country!="India") %>% 
          filter(Type=="Cases") %>%
          mutate(Country = gsub(" People's Democratic Republic", 's', Country)) %>%
          mutate(Country = gsub('Herzegovina', 'Herz.', Country)) %>%
          mutate(grp = paste0(Country, Virus)),
        aes(x = Year,
            y = Number,
            color = Virus,
            group = grp)) +
          geom_line() +
  geom_point() +
  facet_wrap(~Country,
             scales = 'free') +
  theme(legend.position = 'bottom',
        strip.background = element_blank()) +
  scale_color_manual(name = '',
                     values = make_colors(length(unique(df$Virus)))) +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 0,
                                   vjust = 0.5)) +
  labs(title = 'Cases by year',
       y = 'Cases')
```

```{r, fig.height = 12}
ggplot( df %>% 
          filter(Country!="India") %>% 
          filter(Type=="Deaths") %>%
          mutate(Country = gsub(" People's Democratic Republic", 's', Country)) %>%
          mutate(Country = gsub('Herzegovina', 'Herz.', Country)) %>%
          mutate(grp = paste0(Country, Virus)),
        aes(x = Year,
            y = Number,
            color = Virus,
            group = grp)) +
          geom_line() +
  geom_point() +
  facet_wrap(~Country,
             scales = 'free') +
  theme(legend.position = 'bottom',
        strip.background = element_blank()) +
  scale_color_manual(name = '',
                     values = make_colors(length(unique(df$Virus)))) +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 0,
                                   vjust = 0.5)) +
  labs(title = 'Deaths by year',
       y = 'Deaths')
```


**Question 55b** : Were cases of other mosquito-borne arboviruses, not listed in the previous question, reported in your country from 2015-2020?

```{r}

# relevant question: q55b

responses <- get_responses("55b")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
pander( table( df %>% group_by(Region), useNA="ifany" ) )
# pander( table(responses, useNA="ifany"))

```

**Question 55c** : Please select any of the following other mosquito-borne viruses that have been reported in your country from 2015-2020

```{r}

# relevant question: q55c

responses <- get_responses("55c")
df <- responses %>%
  pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response") %>%
  filter(Response=="Yes") %>%
  droplevels()
pander( table( df$Arbovirus, df$Response, useNA="ifany") )

```

### Most recent year data 

**Question 56** : Please provide the number of cases of locally acquired, mosquito-borne Aedes-borne arbovirus infections by case classification for 2020 and, if not available, for 2019

```{r, fig.height = 12}

# relevant question: q56

responses <- get_responses("56")
col_names <- colnames(responses)
col_names <- matrix( unlist( strsplit(col_names, "\\]\\[") ), ncol=2, byrow=T)
ncountries <- length(data$SI01)
ncr <- ncol(responses)
df <- data.frame( Country=character(), Virus=character(), Type=character(), Number=numeric() )
for( i in 1:ncountries ){
  country <- rep( data$SI01[i], ncr)
  df <- rbind( df, 
               data.frame(Country=country, 
                          Virus=col_names[,1], 
                          Type=col_names[,2],
                          Number=as.numeric( t( responses[i,] ))))
}

df <- df %>% drop_na(Number)

ggplot( df,
        aes( x=reorder(Country, desc(Country)), y=Number, fill=Type)) +
  geom_col( position="dodge" ) + 
  coord_flip() + 
  labs( title = "Cases by Virus") + 
  facet_wrap(~Virus) +
  labs(x = 'Country') +
  scale_fill_manual(name = '',
                    values = make_colors(length(unique(df$Type))))
```


Comments: 

- India is not shown, as India's case/death counts are an order of magnitude larger than other countries'.


To do:

- Clean up free text responses to questions 5 and 10