---
title: "WHO Global Arbovirus Survey"
author: "Data integrity report"
date: "`r format(Sys.time(), '%Y %B %d')`"
output: html_document
---


```{r setup, include=FALSE, echo = FALSE}
# Basic knitr options
library(knitr)
opts_chunk$set(comment = NA, 
               echo = FALSE,
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
               fig.width = 9.64,
               fig.height = 5.9,
               fig.path = 'figures/')
```

# Data structure and quantity

```{r echo=FALSE, message=FALSE}

library(tidyverse)
library(stringr)
library(pander)
ggplot2::theme_set(theme_bw())

# get the survey results, as processed by WHO script (lightly edited) :

if( file.exists("data/data.RData" )){
  load("data/data.RData")
} else{
  setwd("misc/")
  source("survey_375147_R_syntax_file.R")
  setwd("../data")
  save(data, file="data.RData")
  setwd("../")
}

# whoa this prints a lot of stuff...
# summary(data)

# load data dictionary to facilitate processing survey results:
dict <- read_csv("misc/Data_dictionary_Survey375147.csv")

# utility function 
get_responses <- function( question_number ){
  idx <- which( dict$`Question number` == question_number )
  question <- dict$Description[ idx[1] ]
  cat( paste("Question", question_number, ":", question, "\n") )
  var_names <- dict$`Variable name`[idx]
  responses <- data %>% select( all_of(var_names) )
  if( !is.na(dict$Subquestion[ idx[1] ]) ){
    # remove square brackets, then rename:
    colnames( responses ) <- str_extract( dict$Subquestion[idx], '(?<=\\[)[^{}]+(?=\\])')
  }
  return( responses )
}

# Check data against specifications in data dictionary? 
# Or is provided script sufficient? Investigate!
```

## Number of submissions

There are `r nrow(data)` rows ; there are `r length(unique(data$SI01))` unique countries. Repeated countries:
```{r echo=FALSE, message=FALSE}
idx <- which( duplicated( data$SI01 ) )
pander( as.vector(unique( data$SI01[idx] ) ) )
```

```{r}
pd <- data %>%
  group_by(Country = SI01) %>%
  tally %>%
  arrange(desc(n)) %>%
  filter(n >= 2) %>%
  bind_rows(
    tibble(Country = 'Others',
           n = 1)
  )
pd$Country <- factor(pd$Country,
                     levels = pd$Country)

ggplot(data = pd,
       aes(x = Country,
           y = n)) +
  geom_bar(stat = 'identity') +
  geom_text(aes(label = n),
            nudge_y = -0.2,
            color = 'white',
            size = 7) +
  labs(y = 'Entries',
       title = 'Survey entries per country')
```


# Data content

## Surveillance capacity indicators

### Reportable arboviral diseases

```{r echo=FALSE, message=FALSE}

# relevant questions: q11, q11b

responses <- get_responses("11")
pander( table( responses, useNA="ifany" ))

responses <- get_responses("11b")
# summary( responses )
tallies <- responses %>% 
  pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response")
knitr::kable( table( tallies$Arbovirus, tallies$Response, useNA="ifany") )
tallies <- tallies %>% 
  group_by(Arbovirus, Response) %>% 
  tally
ggplot(tallies, aes(x=Response, y=n, fill=Response)) + 
  geom_col() + 
  facet_wrap(~Arbovirus) +
  theme(legend.position = "bottom",
        legend.direction="vertical",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```


###  History of any arbovirus circulation since 2000 

```{r echo=FALSE, message=FALSE}

# relevant question: q5

responses <- get_responses("5")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
tallies <- responses %>% 
  pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response")
pander( table( tallies$Arbovirus, tallies$Response, useNA="ifany") )

# knitr::kable( table(other))

```

To do:

- The free text responses to `Other` need to be cleaned!!
- Barplot instead of / in addition to tabular summary?

###  Conducting surveillance on humans,  vectors, and animals

```{r echo=FALSE, message=FALSE}

# relevant question: q12 (surveillance on humans)

responses <- get_responses("12")
pander( table(responses, useNA="ifany"))

# relevant question: q28 (surveillance on vectors)

responses <- get_responses("28")
pander( table(responses, useNA="ifany"))

# relevant question: q41 (surveillance on animals)

responses <- get_responses("41")
pander( table(responses, useNA="ifany"))

```

### Training of surveillance personnel and clinicians?

```{r echo=FALSE, message=FALSE}

# relevant question: q10 

responses <- get_responses("10")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
tallies <- responses %>% 
  pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response")
knitr::kable( table( tallies$Arbovirus, tallies$Response, useNA="ifany") )

# relevant question: q24

responses <- get_responses("24")

```

To do:

- Clean up free text responses to this question!

# Laboratory diagnostic capacity indicators

### Testing in outbreak vs non-outbreak settings

```{r echo=FALSE, message=FALSE}

# relevant question: q15

responses <- get_responses("15")
tallies <- responses %>%
  pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response")
knitr::kable( table( tallies$Arbovirus, tallies$Response, useNA="ifany") )

```

### Laboratory tests available

```{r echo=FALSE, message=FALSE}

# relevant question: q17

responses <- get_responses("17")
# tallies <- responses %>%
#   pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response")
# knitr::kable( table( tallies$Arbovirus, tallies$Response, useNA="ifany") )

```

To do:

- Clean up presentation of these responses
- Fix regex pattern to handle multiple pairs of square brackets

# Response capacity indicators

### Surveillance and control plans available (q 6)

### Vector control method employed (q35)

###   Surveillance and response committee exists (q47)

###  Contingency plan exists (q48)

# Epidemiologic risk data

### Vectors present and level of risk (q34, q34b, q34c)

### All arboviruses 2015-2020 (cases and deaths) (q55, b, c)

### Most recent year data (q56)
