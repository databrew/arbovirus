---
title: "WHO Global Arbovirus Survey"
author: "Databrew LLC"
date: "7/30/2021"
output: html_document
---

# Read and validate data

```{r echo=FALSE, message=FALSE}

library(tidyverse)
library(stringr)
library(pander)

# get the survey results, as processed by WHO script (lightly edited) :

if( file.exists("data/data.RData" )){
  load("data/data.RData")
} else{
  setwd("misc/")
  source("survey_375147_R_syntax_file.R")
  setwd("../data")
  save(data, file="data.RData")
  setwd("../")
}

# whoa this prints a lot of stuff...
# summary(data)

# load data dictionary to facilitate processing survey results:
dict <- read_csv("misc/Data_dictionary_Survey375147.csv")

# utility function 
get_responses <- function( question ){
  idx <- which( dict$`Question number` == question )
  question <- dict$Description[ idx[1] ]
  cat(question)
  var_names <- dict$`Variable name`[idx]
  responses <- data %>% select( all_of(var_names) )
  return( responses )
}

```

Check data against specifications in data dictionary? 
Or is provided script sufficient? Investigate!

# Surveillance capacity indicators

### Reportable arboviral diseases

```{r echo=FALSE, message=FALSE}

# relevant questions: q11, q11b

responses <- get_responses("11")
pander( table( responses, useNA="ifany" ))

idx <- which(dict$`Question number`=="11b")
question <- dict$Description[idx[1]]
cat(question)
var_name <- dict$`Variable name`[idx]
responses <- data %>% select( all_of(var_name) )
# remove square brackets from virus info. in dictionary, then rename responses:
names( responses ) <- str_extract( dict$Subquestion[idx], '(?<=\\[)[^{}]+(?=\\])')
# summary( responses )
tallies <- responses %>% 
  pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response")
knitr::kable( table( tallies$Arbovirus, tallies$Response, useNA="ifany") )
tallies <- tallies %>% 
  group_by(Arbovirus, Response) %>% 
  tally
ggplot(tallies, aes(x=Response, y=n, fill=Response)) + 
  geom_col() + 
  facet_wrap(~Arbovirus) +
  theme(legend.position = "bottom",
        legend.direction="vertical",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```


###  History of any arbovirus circulation since 2000 

```{r echo=FALSE, message=FALSE}

# relevant question: q5

idx <- which(dict$`Question number`=="5")
question <- dict$Description[idx[1]]
cat( question )
var_name <-  dict$`Variable name`[idx]  
responses <- data %>% select( all_of(var_name) )
names( responses ) <- str_extract( dict$Subquestion[idx], '(?<=\\[)[^{}]+(?=\\])')
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
tallies <- responses %>% 
  pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response")
knitr::kable( table( tallies$Arbovirus, tallies$Response, useNA="ifany") )

# knitr::kable( table(other))

```

To do:

- The free text responses to `Other` need to be cleaned!!
- Barplot instead of / in addition to tabular summary?

###  Conducting surveillance on humans,  vectors, and animals

```{r echo=FALSE, message=FALSE}

# relevant question: q12 (surveillance on humans)

responses <- get_responses("12")
pander( table(responses, useNA="ifany"))

# relevant question: q28 (surveillance on vectors)

responses <- get_responses("28")
pander( table(responses, useNA="ifany"))

# relevant question: q41 (surveillance on animals)

responses <- get_responses("41")
pander( table(responses, useNA="ifany"))

```

### Training of surveillance personnel and clinicians? (q24)

```{r echo=FALSE, message=FALSE}

# relevant question: q10 (surveillance on humans)

responses <- get_responses("10")

```

# Laboratory diagnostic capacity indicators

### Testing in outbreak vs non-outbreak settings (q15)

### Laboratory tests available (q17)

# Response capacity indicators

### Surveillance and control plans available (q 6)

### Vector control method employed (q35)

###   Surveillance and response committee exists (q47)

###  Contingency plan exists (q48)

# Epidemiologic risk data

### Vectors present and level of risk (q34, q34b, q34c)

### All arboviruses 2015-2020 (cases and deaths) (q55, b, c)

### Most recent year data (q56)
