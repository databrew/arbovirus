---
title: "WHO Global Arbovirus Survey"
author: "Databrew LLC"
date: "7/30/2021"
output: html_document
---

## Read and validate data

```{r echo=FALSE, message=FALSE}

library(tidyverse)
library(stringr)
library(pander)

# get the survey results, as processed by WHO script:

if( file.exists("data/data.RData" )){
  load("data/data.RData")
} else{
  setwd("data/")
  source("survey_375147_R_syntax_file.R")
  save(data, file="data.RData")
  setwd("../")
}

# whoa this prints a lot of stuff...
# summary(data)

# load data dictionary to facilitate processing survey results:
dict <- read_csv("misc/Data dictionary_Survey375147.csv")

```

Check data against specifications in data dictionary? 
Or is provided script sufficient? Investigate!

## Surveillance capacity indicators

- Reportable arboviral diseases (q11, q11b)

```{r echo=FALSE, message=FALSE}

idx <- which(dict$`Question number`=="11")
question <- dict$Description[idx]
cat( question )
var_name <- dict$`Variable name`[idx] 
# <WTF>
# group_by not cooperating with var_name in quotes, select thinks its external, AND
# this particular kludge with as.name assumes a single name. 
# </WTF>
pander( data %>% select(!!as.name(var_name)) %>% group_by(!!as.name(var_name)) %>% tally )

idx <- which(dict$`Question number`=="11b")
var_name <- dict$`Variable name`[idx]
# and yet select seems to work just fine here! weird.
tallies <- data %>% select( var_name ) %>% gather() %>% group_by(key, value) %>% tally
ggplot(tallies, aes(x=value, y=n)) + geom_col() + facet_wrap(~key)

```

To do next for this chunk:

- replace inscrutable var_names with actual viruses in question, i.e., use text from subquestions in dictionary via something like `stringr::string_extract` with pattern `(?<=\[)[^{}]+(?=\])`
- create legible labels for barplot

Should be able to handle remaining questions similarly...

- History of any arbovirus circulation since 2000 (q5)
- Conducting surveillance on humans (q12),  vectors (q28) animals (q41)
- Training of surveillance personnel and clinicians? (q10) (q24)

## Laboratory diagnostic capacity indicators

- Testing in outbreak vs non-outbreak settings (q15)
- Laboratory tests available (q17)

## Response capacity indicators

- Surveillance and control plans available (q 6)
- Vector control method employed (q35)
-  Surveillance and response committee exists (q47)
-  Contingency plan exists (q48)

## Epidemiologic risk data

- Vectors present and level of risk (q34, q34b, q34c)
- All arboviruses 2015-2020 (cases and deaths) (q55, b, c)
- Most recent year data (q56)
