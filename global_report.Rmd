---
title: 'Arboviral Surveillance and Response Capacity Survey 2021'
output: html_document
---

```{r, include=FALSE, echo = FALSE}
# Basic knitr options
library(knitr)
opts_chunk$set(comment = NA, 
               echo = FALSE,
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE)
```

```{r, echo = FALSE}
source('functions.R')
dict <- load_dict()
data <- load_data()
region_countries <- load_regions_countries()
```

```{r}
data <- data %>% mutate(SI01 = as.character(SI01)) %>% arrange( SI01 )
```

### Survey response

```{r, out.width = '100%'}
library(leaflet)
load('../data/world_shp.rda')
make_map(df = data %>% 
           dplyr::select(country = SI01) %>% 
           mutate( country = recode_factor(.x=country,
                                           "Bolivia (Plurinational State of)" = "Bolivia",
                                           "Saint BarthÃ©lemy" = "Saint Barthelemy",
                                           "United States of America" = "United States",
                                           "Venezuela (Bolivarian Republic of)" = "Venezuela") ) %>% 
           mutate(value = 'WHO') %>% 
           bind_rows( read_csv("../data/who_afro.csv") ), 
         pal = 'Set2')
```

As shown above, the WHO conducted the arbovirus survey in `r nrow(data)` countries; the Special Programme for Research and Training in Tropical Diseases (TDR) conducted the arbovirus survey in the African region. Also note that AMRO provided data on an abbreviated set of key variables from the survey on behalf of its member states, as circulation of the survey was not feasible because of the overwhelming COVID-19 burden in the region.

<br>

#### Responding countries and response rate by WHO regional office

```{r}
data %>% 
  group_by(Region) %>% 
  summarize( respondents = paste0(SI01, collapse=", "),
             n_respondents = n() ) %>%
  # tally( name = "n_respondents") %>%
  right_join( region_countries %>% group_by(Region) %>% tally( name="n_countries"), by="Region") %>%
  mutate( response_rate = paste0(round(100*n_respondents / n_countries), "%") ) %>%
  select( Region, n_respondents, n_countries, response_rate, respondents ) %>%
  rename("Regional office" = Region, 
         "Countries that responded" = respondents,
         "Response rate" = response_rate,
         "Number of countries invited" = n_countries,
         "Number of countries that responded" = n_respondents) %>%
  regulartable %>% 
  theme_zebra(odd_header="#048ECA", odd_body = "#D6EAF8") %>% 
  color( color="#FFFFFF", part="header" ) %>% 
  align( j=2:4, align="center", part="all" ) %>%
  align( j=5, align="center", part="header" ) %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>%
  autofit() 
```


### Autochthonous arbovirus transmission status

#### Arboviruses that have circulated autochthonously in the region at any time since 2000 (ref Q5)

```{r}

# relevant question: q5

responses <- get_responses("5")
other <- responses %>% select(Other)
# ugly hack to add other viruses from PAHO spreadsheet...
other <- cbind( Region = data$Region, Country = data$SI01, other )
idx <- which( other$Country == "United States of America" )
other$Other[ idx ] <- "WNV, EEV"
idx <- which( other$Country == "Panama" )
other$Other[ idx ] <- "EEEV, VEEV"
idx <- which( other$Country == "Colombia" )
other$Other[ idx ] <- "VEEV"
idx <- which( other$Country == "Ecuador" )
other$Other[ idx ] <- "MAYV"
idx <- which( other$Country == "Peru" )
other$Other[ idx ] <- "OROV, MAYV"
idx <- which( other$Country == "Brazil" )
other$Other[ idx ] <- "OROV, MAYV, WNV"
other <- other %>% 
  select(-Country) %>%
  drop_na(Region) %>%
  drop_na( Other ) %>%
  filter( Other != "None" ) %>%
  group_by( Region ) %>%
  summarize( Other = paste0( unique( unlist( strsplit( paste0(Other, collapse = ", "), ", ", fixed=TRUE))), collapse = ", ")) %>%
  ungroup()
responses <- responses %>% select(-Other) 
responses <- cbind( Region = data$Region, responses) %>% 
  drop_na(Region) %>%
  filter( if_any(!Region, ~ !is.na(.x)))
nums <- responses %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
responses %>% 
  pivot_longer(!Region, names_to="Arbovirus", values_to="Response") %>% 
  mutate( Arbovirus = recode_factor(.x = Arbovirus,
                                    "Chikungunya"="CHIKV",
                                    "Dengue"="DENV",
                                    "Yellow fever"="YFV",
                                    "Zika"="ZIKV")) %>%
  mutate( Response = factor( replace_na( as.character(Response), "Unanswered"))) %>%
  mutate( Response = fct_relevel(Response, "Yes", "Not selected", "Unanswered")) %>%
  group_by(Region, Arbovirus, Response) %>% 
  tally %>%
  ungroup() %>% 
  left_join( nums, by="Region") %>%
  mutate( Percentage = round(100*n/n_countries)) %>%
  filter( Response == "Yes" ) %>%
  select( -c(Response,n_countries) ) %>%
  mutate( Percentage = paste0("(", Percentage, "%)")) %>%
  unite( "n", n:Percentage, sep = " ") %>%
  pivot_wider( names_from=Arbovirus, values_from=n) %>%
  mutate( across(!Region, ~replace_na(., "0 (0%)"))) %>%
  left_join( other, by="Region") %>%
  rename("Regional office" = Region ) %>%
  regulartable %>% 
  theme_zebra(odd_header="#048ECA", odd_body = "#D6EAF8") %>% 
  footnote( j = 2:5, 
            part = "header", 
            value = as_paragraph("Only countries that responded to Q5 are included in the denominator when calculating these percentages."),
            ref_symbols = "a") %>%
  footnote( j = 6,
            part = "header",
            value = as_paragraph("CCHFV = Crimean Congo haemorrhagic fever virus; CHIKV = chikungunya virus; DENV = dengue virus; EEEV = Eastern equine encephalitis virus; MAYV = Mayaro virus; OROV = Oropouche virus; RVFV = Rift Valley fever virus; SFFV = Sand fly fever virus (Naples, Sicilian); TBEV = Tick-borne encephalitis virus; TOSV = Toscana virus; VEEV = Venezuelan equine encephalitis virus; WNV = West Nile virus; YFV = yellow fever virus"),
            ref_symbols = "b" ) %>%
  color( color="#FFFFFF", part="header" ) %>% 
  align( j=2:5, align="center", part="all" ) %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>%
  autofit() 

```


### Arbovirus disease surveillance planning and practice

#### Performance of national epidemiological surveillance for arboviral diseases in humans (ref Q12, 12b, 12c)

```{r}
responses_12 <- get_responses("12") 
responses_12 <- cbind( Region = data$Region, responses_12 ) %>%
  drop_na( Response )
nums <- responses_12 %>%
  group_by(Region) %>%
  tally( name = "n_countries")
responses_12 <- responses_12 %>%
  filter( Response == "Yes" ) %>%
  group_by( Region ) %>%
  tally() %>%
  ungroup() %>%
  left_join( nums, by="Region") %>%
  mutate( Percentage = paste0("(",round(100*n/n_countries),"%)") ) %>%
  select( Region, n, Percentage) %>%
  unite("n", n:Percentage, sep=" ") %>%
  rename( "Countries conducting surveillance" = n) 

responses_12b <- get_responses("12b")
colnames( responses_12b ) <- c("Response", "Other")
responses_12b$Other[ which(!is.na( responses_12b$Other )) ] <- "Other"
responses_12b <- responses_12b %>%
  mutate( Response = factor( replace_na( as.character(Response), ""))) %>%
  mutate( Other = factor( replace_na( as.character(Other), ""))) %>%
  unite( Frequency, Response:Other, sep="") 
responses_12b <- cbind( Region = data$Region, responses_12b ) %>%
  group_by(Region, Frequency) %>% 
  tally() %>%
  ungroup() %>%
  filter( Frequency != "") %>%
  mutate( Frequency = factor( Frequency, levels = c("Weekly", "Monthly", "Ad hoc", "Other"))) %>%
  arrange( Frequency ) %>% 
  mutate( Frequency = as.character(Frequency)) %>%
# responses_12b$Frequency[ which( responses_12b$Frequency == "" ) ] <- "Unanswered"
  # left_join( nums, by="Region" ) %>%
  # mutate( Percentage = paste0("(",round(100*n/n_countries),"%)") ) %>%
  # select( Region, Frequency, n, Percentage ) %>%
  # unite("n", n:Percentage, sep=" ") %>%
  unite("Frequency", Frequency:n, sep=": ") %>%
  group_by(Region) %>% 
  summarize( Frequency = paste0(Frequency, collapse = "\n\n") ) %>%
  # mutate( Frequency = ifelse( Region == "PAHO", "Not asked", Frequency)) %>% 
  rename( "Surveillance frequency (N)" = Frequency )

responses_12c <- get_responses("12c")
colnames(responses_12c) <- "Type"
responses_12c <- cbind( Region = data$Region, responses_12c ) %>%
  drop_na( Type ) %>% 
  mutate( Type = factor( Type, levels = c("Primarily active", "Primarily passive", "Combination of active and passive") )) %>%
  arrange( Type ) %>%
  group_by(Region, Type) %>% 
  tally() %>%
  ungroup() %>% 
  mutate( Type = as.character(Type)) %>%
  # replace_na( list( Type = "Unanswered" )) %>% 
  # left_join( nums, by="Region" ) %>%
  # mutate( Percentage = paste0("(",round(100*n/n_countries),"%)") ) %>%
  # select( Region, Type, n, Percentage ) %>%
  # unite("n", n:Percentage, sep=" ") %>%
  unite("Type", Type:n, sep=": ") %>%
  group_by(Region) %>% 
  summarize( Type = paste0(Type, collapse = "\n\n")) %>% 
  # mutate( Type = ifelse( Region == "PAHO", "Not asked", Type)) %>% 
  rename( "Surveillance type (N)" = Type )

responses_12 <- left_join( responses_12, responses_12b, by="Region") %>%
  left_join( responses_12c, by="Region")

responses_12 %>% 
  rename("Regional office" = Region ) %>%
  regulartable() %>% 
  theme_zebra(odd_header="#048ECA", odd_body = "#D6EAF8") %>% 
  footnote( j=2, 
            part = "header", 
            value = as_paragraph("Only countries that responded to Q12 are included in the denominator when calculating these percentages."),
            ref_symbols = "a") %>%
  footnote( j=3:4, 
            part = "header", 
            value = as_paragraph("Questions 12b and 12c were not included in the dataset shared with AMRO for completion. Please see the Arbovirus Survey Overview for more information."),
            ref_symbols = "b") %>%
  color( color="#FFFFFF", part="header" ) %>% 
  align( j=2, align="center", part="all" ) %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>%
  autofit()

```


### Arbovirus laboratory capacity

#### Testing capacity by virus and assay type (ref Q17)

```{r}
responses <- get_responses("17")
responses <- cbind(Region = data$Region, responses) %>%
  filter( if_any(!Region, ~ !is.na(.x))) 
nums <- responses %>% 
  group_by(Region) %>% 
  tally( name = "n_countries")
responses <- responses %>% 
  pivot_longer(!Region)

new_cols <- matrix(unlist(strsplit(responses$name, "\\]\\[")), ncol = 2, byrow = T)
responses <- responses %>%
  mutate(Level = new_cols[, 1], Test = new_cols[, 2]) %>%
  select(-name) %>%
  filter( Level != "Other") %>% 
  # mutate( value = as.character(value)) %>%
  replace_na(list(value = 0)) %>%
  mutate( Region = as.factor(Region)) %>% 
  mutate( Level = recode_factor(.x = Level,
                                    "Chikungunya"="CHIKV",
                                    "Dengue"="DENV",
                                    "Yellow fever"="YFV",
                                    "Zika"="ZIKV")) %>%
  mutate( Test = as.factor(Test)) %>% 
  mutate( value = as.numeric( value )) %>%
  filter( Test %in% c("Antigen testing",
                      "IgG antibody testing",
                      "IgM antibody testing",
                      "Neutralizing antibody testing",
                      "RT-PCR or other nucleic acid amplification test")) %>%
  droplevels() 

chikv_denv <- responses %>% 
  filter( Level == "CHIKV" | Level == "DENV")

yfv_zikv <- responses %>% 
  filter( Level == "YFV" | Level == "ZIKV")

chikv_denv <- chikv_denv %>% 
  group_by(Region,Level,Test) %>% 
  summarize( Total = sum(value) ) %>% 
  ungroup() %>%
  left_join( nums, by="Region") %>%
  mutate( Total = paste0(Total, "\n(",round(100*Total/n_countries),"%)") ) %>%
  select( -n_countries ) %>%
  mutate( Test = recode_factor( .x=Test,
                                "Antigen testing"="A",
                                "IgM antibody testing"="M",
                                "IgG antibody testing"="G",
                                "Neutralizing antibody testing"="N",
                                "RT-PCR or other nucleic acid amplification test"="P")) %>%
  pivot_wider( names_from = Level:Test, values_from = Total, names_sort = TRUE) %>%
  rename("Regional office" = "Region")

chikv_denv_header <- data.frame( keys = c("Regional office", "blank1", 
                                     "CHIKV_A", "CHIKV_M", "CHIKV_G", "CHIKV_N", "CHIKV_P", "blank2",
                                     "DENV_A", "DENV_M", "DENV_G", "DENV_N", "DENV_P", "blank3" ) )
chikv_denv_header <- cbind( chikv_denv_header, separate( chikv_denv_header,keys, into=c("Virus", "Test"), sep="_"))
chikv_denv_header$Test[1] <- chikv_denv_header$keys[1]
chikv_denv_header$Virus[ c(2,8,14)] <- ""
chikv_denv_header$Test[ c(2,8,14)] <- ""

chikv_denv %>%
  flextable( col_keys = chikv_denv_header$keys ) %>%
  set_header_df( mapping = chikv_denv_header, key="keys") %>%
  merge_h( part="header") %>%
  merge_v( j=1, part="header") %>%
  theme_zebra(odd_header="#048ECA", even_header="#048ECA", odd_body = "#D6EAF8") %>% 
  footnote( i = 1, j=c(3:7,9:13), 
            part = "header", 
            value = as_paragraph("Only countries that responded to Q17 are included in the denominator when calculating these percentages"),
            ref_symbols = "a") %>%
  footnote( i = 2, j=c(3:7,9:13),
            part = "header",
            value = as_paragraph("A = Antigen testing; M = IgM antibody testing; G = IgG antibody testing; N = Neutralizing antibody testing; P = RT-PCR or other nucleic acid amplification test"),
            ref_symbols = "b" ) %>%
  color( color="#FFFFFF", part="header" ) %>% 
  align( align="center", part="all") %>%
  align( align="left", j=1, part="all" ) %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>%
  hline( i=1, j = 3:7, part="header", border = fp_border(width = 2, color = "#FFFFFF")) %>%
  hline( i=1, j = 9:13, part="header", border = fp_border(width = 2, color = "#FFFFFF")) %>%
  autofit()
```

<br>


```{r}
yfv_zikv <- yfv_zikv %>% 
  group_by(Region,Level,Test) %>% 
  summarize( Total = sum(value) ) %>% 
  ungroup() %>%
  left_join( nums, by="Region") %>%
  mutate( Total = paste0(Total, "\n(",round(100*Total/n_countries),"%)") ) %>%
  select( -n_countries ) %>%
  mutate( Test = recode_factor( .x=Test,
                                "Antigen testing"="A",
                                "IgM antibody testing"="M",
                                "IgG antibody testing"="G",
                                "Neutralizing antibody testing"="N",
                                "RT-PCR or other nucleic acid amplification test"="P")) %>%
  pivot_wider( names_from = Level:Test, values_from = Total, names_sort = TRUE) %>%
  rename("Regional office" = "Region")

yfv_zikv_header <- data.frame( keys = c("Regional office", "blank1", 
                                     "YFV_A", "YFV_M", "YFV_G", "YFV_N", "YFV_P", "blank2",
                                     "ZIKV_A", "ZIKV_M", "ZIKV_G", "ZIKV_N", "ZIKV_P", "blank3") )
yfv_zikv_header <- cbind( yfv_zikv_header, separate( yfv_zikv_header,keys, into=c("Virus", "Test"), sep="_"))
yfv_zikv_header$Test[1] <- yfv_zikv_header$keys[1]
yfv_zikv_header$Virus[ c(2,8,14)] <- ""
yfv_zikv_header$Test[ c(2,8,14)] <- ""

yfv_zikv %>%
  flextable( col_keys = yfv_zikv_header$keys ) %>%
  set_header_df( mapping = yfv_zikv_header, key="keys") %>%
  merge_h( part="header") %>%
  merge_v( j=1, part="header") %>%
  theme_zebra(odd_header="#048ECA", even_header="#048ECA", odd_body = "#D6EAF8") %>% 
  footnote( i = 1, j=c(3:7,9:13), 
            part = "header", 
            value = as_paragraph("Only countries that responded to Q17 are included in the denominator when calculating these percentages."),
            ref_symbols = "a") %>%
  footnote( i = 2, j=c(3:7,9:13),
            part = "header",
            value = as_paragraph("A = Antigen testing; M = IgM antibody testing; G = IgG antibody testing; N = Neutralizing antibody testing; P = RT-PCR or other nucleic acid amplification test"),
            ref_symbols = "b" ) %>%
  color( color="#FFFFFF", part="header" ) %>% 
  align( align="center", part="all") %>%
  align( align="left", j=1, part="all" ) %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>%
  hline( i=1, j = 3:7, part="header", border = fp_border(width = 2, color = "#FFFFFF")) %>%
  hline( i=1, j = 9:13, part="header", border = fp_border(width = 2, color = "#FFFFFF")) %>%
  autofit()

```


### Management of arboviral disease cases

#### Availability of clinical guidelines and training of healthcare workers on clinical diagnosis and management of _Aedes_-borne arboviral diseases (ref Q21)

```{r}
responses <- get_responses("21")
responses <- cbind( Region = data$Region, responses) %>% 
  drop_na(Region) %>% 
  drop_na( Response )
nums <- responses %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
responses %>% 
  group_by(Region) %>%
  filter(Response == "Yes") %>% 
  tally() %>%
  left_join( nums, by="Region") %>%
  # mutate( "Countries with clinical guidelines available" = paste0( round(100*n/n_countries), "%")) %>%
  mutate( Percentage = paste0( "(", round(100*n/n_countries), "%)")) %>%
  select(-n_countries) %>%
  unite( "Countries with clinical guidelines available", n:Percentage, sep=" ") %>%
  rename("Regional office" = Region ) %>%
  regulartable %>% 
  theme_zebra(odd_header="#048ECA", odd_body = "#D6EAF8") %>% 
  footnote( j=2, 
            part = "header", 
            value = as_paragraph("Only countries that responded to Q21 are included in the denominator when calculating these percentages."),
            ref_symbols = "a") %>%
  color( color="#FFFFFF", part="header" ) %>% 
  align( j=2, align="center", part="all" ) %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>%
  autofit() 
```



```{r}
q29 <- get_responses("29")
q29 <- cbind( Region = data$Region, q29 ) %>%
  drop_na( Response )
nums <- q29 %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
q29 <- q29 %>% 
  filter( Response == "Yes" ) %>% 
  group_by( Region)  %>%
  tally() %>%
  right_join( nums, by="Region") %>%
  replace_na( list(n = 0)) %>%
  mutate( Percentage = paste0( "(", round( 100*n/n_countries), "%)" )) %>%
  select(Region, n, Percentage) %>%
  unite( "Adult surveillance", n:Percentage, sep=" " )

q30 <- get_responses("30")
q30 <- cbind( Region = data$Region, q30 ) %>%
  drop_na( Response )
nums <- q30 %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
q30 <- q30 %>% 
  filter( Response == "Yes" ) %>% 
  group_by( Region)  %>%
  tally() %>%
  right_join( nums, by="Region") %>%
  replace_na( list(n = 0)) %>%
  mutate( Percentage = paste0( "(", round( 100*n/n_countries), "%)" )) %>%
  select(Region, n, Percentage) %>%
  unite( "Larval/pupal surveillance", n:Percentage, sep=" " )

q31 <- get_responses("31")
q31 <- cbind( Region = data$Region, q31 ) %>%
  drop_na( Response )
nums <- q31 %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
q31 <- q31 %>% 
  filter( Response == "Yes" ) %>% 
  group_by( Region)  %>%
  tally() %>%
  right_join( nums, by="Region") %>%
  replace_na( list(n = 0)) %>%
  mutate( Percentage = paste0( "(", round( 100*n/n_countries), "%)" )) %>%
  select(Region, n, Percentage) %>%
  unite( "Trapped mosquitoes identified to species", n:Percentage, sep=" " )

ft29_30_31 <- left_join( q29, q30, by="Region") %>%
  left_join( q31, by="Region") %>%
  rename("Regional office" = Region ) %>%
  regulartable() %>% 
  theme_zebra(odd_header="#048ECA", odd_body = "#D6EAF8") %>% 
  footnote( j=2:4, 
            part = "header", 
            value = as_paragraph( c( "Only countries that responded to Q29, Q30, and Q31, respectively, are included in the denominators when calculating these percentages. These questions were not included in the dataset shared with AMRO for completion; please see the Arbovirus Survey Overview for more information.") ),
            ref_symbols = c("a") ) %>% 
  color( color="#FFFFFF", part="header" ) %>% 
  align( j=2:4, align="center", part="all" ) %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>% 
  autofit()

responses <- get_responses("35")
responses <- cbind( Region = data$Region, responses) %>% 
  drop_na(Region) %>%
  filter( if_any(!Region, ~ !is.na(.x)) )
nums <- responses %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
other <- responses %>% select(Other)

ft35 <- responses %>% 
  select(-Other) %>% 
  mutate( across(!Region, ~ ifelse(.x == "Yes", 1, 0))) %>%
  group_by(Region) %>%
  summarize( across(everything(), ~ sum(.x, na.rm=TRUE))) %>%
  ungroup() %>%
  left_join( nums, by="Region") %>%
  group_by(Region) %>%
  mutate( across( everything(), ~ paste0( .x, " (", round(100*(.x)/n_countries), "%)") ) ) %>%
  select(-n_countries) %>%
  rename("Regional office" = Region,
         "Adulticiding"="Adulticiding (insecticide application against adult mosquitoes)",
         "Insect growth regulators" = "Insect growth regulators (eg , pyriproxyfen)") %>%
  regulartable %>% 
  theme_zebra(odd_header="#048ECA", odd_body = "#D6EAF8") %>% 
  footnote( j=2:7, 
            part = "header", 
            value = as_paragraph("Only countries that responded to Q35 are included in the denominator when calculating these percentages."),
            ref_symbols = "a") %>%
  color( color="#FFFFFF", part="header" ) %>% 
  align( j=2:7, align="center", part="all" ) %>%
  compose( j=5, part="header", value = as_paragraph(as_i("Wolbachia"), " method")) %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>% 
  autofit() 

responses <- cbind( Region = data$Region, get_responses("32")) %>% 
  select( Region, Response ) %>% 
  drop_na() %>%
  mutate( Response = ifelse( grepl("Yes", Response), "Yes", Response ) ) %>% 
  rename( "Minimum infection rate calculations" = Response ) 
nums <- responses %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
ft32 <- responses %>% 
  mutate( across(!Region, ~ ifelse(.x == "Yes", 1, 0))) %>%
  group_by(Region) %>%
  summarize( across(everything(), ~ sum(.x, na.rm=TRUE))) %>%
  ungroup() %>%
  left_join( nums, by="Region") %>%
  group_by(Region) %>%
  mutate( across( everything(), ~ paste0( .x, " (", round(100*(.x)/n_countries), "%)") ) ) %>%
  select(-n_countries) 

responses <- cbind( Region = data$Region, get_responses("38")) %>% 
  drop_na(Region) %>%
  filter( if_any(!Region, ~ !is.na(.x)) )
nums <- responses %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
other <- responses %>% select(Other)
ft38 <- responses %>% 
  select(-Other) %>% 
  mutate( across(!Region, ~ ifelse(.x == "Yes", 1, 0))) %>%
  group_by(Region) %>%
  summarize( across(everything(), ~ sum(.x, na.rm=TRUE))) %>%
  ungroup() %>%
  left_join( nums, by="Region") %>%
  group_by(Region) %>%
  mutate( across( everything(), ~ paste0( .x, " (", round(100*(.x)/n_countries), "%)") ) ) %>%
  select(-n_countries) %>%
  left_join( ft32, by="Region" ) %>%
  rename("Regional office" = Region ) %>%
  regulartable %>% 
  theme_zebra(odd_header="#048ECA", odd_body = "#D6EAF8") %>% 
  footnote( j=2:8, 
            part = "header", 
            value = as_paragraph("Only countries that responded to Q38 are included in the denominator when calculating these percentages."),
            ref_symbols = "a") %>%
  footnote( j=9, 
            part = "header", 
            value = as_paragraph("Only countries that responded to Q32 are included in the denominator when calculating these percentages."),
            ref_symbols = "b") %>%
  color( color="#FFFFFF", part="header" ) %>% 
  align( j=2:7, align="center", part="all" ) %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>% 
  autofit() 

ft_width <- max( c( flextable_dim(ft29_30_31)$widths, flextable_dim(ft35)$widths, flextable_dim(ft38)$widths ))

ft29_30_31 <- ft29_30_31 %>% width( width=ft_width)
ft35 <- ft35 %>% width( width=ft_width)
ft38 <- ft38 %>% width( width=ft_width)
```

### Vector surveillance and control

#### Countries conducting mosquito surveillance, by stage and species identification (ref Q29, 30, 31)

```{r}
ft29_30_31
```

<br>

#### Vector control methods used in local jurisdictions in the past two years (either using government staff and resources, or subcontracting to a different entity to do so) (ref Q35)

```{r}
ft35
```

<br>

#### Vector indices measured and calculation of infection rates (ref Q38, Q32)

```{r}
ft38
```


### Community sensitization and participation

#### Community outreach programme existence and scope (ref Q43, 43b, 43c)

```{r}
q43 <- get_responses("43")
q43 <- cbind( Region = data$Region, q43 ) %>%
  drop_na(Response)

nums <- q43 %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")

q43 <- q43 %>%
  group_by(Region) %>%
  filter( Response == "Yes" ) %>% 
  tally( name = "Programmes")
  # tally(name = "Countries with community outreach programmes for arboviruses")

# q43b <- get_responses("43b") %>%
#   rename( "Entity in charge" = Response)

q43c <- get_responses("43c") 
colnames( q43c ) <- c("Coverage", "Areas") 
q43c$Coverage[ grep("Only selected areas", q43c$Coverage ) ] <- "Limited areas"
q43c <- q43c %>% select( Coverage )
q43c <- cbind( Region = data$Region, q43c ) %>%
  drop_na( Coverage ) %>%
  mutate( Countrywide = ifelse( Coverage == "Countrywide", 1, 0 ),
          Limited = ifelse( Coverage == "Limited areas", 1, 0 ) ) %>%
  select( -Coverage ) %>%
  group_by( Region ) %>%
  summarize( across( everything(), ~ sum(.x, na.rm=TRUE))) 

nums %>% 
  left_join( q43, by="Region") %>%
  left_join( q43c, by="Region") %>%
  mutate( Programmes = paste0( Programmes, " (", round( 100*Programmes/n_countries ), "%)" ) ) %>%
  rename( "Countries with community outreach programmes for arboviruses" = Programmes ) %>%
  # group_by( Region ) %>%
  # mutate( across( everything(), replace_na, 0)) %>% 
  # mutate( across( everything(), ~ paste0( .x, " (", round(100*(.x)/n_countries), "%)") ) ) %>%
  select( -n_countries ) %>%
  mutate( Countrywide = paste0("Countrywide: ", Countrywide),
          Limited = paste0("Limited areas: ", Limited)) %>%
  unite( "Coverage (N)", Countrywide:Limited, sep="\n\n" ) %>%
  rename("Regional office" = Region ) %>%
  regulartable() %>% 
  theme_zebra(odd_header="#048ECA", odd_body = "#D6EAF8") %>% 
  footnote( j=2, 
            part = "header", 
            value = as_paragraph("Only countries that responded to Q43 are included in the denominator when calculating these percentages. Q43 was not included in the dataset shared with AMRO for completion; please see the Arbovirus Survey Overview for more information."),
            ref_symbols = "a") %>%
  color( color="#FFFFFF", part="header" ) %>% 
  align( j=2, align="center", part="all") %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>%
  width( j = 2, width = 1 ) %>%
  autofit()

```


### Preparedness for arboviral outbreaks/epidemics

#### Outbreak committee presence, staff training, contingency hospital service plan and emergency funding (ref Q47, 48, 50, 52, 53)

```{r}
q47 <- get_responses("47") 
q47 <- cbind( Region = data$Region, q47 ) %>%
  drop_na( Response )
nums47 <- q47 %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
q47 <- q47 %>%
  filter(Response == "Yes") %>% 
  group_by(Region) %>%
  tally() %>%
  left_join( nums47, by="Region") %>%
  mutate( n = paste0( n, " (", round( 100*n/n_countries ), "%)" )) %>%
  select( -n_countries ) %>%
  rename( "Outbreak committee in place" = n)

q48 <- get_responses("48") 
q48 <- cbind( Region = data$Region, q48 ) %>%
  drop_na( Response )
nums48 <- q48 %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
q48 <- q48 %>% 
  filter( Response == "Yes" ) %>%
  group_by(Region) %>%
  tally() %>% 
  left_join( nums48, by="Region") %>%
  mutate( n = paste0( n, " (", round( 100*n/n_countries ), "%)" )) %>%
  select( -n_countries ) %>%
  rename( "Staff/committee training for outbreaks" = n)

q52 <- get_responses("52") %>%
  mutate( Fund = ifelse( `National level`=="Yes" | `State/local level` == "Yes", 1, 0 ) ) %>%
  select( Fund )
q52 <- cbind( Region = data$Region, q52 ) %>%
  drop_na( Fund )
nums52 <- q52 %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
q52 <- q52 %>% 
  group_by(Region) %>%
  summarize(Fund = sum(Fund, na.rm=TRUE)) %>%
  left_join( nums52, by="Region") %>%
  mutate( Fund = paste0( Fund, " (", round( 100*Fund/n_countries ), "%)" )) %>%
  select( -n_countries ) %>%
  rename( "Emergency fund" = Fund )

q53 <- get_responses("53")
q53 <- cbind( Region = data$Region, q53 ) %>%
  drop_na( Response )
nums53 <- q53 %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
q53 <- q53 %>% 
  filter( Response == "Yes" ) %>%
  group_by(Region) %>%
  tally() %>% 
  left_join( nums53, by="Region") %>%
  mutate( n = paste0( n, " (", round( 100*n/n_countries ), "%)" )) %>%
  select( -n_countries ) %>%
  rename( "Contingency plan for healthcare services in emergencies" = n)

q50 <- get_responses("50")
colnames( q50 ) <- c("Response", "Institutions")
q50$Response[ grep("Yes", q50$Response )] <- "Yes"
q50 <- cbind( Region=data$Region, q50 ) %>%
  drop_na( Response )
nums50 <- q50 %>% 
  group_by( Region ) %>%
  tally(name = "n_countries")
q50 <- q50 %>%
  filter(Response=="Yes") %>%
  group_by(Region) %>%
  tally() %>% 
  left_join( nums50, by="Region") %>%
  mutate( n = paste0( n, " (", round( 100*n/n_countries ), "%)" )) %>%
  select( -n_countries ) %>%
  rename( "Collaborating institutions (regional network)" = n)

list( q47, q48, q53, q52, q50 ) %>%
  reduce( left_join, by="Region") %>%
  group_by( Region ) %>%
  rename("Regional office" = Region ) %>%
  regulartable() %>% 
  theme_zebra(odd_header="#048ECA", odd_body = "#D6EAF8") %>% 
  footnote( j=2:6, 
            part = "header", 
            value = as_paragraph( c("Only countries that responded to Q47, Q48, Q53, Q52, and Q50, respectively, are included in the denominator when calculating these percentages. These questions were not included in the dataset shared with AMRO for completion; please see the Arbovirus Survey Overview for more information.") ),
            ref_symbols = c("a") ) %>%
  color( color="#FFFFFF", part="header" ) %>% 
  align( j=2:6, align="center", part="all") %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>%
  autofit()

```

### Cases and deaths by virus (ref Q55)

```{r}

q55 <- get_responses("55")

q55_deaths <- q55 %>% select( contains("Deaths") )
q55_cases <- q55 %>% select( contains("Cases") )
viruses <- unique( unlist(strsplit( names(q55_cases), "]"))[ !grepl( "Cases", unlist(strsplit(names(q55_cases), "]"))) ] )
q55_cases <-  cbind( Region = data$Region, q55_cases )
q55_deaths <-  cbind( Region = data$Region, q55_deaths )
q55_cases_summary <- data.frame( Region = sort( unique(data$Region) ) )
q55_deaths_summary <- data.frame( Region = sort( unique(data$Region) ) )
for( i in 1:length(viruses) ){
  these_cases <- q55_cases %>% select( Region, contains(viruses[i]) )
  colnames(these_cases) <- c("Region", as.character(2015:2020))
  these_cases <- these_cases %>%
    rowwise() %>%
    mutate( total = sum( across(!Region), na.rm = TRUE ) ) %>%
    group_by( Region ) %>%
    summarise( Cases = sum(total) )
  colnames( these_cases )[2] <- viruses[i]
  q55_cases_summary <- cbind( q55_cases_summary, these_cases[,2] )

  these_deaths <- q55_deaths %>% select( Region, contains(viruses[i]) )
  colnames(these_deaths) <- c("Region", as.character(2015:2020))
  these_deaths <- these_deaths %>%
    rowwise() %>%
    mutate( total = sum( across(!Region), na.rm = TRUE ) ) %>%
    group_by( Region ) %>%
    summarise( Deaths = sum(total) )
  colnames( these_deaths )[2] <- viruses[i]
  q55_deaths_summary <- cbind( q55_deaths_summary, these_deaths[,2] )
}

regulartable( q55_cases_summary ) %>%
  set_caption( caption = "Cases, 2015 to 2020") %>% 
  theme_zebra(odd_header="#048ECA", odd_body = "#D6EAF8") %>% 
  color( color="#FFFFFF", part="header" ) %>% 
  align( j=2:5, align="center", part="all" ) %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>%
  autofit()

regulartable( q55_deaths_summary ) %>%
  set_caption( caption = "Deaths, 2015 to 2020") %>% 
  theme_zebra(odd_header="#048ECA", odd_body = "#D6EAF8") %>% 
  color( color="#FFFFFF", part="header" ) %>% 
  align( j=2:5, align="center", part="all" ) %>%
  valign( valign = "top", part="header" ) %>%
  padding( padding.top = 10, part="all") %>%
  padding( padding.bottom = 10, part="all") %>%
  autofit()

write_csv( q55_cases_summary, "../q55_cases_summary.csv" )
write_csv( q55_deaths_summary, "../q55_deaths_summary.csv" )

```
