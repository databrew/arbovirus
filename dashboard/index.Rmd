---
title: "Global Data (Surveillance capacity indicators)"
---


```{r setup, include=FALSE, echo = FALSE}
# Basic knitr options
library(knitr)
opts_chunk$set(comment = NA, 
               echo = FALSE,
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
               fig.width = 9.64,
               fig.height = 5.9,
               fig.path = 'figures/')
ggplot2::theme_set(ggplot2::theme_bw())
if('who_shp.RData' %in% dir()){
  load('who_shp.RData')
} else {
  library(whomapper) # https://github.com/whocov/whomapper
  # options(scipen = '999')
  who_shp <- whomapper::pull_who_adm0()
  save(who_shp, file = 'who_shp.RData')
}
source('who_map_disp.R')
```

```{js}
element = document.getElementById('WHO_logo');
console.log(element)

$('#WHO_logo').click(function(e){
    console.log("Exists!")
});


window.onscroll = function() { scrollFunction() };

var navbar = document.getElementById("navbar");
var logoWhiteElement = document.getElementById("whiteLogoPosition")
var sticky = navbar.offsetTop;

function scrollFunction() {
  if (window.pageYOffset >= sticky) {
    navbar.classList.add("sticky");
    logoWhiteElement.classList.add("white_logo_appear");
  } else {
    navbar.classList.remove("sticky");
    logoWhiteElement.classList.remove("white_logo_appear");
  }
}

$(document).on('click', function (e){
    /* Global data  */
    var global_menu_opened = $('#global-navigation').hasClass('in');
    if(!$(e.target).closest('#global-navigation').length &&
        !$(e.target).is('#global-navigation') &&
        global_menu_opened === true){
            $('#global-navigation').collapse('toggle');
            $( "#Global-Li-area" ).removeClass("activeMenuState");
    }
    
    if ($('#global-navigation').attr('aria-expanded') === "false") {
      $( "#Global-Li-area" ).removeClass("activeMenuState");
    }
    if ($('#global-navigation').attr('aria-expanded') === "true") {
      $( "#Global-Li-area" ).addClass("activeMenuState");
    }

     /* Regional data  */
    var regional_menu_opened = $('#regional-navigation').hasClass('in');
    if(!$(e.target).closest('#regional-navigation').length &&
        !$(e.target).is('#regional-navigation') &&
        regional_menu_opened === true){
            $('#regional-navigation').collapse('toggle');
            $( "#Regional-Li-area" ).removeClass("activeMenuState");
    }
    
    if ($('#regional-navigation').attr('aria-expanded') === "false") {
      $( "#Regional-Li-area" ).removeClass("activeMenuState");
    }
    if ($('#regional-navigation').attr('aria-expanded') === "true") {
      $( "#Regional-Li-area" ).addClass("activeMenuState");
    }
     
     
     /* Country data  */
    var country_menu_opened = $('#country-navigation').hasClass('in');
    if(!$(e.target).closest('#country-navigation').length &&
        !$(e.target).is('#country-navigation') &&
        country_menu_opened === true){
            $('#country-navigation').collapse('toggle');
            $( "#Country-Li-area" ).removeClass("activeMenuState");
    }
    
    if ($('#country-navigation').attr('aria-expanded') === "false") {
      $( "#Country-Li-area" ).removeClass("activeMenuState");
    }
    if ($('#country-navigation').attr('aria-expanded') === "true") {
      $( "#Country-Li-area" ).addClass("activeMenuState");
    }


});

```


```{r, child="_sessioninfo.Rmd"}
```

```{r, echo = FALSE}
source('functions.R')
library(RColorBrewer)
library(scales)
library(leaflet)
library(leaflet.extras)
load('../data/world_shp.rda') # load world shape file
load('../data/region_shp.rda') # load region shape file
df <- load_data(modify_variable_names = TRUE)
df$country <- as.character(df$`1. State`)
df$adm0_name <- toupper(df$country)
```


```{r}
# Where to put new maps # https://trello.com/c/tgd50iIm/2693-who-arb-regional-maps
who_regions <- who_shp$adm0

# Reconcile the names of WHO countries with the arbovirus countries
# woh, they're already the same! woohoo!
# df$adm0_name[!df$adm0_name %in% who_regions$adm0_name]
```


# Responses by country

```{r}
pd <- df[grepl('1. State', names(df))]
names(pd) <- c('country')
pd <- pd %>% filter(!duplicated(country))
pd$value <- 'Responded'
l <- make_map(df = pd,
         pal = 'Dark2',
         qualitative = TRUE,
         provider = providers$OpenStreetMap,
         use_who_shp = TRUE) %>%
  addFullscreenControl()
htmltools::save_html(l, file = '~/Documents/databrew.github.io/whoarb/index.html')
```

```{r, eval = FALSE}
# Region level maps
# For each region, make a map
library(ggthemes)
regions <- sort(unique(who_shp$adm0$who_region))
for(i in 1:length(regions)){
  r <- regions[i]
  l <- make_map(df = pd,
         pal = 'Dark2',
         qualitative = TRUE,
         provider = providers$OpenStreetMap,
         use_who_shp = TRUE,
         filter_region = r,
         static = TRUE) +
    labs(title = r,
         subtitle = 'Countries which responded to survey') + 
    theme_map() +
    scale_fill_manual(name = '',
                      values = c('darkred', 'black')) +
    theme(legend.position = 'none')
  if(r == 'EURO')
    l <- l + xlim(-25, 44)
  l
  if(r == 'WPRO')
    l <- l + xlim(70, 180)
  l
  l
  ggsave(paste0('~/Desktop/who/', r, '.png'),
         width = 8,
         height = 6)
}
```



# Virus map

```{r}
# Get data for each disease
pd <- df[,c('1. State', names(df)[grepl('Which arboviruses have circulated in your country at any', names(df), fixed = TRUE)])]
names(pd) <- c('country', 'Chikungunya', 'Dengue', 'Yellow fever', 'Zika', 'Other')
pd$Other <- NULL
# Simplify values
for(j in 2:ncol(pd)){
  vals <- pd[,j]
  vals <- as.character(vals)
  out_vals <- ifelse(is.na(vals), 'No', ifelse(vals == 'Yes', 'Yes', 'No'))
  pd[,j] <- out_vals
}
# Get total number of viruses
pd$total <- apply(pd[,2:5], 1, function(x){sum(ifelse(x == 'Yes', 1, 0))})
# Clean up a bit
pd <- pd %>%
  filter(!is.na(country)) %>%
  filter(country != 'Iceland') %>%
  filter(!duplicated(country)) %>%
  mutate(value = total)
# Make markers for each disease
library(leaflet)
icons_chikungunya <- awesomeIcons(
  icon = NULL,
  text = 'C',
  # icon = 'copyright-mark',
  iconColor = 'black',
  markerColor = 'lightgray'
)
icons_dengue <- awesomeIcons(
  # icon = 'leaf',
  text = 'D',
  iconColor = 'black',
  markerColor = 'gray'
)
icons_yellow_fever <- awesomeIcons(
  # icon = 'star-empty',
  text = 'Y',
  iconColor = 'black',
  markerColor = 'orange'
)
icons_zika <- awesomeIcons(
  # icon = 'fire',
  text = 'Z',
  iconColor = 'black',
  markerColor = 'beige'
)
joined <- world_shp
joined@data <- left_join(joined@data, pd)
disease_names <- names(pd)[2:5]
for(j in 1:length(disease_names)){
  this_disease_name <- disease_names[j]
  vals <- joined@data[,this_disease_name]
  vals <- ifelse(is.na(vals), 'No', vals)
  joined@data[,this_disease_name] <- vals
}
coords <- coordinates(joined)
joined <- joined@data
joined$lng <- coords[,1]; joined$lat <- coords[,2]
jitter_factor <- 1.5
pd_chikungunya <- joined[joined$Chikungunya == 'Yes',] #%>% mutate(lng = jitter(lng, factor = jitter_factor), lat = jitter(lat, factor = jitter_factor))
pd_dengue <- joined[joined$Dengue == 'Yes',] %>% mutate(lng = lng + jitter_factor, lat = lat + 0) #  mutate(lng = jitter(lng, factor = jitter_factor), lat = jitter(lat, factor = jitter_factor))
pd_yellow_fever <- joined[joined$`Yellow fever` == 'Yes',] %>% mutate(lng = lng - jitter_factor, lat = lat + jitter_factor)  #mutate(lng = jitter(lng, factor = jitter_factor), lat = jitter(lat, factor = jitter_factor))
pd_zika <- joined[joined$Zika == 'Yes',] %>% mutate(lng = lng + jitter_factor, lat = lat - jitter_factor)#mutate(lng = jitter(lng, factor = jitter_factor), lat = jitter(lat, factor = jitter_factor))


l <- make_map(df = pd,
         pal = 'Spectral',
         qualitative = TRUE,
         add_base_layer = FALSE,
         label_string = 'Number of arboviruses',
         legend_title = 'Number of\narboviruses',
         use_who_shp = TRUE) %>%
  addTiles(group = 'OSM (default)') %>%
  addProviderTiles(providers$Stamen.Toner, group = "Toner") %>%
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  addAwesomeMarkers(data = pd_chikungunya, 
                    ~lng, 
                    ~lat, 
                    icon=icons_chikungunya, 
                    label=paste0(pd_chikungunya$country, '. ', 'Chikungunya'),
                    group = 'Chikungunya') %>%
    addAwesomeMarkers(data = pd_dengue, 
                    ~lng, 
                    ~lat, 
                    icon=icons_dengue, 
                    label=paste0(pd_dengue$country, '. ', 'Dengue'),
                    group = 'Dengue') %>%
      addAwesomeMarkers(data = pd_yellow_fever, 
                    ~lng, 
                    ~lat, 
                    icon=icons_yellow_fever, 
                    label=paste0(pd_yellow_fever$country, '. ', 'Yellow fever'),
                    group = 'Yellow fever') %>%
      addAwesomeMarkers(data = pd_zika, 
                    ~lng, 
                    ~lat, 
                    icon=icons_zika, 
                    label=paste0(pd_zika$country, '. ', 'Zika'),
                    group = 'Zika') %>%

  addLayersControl(
    baseGroups = c("OSM (default)", "Toner", "Toner Lite"),
    overlayGroups = c("Chikungunya", "Dengue", "Yellow fever", "Zika"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%    addFullscreenControl()
htmltools::save_html(l, file = '~/Documents/databrew.github.io/whoarb2/index.html')

  
```

```{r, eval = FALSE}
# Get data for each disease
pd <- df[,c('1. State', names(df)[grepl('Which arboviruses have circulated in your country at any', names(df), fixed = TRUE)])]
names(pd) <- c('country', 'Chikungunya', 'Dengue', 'Yellow fever', 'Zika', 'Other')
pd$Other <- NULL
# Simplify values
for(j in 2:ncol(pd)){
  vals <- pd[,j]
  vals <- as.character(vals)
  out_vals <- ifelse(is.na(vals), 'No', ifelse(vals == 'Yes', 'Yes', 'No'))
  pd[,j] <- out_vals
}
# Get total number of viruses
pd$total <- apply(pd[,2:5], 1, function(x){sum(ifelse(x == 'Yes', 1, 0))})
# Clean up a bit
pd <- pd %>%
  filter(!is.na(country)) %>%
  filter(country != 'Iceland') %>%
  filter(!duplicated(country)) %>%
  mutate(value = total)
joined <- world_shp
joined@data <- left_join(joined@data, pd)
disease_names <- names(pd)[2:5]
for(j in 1:length(disease_names)){
  this_disease_name <- disease_names[j]
  vals <- joined@data[,this_disease_name]
  vals <- ifelse(is.na(vals), 'No', vals)
  joined@data[,this_disease_name] <- vals
}
coords <- coordinates(joined)
joined <- joined@data
joined$lng <- coords[,1]; joined$lat <- coords[,2]
jitter_factor <- 1.5
pd_chikungunya <- joined[joined$Chikungunya == 'Yes',] #%>% mutate(lng = jitter(lng, factor = jitter_factor), lat = jitter(lat, factor = jitter_factor))
pd_dengue <- joined[joined$Dengue == 'Yes',] %>% mutate(lng = lng + jitter_factor, lat = lat + 0) #  mutate(lng = jitter(lng, factor = jitter_factor), lat = jitter(lat, factor = jitter_factor))
pd_yellow_fever <- joined[joined$`Yellow fever` == 'Yes',] %>% mutate(lng = lng - jitter_factor, lat = lat + jitter_factor)  #mutate(lng = jitter(lng, factor = jitter_factor), lat = jitter(lat, factor = jitter_factor))
pd_zika <- joined[joined$Zika == 'Yes',] %>% mutate(lng = lng + jitter_factor, lat = lat - jitter_factor)#mutate(lng = jitter(lng, factor = jitter_factor), lat = jitter(lat, factor = jitter_factor))

pd_virus <-
  bind_rows(
    pd_chikungunya %>% mutate(Virus = 'Chikungunya'),
    pd_dengue %>% mutate(Virus = 'Dengue')
  ) %>%
  bind_rows(
    pd_yellow_fever %>% mutate(Virus = 'Yellow fever')
  ) %>%
  bind_rows(
    pd_zika %>% mutate(Virus = 'Zika')
  )

# Region level maps
# For each region, make a map
library(ggthemes)
regions <- sort(unique(who_shp$adm0$who_region))
for(i in 1:length(regions)){
  r <- regions[i]
  l <- make_map(df = pd,
         pal = 'Spectral',
         qualitative = TRUE,
         add_base_layer = FALSE,
         label_string = 'Number of arboviruses',
         legend_title = 'Number of\narboviruses',
         use_who_shp = TRUE,
         filter_region = r,
         static = TRUE,
         remove_some = FALSE) +
    labs(title = r,
         subtitle = 'Arboviruses by country') + 
    theme_map() +
    scale_fill_gradient2(name = 'Number of virus',
                        low = 'black', high = 'red') +
    # theme(legend.position = 'none') +
    geom_point(data = pd_virus %>% filter(region == r),
               aes(x = lng, y = lat, color = Virus), group = NA, size = 4, alpha = 0.6) +
    scale_color_manual(name = 'Virus',
                       values = c('blue', 'darkgreen', 'purple', 'yellow')) +
    theme(legend.position = 'bottom')
  if(r == 'EURO')
    l <- l + xlim(-25, 44)
  l
  if(r == 'WPRO')
    l <- l + xlim(70, 180)
  l
  ggsave(paste0('~/Desktop/who/viruses_', r, '.png'),
         width = 8,
         height = 6)
}
```



```{r, eval = FALSE}
# Responses by country with Africa filled in
pd <- df[grepl('1. State', names(df))]
names(pd) <- c('country')
pd <- pd %>% filter(!duplicated(country))
pd$value <- 'Responded'
pd2 <- world_shp@data %>%
  filter(REGION == 2) %>%
  dplyr::select(country) %>%
  mutate(value = 'Responded')
pd <- bind_rows(pd, pd2)

l <- make_map(df = pd,
        pal = 'Dark2',
         qualitative = TRUE,
         provider = providers$OpenStreetMap, 
        use_who_shp = TRUE)
l
htmltools::save_html(l, file = '~/Documents/databrew.github.io/whoarb3/index.html')
```


# Surveillance capacity indicators

### Reportable arboviral diseases

##### 11. Is reporting mandatory for any arboviral disease cases in your country?

```{r}
pd <- df[grepl('11. |1. State', names(df))]
names(pd) <- c('country', 'value')
make_map(df = pd,
         qualitative = TRUE)
```

##### 11b. For which of the following arboviral disease cases is reporting mandatory in your country: Chikungunya

```{r}
# names(df)[grepl('11b', names(df))]
pd <- df[,(grepl('11b.', names(df)) & grepl('Chik', names(df))) | grepl('1. State', names(df))]
names(pd) <- c('country', 'value')
make_map(df = pd,
         qualitative = TRUE)
```


##### 11b. For which of the following arboviral disease cases is reporting mandatory in your country: Dengue

```{r}
# names(df)[grepl('11b', names(df))]
pd <- df[,(grepl('11b.', names(df)) & grepl('Dengue', names(df))) | grepl('1. State', names(df))]
names(pd) <- c('country', 'value')
make_map(df = pd,
         qualitative = TRUE)
```


##### 11b. For which of the following arboviral disease cases is reporting mandatory in your country: Yellow fever

```{r}
# names(df)[grepl('11b', names(df))]
pd <- df[,(grepl('11b.', names(df)) & grepl('Yellow', names(df))) | grepl('1. State', names(df))]
names(pd) <- c('country', 'value')
make_map(df = pd,
         qualitative = TRUE)
```


##### 11b. For which of the following arboviral disease cases is reporting mandatory in your country: Zika (Non-congenital)

```{r}
# names(df)[grepl('11b', names(df))]
pd <- df[,(grepl('11b.', names(df)) & grepl('Zika', names(df))) | grepl('1. State', names(df))]
pd <- pd[,1:2]
names(pd) <- c('country', 'value')
make_map(df = pd,
         qualitative = TRUE)
```

##### 11b. For which of the following arboviral disease cases is reporting mandatory in your country: Zika (Congenital)

```{r}
# names(df)[grepl('11b', names(df))]
pd <- df[,(grepl('11b.', names(df)) & grepl('Zika', names(df))) | grepl('1. State', names(df))]
pd <- pd[,c(1,3)]
names(pd) <- c('country', 'value')
make_map(df = pd,
         qualitative = TRUE)
```


##### 11b. For which of the following arboviral disease cases is reporting mandatory in your country: Other

```{r}
# names(df)[grepl('11b', names(df))]
pd <- df[,(grepl('11b.', names(df)) & grepl('Other', names(df))) | grepl('1. State', names(df))]
names(pd) <- c('country', 'value')
make_map(df = pd,
         qualitative = TRUE)
```


### History of any arbovirus circulation since 2000 

(q5)


### Conducting surveillance on humans

(q12)

### Conducting surveillance on vectors 

(q28) 


### Conducting surveillance on animals 

(q41)

### Training of surveillance personnel and clinicians

(q10) (q24)

### Presence written arbovirus surveillance and control plans

(q6)

### Arbovirus program independent or integrated

(q7)

### Tools for case reporting 

(q9)

# Laboratory diagnostic indicators


### Testing in outbreak vs non-outbreak settings 

(q15)

### Laboratory tests available 

(q17)

### Serotyping and sequencing capacity? 

(q19)


# Response capacity indicators

### Surveillance and control plans available 

(q 6)

### Clinical guidelines for healthcare workers 

(q21)


### Vector control method employed (q35)


### Surveillance and response committee exists (q47)


### Contingency plan exists (q48)


### Most common vector control methods used 

(q35)


### Indicators used for thresholds 

(q37, 37b, 38)


### Insecticide resistance

(q39)

### Criteria for declaring an outbreak

(q49)


# Epidemiological risk data


### Vectors present and level of risk 

(q34, q34b, q34c)

### Entomological surveillance in the last 2 years

(q28)


### How often is conducted

(q28e)


### Vectors recorded in the last 5 years  and the public health threat 

(q34)
(34b, 34c)


### All arboviruses 2015-2020 (cases and deaths) 

(q55, b, c)


### Most recent year data 

(q56)

