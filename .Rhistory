df <- data.frame( Country=character(), Virus=character(), Type=character(), Number=numeric() )
for( i in 1:ncountries ){
country <- rep( data$SI01[i], ncr)
df <- rbind( df,
data.frame(Country=country,
Virus=col_names[,1],
Type=col_names[,2],
Number=as.numeric( t( responses[i,] ))))
}
df <- df %>% drop_na(Number)
ggplot( df,
aes( x=reorder(Country, desc(Country)), y=Number, fill=Type)) +
geom_col( position="dodge" ) +
coord_flip() +
labs( title = "Cases by Virus") +
facet_wrap(~Virus) +
labs(x = 'Country') +
scale_fill_manual(name = '',
values = make_colors(length(unique(df$Type))))
setwd("databrew/arbovirus/")
# Chunk 1: setup
# Basic knitr options
library(knitr)
opts_chunk$set(comment = NA,
echo = FALSE,
warning = FALSE,
message = FALSE,
error = TRUE,
cache = FALSE,
fig.width = 9.64,
fig.height = 5.9,
fig.path = 'figures/')
options(scipen = '999')
# Chunk 2
library(tidyverse)
library(readxl)
library(flextable)
library(stringr)
library(pander)
library(RColorBrewer)
make_colors <- function(n, seed = 123){
pal <- RColorBrewer::brewer.pal(n = 9, name = 'Set1')
set.seed(seed)
pal <- sample(pal, length(pal))
out <- colorRampPalette(pal)(n)
return(out)
}
ggplot2::theme_set(theme_bw())
# get the survey results: processed by WHO script (lightly edited),
# then WHO regions added
if( file.exists("data/data.RData" )){
load("data/data.RData")
} else{
source("misc/survey_375147_R_syntax_file.R")
n_countries <- length( data$SI01 )
who_regions <- read_excel("data/Regions_Countries.xlsx")
region <- character( length=n_countries )
for(i in 1:n_countries){
idx <- which( who_regions$Country == data$SI01[i] )
if( length(idx) > 0 ){
region[i] <- who_regions$Region[idx]
} else{
region[i] <- NA
}
}
data <- data %>% mutate( Region = factor(region), .after=SI01 )
save(data, file="data/data.RData")
}
# load data dictionary to facilitate processing survey results:
dict <- read_csv("misc/Data_dictionary_Survey375147.csv")
# utility function
get_responses <- function( question_number ){
idx <- which( dict$`Question number` == question_number )
# question <- dict$Description[ idx[1] ]
# cat( paste("Question", question_number, ":", question) )
var_names <- dict$`Variable name`[idx]
responses <- data %>% select( all_of(var_names) )
if( !is.na(dict$Subquestion[ idx[1] ]) ){
# remove square brackets at beginning and end, then rename:
colnames( responses ) <- str_extract( dict$Subquestion[idx], '(?<=\\[)[^{}]+(?=\\])')
# replace square brackets with spaces, then trim whitespace:
# colnames( responses ) <- trimws( gsub("\\[|\\]", " ",dict$Subquestion[idx]), which="both")
} else{
colnames( responses ) <- "Response"
}
return( responses )
}
# Chunk 3
idx <- which( duplicated( data$SI01 ) )
pander( as.vector(unique( data$SI01[idx] ) ) )
# Chunk 4
pd <- data %>%
group_by(Country = SI01) %>%
tally %>%
arrange(desc(n)) %>%
filter(n >= 2) %>%
bind_rows(
tibble(Country = 'Others',
n = 1)
)
pd$Country <- factor(pd$Country,
levels = pd$Country)
ggplot(data = pd,
aes(x = Country,
y = n)) +
geom_bar(stat = 'identity') +
geom_text(aes(label = n),
nudge_y = -0.2,
color = 'white',
size = 7) +
labs(y = 'Entries',
title = 'Survey entries per country')
# Chunk 5
# relevant question: q11
responses <- get_responses("11")
df <- data.frame(Region = data$Region, Response = responses) %>%
drop_na(Region) %>%
group_by(Region, Response) %>%
tally %>%
pivot_wider(names_from=Response, values_from=n)
regulartable( df ) %>%
colformat_num( na_str="-" )
# pander( table( df %>% group_by(Region), useNA="ifany" ) )
# Chunk 6
# relevant question: q11b
responses <- get_responses("11b")
responses <- cbind( Region = data$Region, responses)
df <- responses %>%
pivot_longer(!Region, names_to="Arbovirus", values_to="Response") %>%
group_by(Region, Arbovirus, Response) %>%
tally
tab <- df %>%
pivot_wider( names_from=Response, values_from=n) %>%
drop_na(Region)
colnames(tab) <- str_to_sentence( gsub( "Mandatory reporting of ", "", colnames(tab) ) )
tab <- tab %>%
relocate("Confirmed cases only", .after="All suspect cases") %>%
rename("No answer"=Na)
tab %>%
regulartable %>%
merge_v(j = ~Region) %>%
valign(j = 1, valign = "top", part = "all") %>%
hline(i=6*(1:4)) %>%
colformat_num( na_str = "-" ) %>%
fix_border_issues() # %>%
# autofit()
ggplot(df, aes(x=Response, y=n, fill=Response)) +
geom_col() +
facet_wrap(~Arbovirus) +
theme(legend.position = "bottom",
legend.direction="horizontal",
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank()) +
guides(fill=guide_legend(ncol=2)) +
scale_fill_manual(name = '',
values = make_colors(length(unique(df$Response)))) +
labs(y = 'Responses')
# Chunk 7
# relevant question: q5
responses <- get_responses("5")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
df <- responses %>%
pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response")
pander( table( df$Arbovirus, df$Response, useNA="ifany") )
# knitr::kable( table(other))
ggplot(data = df %>% filter(Response == 'Yes'),
aes(x = Arbovirus)) +
geom_bar() +
labs(y = 'Entries')
# Chunk 8
# relevant question: q12 (surveillance on humans)
responses <- get_responses("12")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
pander( table( df %>% group_by(Region), useNA="ifany" ) )
# pander( table(responses, useNA="ifany"))
# Chunk 9
# relevant question: q28 (surveillance on vectors)
responses <- get_responses("28")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
pander( table( df %>% group_by(Region), useNA="ifany" ) )
# pander( table(responses, useNA="ifany"))
# Chunk 10
# relevant question: q41 (surveillance on animals)
responses <- get_responses("41")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
pander( table( df %>% group_by(Region), useNA="ifany" ) )
# pander( table(responses, useNA="ifany"))
# Chunk 11
# relevant question: q10
responses <- get_responses("10")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
df <- responses %>%
pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response")
knitr::kable( table( df$Arbovirus, df$Response, useNA="ifany") )
# Chunk 12
# relevant question: q24
responses <- get_responses("24")
colnames(responses) <- c("Selection", "Comments")
knitr::kable( table(responses$Selection, useNA="ifany"))
# knitr::kable( table(responses$Comments, useNA="ifany"))
# Chunk 13
# relevant question: q15
responses <- get_responses("15")
df <- responses %>%
pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response")
knitr::kable( table( df$Arbovirus, df$Response, useNA="ifany") )
# Chunk 14
# relevant question: q17
responses <- get_responses("17")
df <- responses %>%
pivot_longer(cols=colnames(responses), names_to="Testing", values_to="Response")
new_cols <- matrix( unlist( strsplit(df$Testing, "\\]\\[") ), ncol=2, byrow=T)
df <- df %>%
mutate(Arbovirus = new_cols[,1], Testing = new_cols[,2])
df$Response <- as.numeric( df$Response)
df <- df %>%
group_by(Arbovirus, Testing) %>%
summarize(Total = sum(Response, na.rm=T))
df$Arbovirus <- factor( df$Arbovirus )
df$Testing <- factor( df$Testing )
mat <- matrix( data=df$Total, ncol=length(levels(df$Arbovirus)), byrow=F)
colnames( mat ) <- levels( df$Arbovirus )
rownames( mat ) <- levels( df$Testing )
knitr::kable( mat )
ggplot(df, aes(x=Testing, y=Total, fill=Testing)) +
geom_col() +
facet_wrap(~Arbovirus) +
theme(legend.position = "bottom",
legend.direction="horizontal",
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank()) +
scale_fill_manual(name = '',
values = make_colors(length(unique(df$Testing))))
# Chunk 15
# relevant question: q6
responses <- get_responses("6")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
knitr::kable( table( df %>% group_by(Region), useNA="ifany" ) )
# knitr::kable( table(responses, useNA="ifany"))
# Chunk 16
# relevant question: q35
responses <- get_responses("35")
other <- responses %>% select(Other)
df <- responses %>%
select(-Other) %>%
pivot_longer(cols=colnames(responses)[1:5], names_to="Method", values_to="Response")
knitr::kable( table(df$Method, df$Response, useNA="ifany"))
# Chunk 17
# relevant question: q47
responses <- get_responses("47")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
pander( table( df %>% group_by(Region), useNA="ifany" ) )
# pander( table(responses, useNA="ifany"))
# Chunk 18
# relevant question: q48
responses <- get_responses("48")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
pander( table( df %>% group_by(Region), useNA="ifany" ) )
# pander( table(responses, useNA="ifany"))
# Chunk 19
# relevant question: q34
responses <- get_responses("34")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
knitr::kable( table( df %>% group_by(Region), useNA="ifany" ) )
# knitr::kable( table(responses, useNA="ifany"))
# Chunk 20
# relevant question: q34b
responses <- get_responses("34b")
colnames(responses) <- c("Selection", "Other")
knitr::kable( table(responses$Selection, useNA="ifany"))
knitr::kable( table(responses$Other, useNA="ifany"))
# Chunk 21
# relevant question: q34c
responses <- get_responses("34c")
colnames(responses) <- c("Selection", "Other")
knitr::kable( table(responses$Selection, useNA="ifany"))
knitr::kable( table(responses$Other, useNA="ifany"))
# Chunk 22
# relevant question: q55
responses <- get_responses("55")
col_names <- colnames(responses)
col_names <- matrix( unlist( strsplit(col_names, "\\]\\[") ), ncol=2, byrow=T)
col_names <- cbind( col_names[,1], matrix( unlist( strsplit(col_names[,2], " ") ), ncol=2, byrow=T))
ncountries <- length(data$SI01)
ncr <- ncol(responses)
df <- data.frame( Country=character(), Virus=character(), Year=character(), Type=character(), Number=numeric() )
for( i in 1:ncountries ){
country <- rep( data$SI01[i], ncr)
df <- rbind( df,
data.frame(Country=country,
Virus=col_names[,1],
Year=col_names[,2],
Type=col_names[,3],
Number=as.numeric( t( responses[i,] ))))
}
df <- df %>% drop_na(Number)
ggplot( df %>%
filter(Country!="India") %>%
filter(Type=="Cases") %>%
mutate(Country = gsub(" People's Democratic Republic", 's', Country)) %>%
mutate(Country = gsub('Herzegovina', 'Herz.', Country)) %>%
mutate(grp = paste0(Country, Virus)),
aes(x = Year,
y = Number,
color = Virus,
group = grp)) +
geom_line() +
geom_point() +
facet_wrap(~Country,
scales = 'free') +
theme(legend.position = 'bottom',
strip.background = element_blank()) +
scale_color_manual(name = '',
values = make_colors(length(unique(df$Virus)))) +
theme(axis.text.x = element_text(angle = 90,
hjust = 0,
vjust = 0.5)) +
labs(title = 'Cases by year',
y = 'Cases')
# Chunk 23
ggplot( df %>%
filter(Country!="India") %>%
filter(Type=="Deaths") %>%
mutate(Country = gsub(" People's Democratic Republic", 's', Country)) %>%
mutate(Country = gsub('Herzegovina', 'Herz.', Country)) %>%
mutate(grp = paste0(Country, Virus)),
aes(x = Year,
y = Number,
color = Virus,
group = grp)) +
geom_line() +
geom_point() +
facet_wrap(~Country,
scales = 'free') +
theme(legend.position = 'bottom',
strip.background = element_blank()) +
scale_color_manual(name = '',
values = make_colors(length(unique(df$Virus)))) +
theme(axis.text.x = element_text(angle = 90,
hjust = 0,
vjust = 0.5)) +
labs(title = 'Deaths by year',
y = 'Deaths')
# Chunk 24
# relevant question: q55b
responses <- get_responses("55b")
df <- data.frame(Region = data$Region, Response = responses) %>% drop_na(Region)
pander( table( df %>% group_by(Region), useNA="ifany" ) )
# pander( table(responses, useNA="ifany"))
# Chunk 25
# relevant question: q55c
responses <- get_responses("55c")
df <- responses %>%
pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response") %>%
filter(Response=="Yes") %>%
droplevels()
pander( table( df$Arbovirus, df$Response, useNA="ifany") )
# Chunk 26
# relevant question: q56
responses <- get_responses("56")
col_names <- colnames(responses)
col_names <- matrix( unlist( strsplit(col_names, "\\]\\[") ), ncol=2, byrow=T)
ncountries <- length(data$SI01)
ncr <- ncol(responses)
df <- data.frame( Country=character(), Virus=character(), Type=character(), Number=numeric() )
for( i in 1:ncountries ){
country <- rep( data$SI01[i], ncr)
df <- rbind( df,
data.frame(Country=country,
Virus=col_names[,1],
Type=col_names[,2],
Number=as.numeric( t( responses[i,] ))))
}
df <- df %>% drop_na(Number)
ggplot( df,
aes( x=reorder(Country, desc(Country)), y=Number, fill=Type)) +
geom_col( position="dodge" ) +
coord_flip() +
labs( title = "Cases by Virus") +
facet_wrap(~Virus) +
labs(x = 'Country') +
scale_fill_manual(name = '',
values = make_colors(length(unique(df$Type))))
responses <- get_responses("5")
View(responses)
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
df <- responses %>%
pivot_longer(cols=colnames(responses), names_to="Arbovirus", values_to="Response")
View(df)
responses <- get_responses("5")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
responses <- cbind( Region = data$Region, responses)
df <- responses %>%
pivot_longer(!Region, names_to="Arbovirus", values_to="Response") %>%
group_by(Region, Arbovirus, Response) %>%
tally
tab <- df %>%
pivot_wider( names_from=Response, values_from=n) %>%
drop_na(Region)
VieW(tab)
View(tab)
responses <- get_responses("5")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
responses <- cbind( Region = data$Region, responses)
df <- responses %>%
pivot_longer(!Region, names_to="Arbovirus", values_to="Response") %>%
group_by(Region, Arbovirus, Response) %>%
tally
df %>%
pivot_wider( names_from=Response, values_from=n) %>%
drop_na(Region) %>%
regulartable %>%
merge_v(j = ~Region) %>%
valign(j = 1, valign = "top", part = "all") %>%
hline(i=6*(1:4)) %>%
colformat_num( na_str = "-" ) %>%
fix_border_issues()
responses <- get_responses("5")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
responses <- cbind( Region = data$Region, responses)
df <- responses %>%
pivot_longer(!Region, names_to="Arbovirus", values_to="Response") %>%
group_by(Region, Arbovirus, Response) %>%
tally
responses <- get_responses("10")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
df <- cbind( Region = data$Region, responses) %>%
pivot_longer(!Region, names_to="Arbovirus", values_to="Response") %>%
group_by(Region, Arbovirus, Response) %>%
tally
responses <- get_responses("10")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
df <- cbind( Region = data$Region, responses) %>%
pivot_longer(!Region, names_to="Training", values_to="Response") %>%
group_by(Region, Arbovirus, Response) %>%
tally
responses <- get_responses("10")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
df <- cbind( Region = data$Region, responses) %>%
pivot_longer(!Region, names_to="Training", values_to="Response")
View(df <- cbind( Region = data$Region, responses) %>%
pivot_longer(!Region, names_to="Training", values_to="Response"))
responses <- get_responses("10")
other <- responses %>% select(Other)
responses <- responses %>% select(-Other)
df <- cbind( Region = data$Region, responses) %>%
pivot_longer(!Region, names_to="Training", values_to="Response") %>%
group_by(Region, Training, Response) %>%
tally
View(df %>%
pivot_wider( names_from=Response, values_from=n) %>%
drop_na(Region))
View(df %>% pivot_wider( names_from=Response, values_from=n) %>% drop_na(Region) %>% pivot_wider(names_from=Region))
View(df %>%
pivot_wider( names_from=Response, values_from=n) %>%
drop_na(Region))
?reshape
temp <- df %>% pivot_wider( names_from=Response, values_from=n) %>% drop_na(Region)
reshape( temp, timevar=Region)
reshape( temp, timevar=Region, direction="wide")
temp
reshape( temp, timevar="Region", direction="wide")
reshape( temp, idvar="Region", direction="wide")
reshape( temp, idvar="Region", timevar="Trainingdirection="wide")
reshape( temp, idvar="Region", timevar="Training",direction="wide")
View( reshape( temp, idvar="Region", timevar="Training",direction="wide") )
View(reshape( df, idvar=Training, timevar=Response))
View(reshape( df, idvar=Training, timevar=Response, direction="wide"))
View(reshape( df, idvar="Training", timevar="Response", direction="wide"))
temp
levels( temp$Trainin)
levels( temp$Training)
unique( temp$Training)
responses <- get_responses("24")
colnames(responses) <- c("Selection", "Comments")
responses <- get_responses("24")
colnames(responses) <- c("Selection", "Comments")
responses <- get_responses("24")
colnames(responses) <- c("Responses", "Comments")
comments <- responses %>% select(Comments)
responses <- responses %>% select(Responses)
df <- data.frame(Region = data$Region, Response = responses) %>%
drop_na(Region) %>%
group_by(Region, Response) %>%
tally %>%
pivot_wider(names_from=Response, values_from=n)
df <- data.frame(Region = data$Region, Response = responses)
df <- data.frame(Region = data$Region, Response = responses) %>%
drop_na(Region) %>%
group_by(Region, Response)
responses <- get_responses("24")
colnames(responses) <- c("Response", "Comments")
comments <- responses %>% select(Comments)
responses <- responses %>% select(Response)
df <- data.frame(Region = data$Region, Response = responses) %>%
drop_na(Region) %>%
group_by(Region, Response) %>%
tally %>%
pivot_wider(names_from=Response, values_from=n)
regulartable( df ) %>%
colformat_num( na_str="-" )
